@page "/elencolavoratori"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using System.Text
@using System.Text.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService

<AuthorizeView>
    <Authorized>
        <h3>Lavoratori</h3>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Style="color:#E53935;" @onclick="OpenDialogAsync">
            Nuovo Lavoratore
        </MudButton>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Download" Style="color:#4CAF50; margin-left:16px;" @onclick="ExportToExcel">
            Esporta in Excel
        </MudButton>

        <!-- Icona per mostrare/nascondere i filtri -->
        <MudIconButton Icon="@Icons.Material.Filled.FilterAlt" Color="Color.Primary" OnClick="ToggleFilters" Class="mt-4" Style="color: #E53935; margin-bottom: 12px;" />

        <!-- Sezione Filtri, visibile solo se showFilters è true -->
        @if (showFilters)
        {
            <div class="folder-container compact">
                <div class="folder-tab">Filtri</div>
                <MudGrid GutterSize="8">
                    <MudItem xs="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">
                            Nome o Cognome
                        </MudText>
                        <MudTextField @bind-Value="searchString"
                                      Placeholder="Cerca Lavoratore per Nome o Cognome"
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      Class="white-input"
                                      Style="margin-top: 6px;" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">
                            Codice Fiscale
                        </MudText>
                        <MudTextField @bind-Value="searchCodiceFiscale"
                                      Placeholder="Cerca per Codice Fiscale"
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      Class="white-input"
                                      Style="margin-top: 6px;" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">
                            In Forza
                        </MudText>
                        <MudSelect T="string" @bind-Value="inForzaFilter"
                                   Label="Seleziona"
                                   Variant="Variant.Outlined"
                                   Class="white-input"
                                   Immediate="true"
                                   Style="margin-top: 6px;">
                            <MudSelectItem Value="@("all")">Tutti</MudSelectItem>
                            <MudSelectItem Value="@("true")">Sì</MudSelectItem>
                            <MudSelectItem Value="@("false")">No</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </div>
        }



        @if (lavoratori != null)
        {
            <div class="folder-container">
                <div class="folder-tab">Elenco Lavoratori</div>
                <MudTable Items="lavoratori.value" Dense="true" HeaderClass="mud-table-header" Hover="true" Filter="FilterFunc">
                    <HeaderContent>
                        <MudTh>
                            <MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Lavoratori, object>(x => x.cr4f9_cognome)">
                                Cognome
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>
                            <MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Lavoratori, object>(x => x.cr4f9_nome)">
                                Nome
                            </MudTableSortLabel>
                        </MudTh>
                        <MudTh>Codice Fiscale</MudTh>
                        <MudTh>In Forza</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="lavoratore">
                        <MudTd>
                            <MudLink Href="@($"/dettagliolavoratore/id={lavoratore.cr4f9_contattoprvid}")">
                                @lavoratore.cr4f9_cognome
                            </MudLink>
                        </MudTd>
                        <MudTd DataLabel="nome">@lavoratore.cr4f9_nome</MudTd>
                        <MudTd DataLabel="codiceFiscale">@lavoratore.cr4f9_codicefiscale</MudTd>
                        <MudTd DataLabel="inForza">
                            @(lavoratore.inForza ? "Sì" : "No")
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                    </PagerContent>
                </MudTable>
            </div>
        }
        else
        {
            <p><em>@message</em></p>
        }
    </Authorized>
    <NotAuthorized>
        <h3>Authentication Failure!</h3>
        <p>You're not signed in.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private LavoratoriCollection lavoratori;
    private string message = "Loading...";

    private string userName;
    private string userEmail;
    private Guid? azienda;
    private string clienteId;

    private string fetchXmlQuery;

    private string searchString;
    private string searchCodiceFiscale;

    private string inForzaFilter = "all";

    private bool showFilters = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation();

        // Costruisci dinamicamente la query FetchXML, assegnando un alias a cr4f9_inforza
        fetchXmlQuery = $@"
        <fetch>
          <entity name='cr4f9_contattoprv'>
            <attribute name='cr4f9_cognome'/>
            <attribute name='cr4f9_nome'/>
            <attribute name='cr4f9_codicefiscale'/>
            <link-entity name='new_lavorapressoprv' from='new_lavoratore' to='cr4f9_contattoprvid' link-type='inner' alias='Lavoratore'>
              <attribute name='cr4f9_inforza' alias='inForza' />
              <filter>
                <condition attribute='new_azienda' operator='eq' value='{azienda}' />
              </filter>
            </link-entity>
          </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                // Log per verificare il contenuto della risposta
                var responseBody = await response.Content.ReadAsStringAsync();
                logger.LogInformation("RESPONSE BODY: " + responseBody);

                lavoratori = JsonSerializer.Deserialize<LavoratoriCollection>(responseBody, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni dell'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;
            logger.LogInformation("USER EMAIL: " + userEmail);
        }
        await CaricaClienteAssociato(userEmail);
    }

    private Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        return DialogService.ShowAsync<AddLavoratore>("Simple Dialog", options);
    }

    [Inject] IJSRuntime JS { get; set; }

    private async Task ExportToExcel()
    {
        if (lavoratori == null || lavoratori.value.Length == 0)
        {
            message = "Nessun dato da esportare.";
            return;
        }

        var jsonData = lavoratori.value.Select(l => new
        {
            Cognome = l.cr4f9_cognome,
            Nome = l.cr4f9_nome,
            CodiceFiscale = l.cr4f9_codicefiscale,
            InForza = l.inForza ? "Sì" : "No"
        });

        await JS.InvokeVoidAsync("downloadExcelFromBlazor", "Lavoratori.xlsx", jsonData);
    }

    // Funzione di filtro applicata ad ogni riga della tabella
    private bool FilterFunc(Lavoratori lavoratore)
    {
        // Filtro per nome e cognome
        if (!string.IsNullOrWhiteSpace(searchString))
        {
            var searchLower = searchString.ToLower();
            if (!(lavoratore.cr4f9_cognome?.ToLower().Contains(searchLower) == true ||
                  lavoratore.cr4f9_nome?.ToLower().Contains(searchLower) == true))
                return false;
        }

        if (!string.IsNullOrWhiteSpace(searchCodiceFiscale))
        {
            var codiceLower = searchCodiceFiscale.ToLower();
            if (!(lavoratore.cr4f9_codicefiscale?.ToLower().Contains(codiceLower) == true))
                return false;
        }

        // Filtro per inForza
        if (inForzaFilter != "all")
        {
            bool filterVal = inForzaFilter == "true";
            if (lavoratore.inForza != filterVal)
                return false;
        }
        return true;
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new JsonSerializerOptions
                            {
                                WriteIndented = true
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private string BuildFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    public class Lavoratori
    {
        public Guid cr4f9_contattoprvid { get; set; }
        public string cr4f9_cognome { get; set; }
        public string cr4f9_nome { get; set; }
        public string cr4f9_codicefiscale { get; set; }

        // Il campo viene deserializzato dall'alias "inForza" definito nella query FetchXML
        [JsonPropertyName("inForza")]
        public bool inForza { get; set; }
    }

    public class LavoratoriCollection
    {
        public Lavoratori[] value { get; set; }
    }
}


<style>

    /* Contenitore principale della tabella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px;
    }

    .filter-section {
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
    }

    .white-input input,
    .white-input .mud-input-slot {
        background-color: #ffffff !important;
    }

    .folder-tab {
        position: absolute;
        top: -25px;
        left: 20px;
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
    }

    /* Tabella principale */
    .mud-table {
        width: 100%; /* Assicurati che la tabella occupi tutta la larghezza disponibile */
        border-radius: 8px;
        border-collapse: collapse; /* Per una gestione più uniforme dei bordi */
    }

    /* Tabella intestazione */
    .mud-table-header {
        background-color: #E53935;
    }

    .mud-table-header .mud-table-cell {
        color: white !important;
        font-weight: bold; /* Grassetto per l'intestazione */
    }

    /* Righe della tabella */
    .mud-table-row {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le righe */
    }

    /* Celle della tabella (MudTd) */
    .mud-table .mud-td, .mud-table .mud-th {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le celle */
        padding: 8px; /* Padding per le celle */
        vertical-align: middle; /* Allinea verticalmente il contenuto */
        text-align: center; /* Centra il testo */
    }

    /* Colore dei link nella tabella */
    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: left;
        margin-left: 16px;
        vertical-align: central;
        margin-top: 8px;
    }

    /* Hover sui link */
    .mud-table .mud-link.mud-typography.mud-primary-text:hover {
        color: red !important;
        cursor: pointer;
    }

    /* Contenitore della tabella */
    .folder-tab {
        position: absolute;
        top: -25px;
        left: 20px;
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
    }

    /* Nascondi informazioni di paginazione */
    .mud-table-pagination-information {
        display: none;
    }

</style>

