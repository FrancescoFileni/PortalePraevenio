@page "/dettagliolavoratore/id={id}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.Extensions.Logging
@using MudBlazor
@using System.Net.Http.Headers
@using System.Net.Http.Json

@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IDialogService DialogService

<link href="css/dettaglio-lavoratore.css" rel="stylesheet" />

@if (contatti?.value?.Length > 0)
{
	<MudPaper Class="toolbar" Elevation="1">
		<div class="toolbar-left">
			<MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
						   Color="Color.Error"
						   Class="back-btn"
						   OnClick="GoBack" />
			<MudText Typo="Typo.h5" Class="page-title">
				@contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
			</MudText>
		</div>
	</MudPaper>

	<MudTabs SliderColor="Color.Secondary" Elevation="2" Rounded="true" Class="my-6">

		<MudTabPanel Icon="@Icons.Material.Filled.Person" Text="Anagrafica">
			<div class="folder-container">
				<div class="folder-tab">
					Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
				</div>

				<div class="details-shell">
					<div class="details-grid">
						<div class="detail-card">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_codicefiscale"
										  Label="Codice Fiscale"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>

						<div class="detail-card">
							<MudDatePicker @bind-Date="SelectedDate"
										   Label="Data di nascita"
										   Format="dd/MM/yyyy"
										   Variant="Variant.Outlined"
										   Disabled="@(!editMode)" />
						</div>

						<div class="detail-card">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_luogodinascita"
										  Label="Luogo di nascita"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>

						<div class="detail-card">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_provinciadinascita"
										  Label="Provincia di nascita"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>

						<div class="detail-card">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_nazionalita"
										  Label="Nazionalità"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>

						<div class="detail-card">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_telefonoprincipale"
										  Label="Telefono principale"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>

						<div class="detail-card span-2">
							<MudTextField @bind-Value="@contatti.value[0].cr4f9_emailprincipale"
										  Label="Email principale"
										  Variant="Variant.Outlined"
										  Disabled="@(!editMode)" />
						</div>
					</div>

					<div class="details-actions">
						<MudButton Variant="Variant.Filled"
								   Color="Color.Error"
								   StartIcon="@(!editMode ? Icons.Material.Filled.Edit : Icons.Material.Filled.Save)"
								   OnClick="ToggleEdit"
								   Class="action-btn">
							@(editMode ? "SALVA MODIFICHE" : "MODIFICA")
						</MudButton>
					</div>
				</div>
			</div>
		</MudTabPanel>

		<MudTabPanel Icon="@Icons.Material.Filled.Place" Text="Mansioni e Sedi">
			<div class="folder-container">
				<div class="folder-tab">
					Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
				</div>

				<div class="table-card">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Mansioni e Sedi</MudText>
						</div>

						<MudButton Variant="Variant.Filled"
								   Color="Color.Error"
								   StartIcon="@Icons.Material.Filled.Add"
								   Class="action-btn"
								   OnClick="OpenDialogAsyncSede">
							Associa Sede a Lavoratore
						</MudButton>
					</div>

					<MudTable Items="mansioni.value"
							  Dense="true"
							  HeaderClass="mud-table-header"
							  Hover="true"
							  Class="pretty-table">
						<HeaderContent>
							<MudTh>
								<MudTableSortLabel InitialDirection="SortDirection.Ascending"
												   SortBy="new Func<Mansione, object>(x => x.sede)">
									Sede
								</MudTableSortLabel>
							</MudTh>
							<MudTh>
								<MudTableSortLabel InitialDirection="SortDirection.Ascending"
												   SortBy="new Func<Mansione, object>(x => x.mansione)">
									Mansione
								</MudTableSortLabel>
							</MudTh>
							<MudTh>
								<MudTableSortLabel InitialDirection="SortDirection.Ascending"
												   SortBy="new Func<Mansione, object>(x => x.cr4f9_inforza)">
									In Forza
								</MudTableSortLabel>
							</MudTh>
						</HeaderContent>

						<RowTemplate Context="mansioni">
							<MudTd DataLabel="Sede">@mansioni.sede</MudTd>
							<MudTd DataLabel="Mansione">@mansioni.mansione</MudTd>
							<MudTd DataLabel="In Forza">@((mansioni.cr4f9_inforza) ? "Sì" : "No")</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>
				</div>
			</div>
		</MudTabPanel>

		<MudTabPanel Icon="@Icons.Material.Filled.School" Text="Corsi sostenuti">
    <div class="folder-container">
        <div class="folder-tab">
            Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
        </div>

        <div class="table-card">
            <div class="table-card-header">
                <div class="table-card-title">
                    <MudText Typo="Typo.h6" Class="mb-0">Partecipazioni a Praevenio</MudText>
                </div>
            </div>

            <MudTable Items="partecipazioni.value"
                      Dense="true"
                      Hover="true"
                      HeaderClass="mud-table-header"
                      Class="pretty-table"
                      Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel InitialDirection="SortDirection.Ascending"
                                           SortBy="new Func<Partecipazione, object>(x => x.cr4f9_corsotipo)">
                            Tipo Corso
                        </MudTableSortLabel>
                    </MudTh>

                    <MudTh>
                        <MudTableSortLabel InitialDirection="SortDirection.Ascending"
                                           SortBy="new Func<Partecipazione, object>(x => x.titolo)">
                            Titolo Corso
                        </MudTableSortLabel>
                    </MudTh>

                    <MudTh Class="text-center">
                        <MudTableSortLabel InitialDirection="SortDirection.Ascending"
                                           SortBy="new Func<Partecipazione, object>(x => x.dataFineCorso)">
                            Data Conclusione
                        </MudTableSortLabel>
                    </MudTh>

                    <MudTh Class="text-center">Superato</MudTh>
                </HeaderContent>

                <RowTemplate Context="p">
                    <MudTd DataLabel="Tipo Corso">
                        <MudLink Href="@($"/dettagliopartecipazione/id={p.new_partecipazionecorsoprvid}")">
                            @p.cr4f9_corsotipo
                        </MudLink>
                    </MudTd>

                    <MudTd DataLabel="Titolo Corso">@p.titolo</MudTd>

                    <MudTd DataLabel="Data Conclusione" Class="text-center">
                        @p.dataFineCorsoString
                    </MudTd>

							<MudTd DataLabel="Superato">@((@p.cr4f9_superato) ? "Sì" : "No")</MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                </PagerContent>
            </MudTable>
        </div>
    </div>
</MudTabPanel>



		<MudTabPanel Icon="@Icons.Material.Filled.WorkOutline" Text="Consegne DPI">
			<div class="folder-container">
				<div class="folder-tab">
					Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
				</div>

				<div class="table-card">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Consegne DPI</MudText>
						</div>
					</div>

					<MudTable Items="consegne.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">
						<HeaderContent>
							<MudTh>
								<MudTableSortLabel InitialDirection="SortDirection.Ascending"
												   SortBy="new Func<Consegna, object>(x => x.cr4f9_idtestata)">
									Id
								</MudTableSortLabel>
							</MudTh>
							<MudTh>
								<MudTableSortLabel InitialDirection="SortDirection.Ascending"
												   SortBy="new Func<Consegna, object>(x => x.cr4f9_dataconsegna)">
									Data Consegna
								</MudTableSortLabel>
							</MudTh>
						</HeaderContent>

						<RowTemplate Context="c">
							<MudTd DataLabel="Id">
								<MudLink Class="table-link-dark"
										 Href="@($"/dettaglioTestataDpi/id={c.cr4f9_testataconsegnaid}")">
									@c.cr4f9_idtestata
								</MudLink>
							</MudTd>
							<MudTd DataLabel="Data Consegna">
								@c.cr4f9_dataconsegna?.ToString("dd/MM/yyyy")
							</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>
				</div>
			</div>
		</MudTabPanel>


		<MudTabPanel Icon="@Icons.Material.Filled.MedicalServices" Text="Visite Mediche">
			<div class="folder-container">
				<div class="folder-tab">
					Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
				</div>

				<div class="table-card">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Visite Mediche</MudText>
						</div>
					</div>

					<MudTable Items="visite.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">

						<HeaderContent>
							<MudTh>Riepilogo visita</MudTh>
							<MudTh>Data visita</MudTh>
							<MudTh>Data prossima visita</MudTh>
							<MudTh>Tipologia visita</MudTh>
							<MudTh>Esito visita</MudTh>
						</HeaderContent>

						<RowTemplate Context="v">
							<MudTd DataLabel="Riepilogo visita">
								<MudLink Class="table-link-dark"
										 Href="@($"/dettagliovisita/id={v.cr4f9_visitamedicadellavoratoreid}")">
									@v.cr4f9_riepilogovisita
								</MudLink>
							</MudTd>

							<MudTd DataLabel="Data visita">@v.checkDate</MudTd>
							<MudTd DataLabel="Data prossima visita">@v.nextCheckDate</MudTd>
							<MudTd DataLabel="Tipologia visita">@v.TipologiaDescrizione</MudTd>
							<MudTd DataLabel="Esito visita">@v.EsitoDescrizione</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>
				</div>
			</div>
		</MudTabPanel>


		<MudTabPanel Icon="@Icons.Material.Filled.AccessTimeFilled" Text="Scadenze">
			<div class="folder-container">
				<div class="folder-tab">
					Lavoratore @contatti.value[0].cr4f9_cognome @contatti.value[0].cr4f9_nome
				</div>

				<!-- FORMAZIONE INTERNA -->
				<div class="table-card mb-6">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Formazione Interna</MudText>
						</div>
					</div>

					<MudTable Items="scadenzeCorsoInt.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">

						<HeaderContent>
							<MudTh>Titolo Corso</MudTh>
							<MudTh>Data Esecuzione</MudTh>
							<MudTh>Data Scadenza</MudTh>
						</HeaderContent>

						<RowTemplate Context="corso">
							<MudTd DataLabel="Titolo">@corso.cr4f9_corsotipo</MudTd>
							<MudTd DataLabel="Data Esecuzione">
								@(corso.dataFineCorso != DateTime.MinValue ? corso.dataFineCorso.ToString("dd/MM/yyyy") : "")
							</MudTd>
							<MudTd DataLabel="Data Scadenza">
								@(corso.cr4f9_scadenza != DateTime.MinValue ? corso.cr4f9_scadenza.ToString("dd/MM/yyyy") : "")
							</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10,20}" />
						</PagerContent>
					</MudTable>
				</div>

				<!-- FORMAZIONE ESTERNA -->
				<div class="table-card mb-6">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Formazione Esterna</MudText>
						</div>
					</div>

					<MudTable Items="scadenzeCorsoEst.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">

						<HeaderContent>
							<MudTh>Titolo Corso</MudTh>
							<MudTh>Data Esecuzione</MudTh>
							<MudTh>Data Scadenza</MudTh>
						</HeaderContent>

						<RowTemplate Context="corso">
							<MudTd DataLabel="Titolo">@corso.new_titolocorso</MudTd>
							<MudTd DataLabel="Data Esecuzione">
								@(corso.new_data != DateTime.MinValue ? corso.new_data.ToString("dd/MM/yyyy") : "")
							</MudTd>
							<MudTd DataLabel="Data Scadenza">
								@(corso.new_scadenza != DateTime.MinValue ? corso.new_scadenza.ToString("dd/MM/yyyy") : "")
							</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10,20}" />
						</PagerContent>
					</MudTable>
				</div>

				<!-- VISITE MEDICHE -->
				<div class="table-card mb-6">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Visite Mediche</MudText>
						</div>
					</div>

					<MudTable Items="scadenzeVisite.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">

						<HeaderContent>
							<MudTh>Riepilogo Visita</MudTh>
							<MudTh>Data Esecuzione</MudTh>
							<MudTh>Data Prossima Visita</MudTh>
						</HeaderContent>

						<RowTemplate Context="v">
							<MudTd DataLabel="Riepilogo">@v.cr4f9_riepilogovisita</MudTd>
							<MudTd DataLabel="Data Esecuzione">@v.cr4f9_datavisita.ToString("dd/MM/yyyy")</MudTd>
							<MudTd DataLabel="Data Prossima Visita">@v.cr4f9_dataprossimavisita.ToString("dd/MM/yyyy")</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10,20}" />
						</PagerContent>
					</MudTable>
				</div>

				<!-- CONTROLLI DPI -->
				<div class="table-card">
					<div class="table-card-header">
						<div class="table-card-title">
							<MudText Typo="Typo.h6" Class="mb-0">Controlli DPI</MudText>
						</div>
					</div>

					<MudTable Items="scadenzeControlli.value"
							  Dense="true"
							  Hover="true"
							  HeaderClass="mud-table-header"
							  Class="pretty-table">

						<HeaderContent>
							<MudTh>Dispositivo</MudTh>
							<MudTh>Data Esecuzione</MudTh>
							<MudTh>Data Scadenza</MudTh>
						</HeaderContent>

						<RowTemplate Context="c">
							<MudTd DataLabel="Dispositivo">@c.Riepilogo</MudTd>
							<MudTd DataLabel="Data Esecuzione">@c.cr4f9_dataesecuzione.ToString("dd/MM/yyyy")</MudTd>
							<MudTd DataLabel="Data Scadenza">@c.cr4f9_datascadenzacontrollo.ToString("dd/MM/yyyy")</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10,20}" />
						</PagerContent>
					</MudTable>
				</div>
			</div>
		</MudTabPanel>


	</MudTabs>
}
else
{
	<MudProgressCircular Color="Color.Default" Indeterminate="true" />
}


@code {
    [Parameter]
    public string id { get; set; }

    private string message = "Loading...";
    private string userName;
    private string userEmail;
    private string fetchXmlQuery;
    private string fetchXmlQueryPartecipazioni;
    private string fetchXmlQueryPartecipazioniEsterne;
    private string fetchXmlQueryConsegneDpi;
    private string fetchXmlQueryVisite;
    private string fetchXmlQueryScadenzeCorsiInterni;
    private string fetchXmlQueryScadenzeCorsiEsterni;
    private string fetchXmlQueryScadenzeVisite;
    private string fetchXmlQueryScadenzeControlliDPI;
    private string clienteId;
    private Guid? azienda;

    private DateTime? dataEsecuzioneFrom;
    private DateTime? dataEsecuzioneTo;
    private DateTime? dataScadenzaFrom;
    private DateTime? dataScadenzaTo;
    private string searchTipologia;

    private bool showFilters = false;

    private bool editMode = false;

    // Mansioni e sedi.
    private string fetchXmlQueryMansioniESedi;

    private ContattoCollection contatti = new ContattoCollection { value = Array.Empty<Contatto>() };
    private PartecipazioneCollection partecipazioni = new PartecipazioneCollection { value = Array.Empty<Partecipazione>() };
    private MansioneCollection mansioni = new MansioneCollection { value = Array.Empty<Mansione>() };
    private ConsegneCollection consegne = new ConsegneCollection { value = Array.Empty<Consegna>() };
    private VisitaCollection visite = new VisitaCollection { value = Array.Empty<Visita>() };
    private ScadenzaCorsoIntCollection scadenzeCorsoInt = new ScadenzaCorsoIntCollection { value = Array.Empty<ScadenzaCorsoInt>() };
    private ScadenzaCorsoEstCollection scadenzeCorsoEst = new ScadenzaCorsoEstCollection { value = Array.Empty<ScadenzaCorsoEst>() };
    private ScadenzeVisiteCollection scadenzeVisite = new ScadenzeVisiteCollection { value = Array.Empty<ScadenzaVisita>() };
    private ScadenzeControlliDPICollection scadenzeControlli = new ScadenzeControlliDPICollection { value = Array.Empty<ScadenzaControlloDPI>() };
    private List<ScadenzaGenerica> scadenzeGeneriche = new List<ScadenzaGenerica>();

    protected override async Task OnInitializedAsync() {

        await LoadUserInformation();

        // Prima query FetchXML
        fetchXmlQuery = $@"
                    <fetch>
                      <entity name='cr4f9_contattoprv'>
                        <attribute name='cr4f9_cognome' />
                        <attribute name='cr4f9_nome' />
                        <attribute name='cr4f9_codicefiscale' />
                        <attribute name='cr4f9_datadinascita' />
                        <attribute name='cr4f9_luogodinascita' />
                        <attribute name='cr4f9_provinciadinascita' />
                        <attribute name='cr4f9_nazionalita' />
                        <attribute name='cr4f9_telefonoprincipale' />
                        <attribute name='cr4f9_emailprincipale' />
                        <filter>
                          <condition attribute='cr4f9_contattoprvid' operator='eq' value='{id}' />
                        </filter>
                      </entity>
                    </fetch>";

        fetchXmlQueryPartecipazioni = $@"
                        <fetch>
                            <entity name='new_partecipazionecorsoprv'>
                            <attribute name='new_partecipazionecorsoprvid' />
                            <attribute name='cr4f9_corsotipo' />
                            <attribute name='cr4f9_superato' />
                            <filter>
                                <condition attribute='new_lavoratore' operator='eq' value='{id}' />
                            </filter>
                            <link-entity name='cr4f9_corsoprv' from='cr4f9_corsoprvid' to='new_corso' alias='corso'>
                              <attribute name='cr4f9_datadifine' alias='dataFineCorso'/>
                              <attribute name='cr4f9_titolocorso' alias='titolo' />
                            </link-entity>
                            </entity>
                        </fetch>";

        fetchXmlQueryPartecipazioniEsterne = $@"
                        <fetch>
                          <entity name='new_partecipazioneesternaprv'>
                            <attribute name='new_data' />
                            <attribute name='new_titolocorso' />
                            <filter>
                              <condition attribute='new_lavoratore' operator='eq' value='{id}' />
                            </filter>
                            <link-entity name='cr4f9_corsotipoprv' from='cr4f9_corsotipoprvid' to='new_corsotipo' link-type='inner' alias='CorsoTipo'>
                              <attribute name='cr4f9_nomecorsotipo' alias='titolo'/>
                            </link-entity>
                          </entity>
                        </fetch>"; 

        fetchXmlQueryConsegneDpi = $@"
                <fetch>
                  <entity name='cr4f9_testataconsegna'>
                    <attribute name='cr4f9_idtestata' />
                    <attribute name='cr4f9_dataconsegna' />
                    <attribute name='cr4f9_testataconsegnaid' />
                    <filter>
                      <condition attribute='cr4f9_cliente' operator='eq' value='{azienda}' />
                    </filter>
                    <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' link-type='inner' alias='Lavoratore'>
                      <filter>
                        <condition attribute='cr4f9_contattoprvid' operator='eq' value='{id}' />
                      </filter>
                    </link-entity>
                  </entity>
                </fetch>";

        fetchXmlQueryVisite = $@"
        <fetch>
            <entity name='cr4f9_visitamedicadellavoratore'>
                <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' alias='contatto'>
                    <link-entity name='new_lavorapressoprv' from='new_lavoratore' to='cr4f9_contattoprvid' alias='lavoraPresso'>
                        <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                            <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                                <filter>
                                    <condition attribute='new_email' operator='eq' value='{userEmail}' />
                                </filter>
                            </link-entity>
                        </link-entity>
                    </link-entity>
                </link-entity>
                <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' link-type='inner' alias='Lavoratore'>
                      <filter>
                        <condition attribute='cr4f9_contattoprvid' operator='eq' value='{id}' />
                      </filter>
                    </link-entity>
            </entity>
        </fetch>";

        fetchXmlQueryMansioniESedi = $@"
        <fetch>
          <entity name='new_lavorapressoprv'>
            <filter>
              <condition attribute='new_lavoratore' operator='eq' value='{id}' />
            </filter>
            <filter>
              <condition attribute='new_azienda' operator='eq' value='{azienda}' />
            </filter>
            <link-entity name='new_sedeprv' from='new_sedeprvid' to='new_sede' link-type='inner' alias='Sede'>
              <attribute name='new_localita' alias='sede' />
            </link-entity>
            <link-entity name='new_mansionetabellamaster' from='new_mansionetabellamasterid' to='cr4f9_mansione' link-type='inner' alias='Mansione'>
              <attribute name='new_mansione' alias ='mansione' />
            </link-entity>
            <attribute name='cr4f9_inforza' />
          </entity>
        </fetch>";

        fetchXmlQueryScadenzeCorsiInterni = $@"
        <fetch>
          <entity name='new_partecipazionecorsoprv'>
            <attribute name='new_partecipazionecorsoprvid' />
            <attribute name='cr4f9_scadenza' />
            <attribute name='cr4f9_corsotipo' />
            <filter>
              <condition attribute='new_lavoratore' operator='eq' value='{id}' />
            </filter>
            <link-entity name='cr4f9_corsoprv' from='cr4f9_corsoprvid' to='new_corso' link-type='inner' alias='Corso'>
              <attribute name='cr4f9_datadifine' alias='dataFineCorso'/>
            </link-entity>
          </entity>
        </fetch>";

        fetchXmlQueryScadenzeCorsiEsterni = $@"
        <fetch>
          <entity name='new_partecipazioneesternaprv'>
            <attribute name='new_titolocorso' />
            <attribute name='new_scadenza' />
            <attribute name='new_data' />
            <filter>
              <condition attribute='new_lavoratore' operator='eq' value='{id}' />
            </filter>
          </entity>
        </fetch>";

        fetchXmlQueryScadenzeVisite = $@"
        <fetch>
          <entity name='cr4f9_visitamedicadellavoratore'>
            <attribute name='cr4f9_visitamedicadellavoratoreid' />
            <attribute name='cr4f9_riepilogovisita' />
            <attribute name='cr4f9_dataprossimavisita' />
            <attribute name='cr4f9_datavisita' />
            <filter>
              <condition attribute='cr4f9_lavoratore' operator='eq' value='{id}' />
            </filter>
          </entity>
        </fetch>";

        fetchXmlQueryScadenzeControlliDPI = $@"
        <fetch>
          <entity name='cr4f9_elencocontrollidpi'>
            <attribute name='cr4f9_dispositivoconsegnato' />
            <attribute name='cr4f9_datascadenzacontrollo' />
            <attribute name='cr4f9_dataesecuzione' />
            <link-entity name='cr4f9_associazionedpialavoratore' from='cr4f9_associazionedpialavoratoreid' to='cr4f9_dispositivoconsegnato' link-type='inner' alias='ConsegnaDPI'>
              <attribute name='cr4f9_riepilogoconsegnacalculated' alias='Riepilogo'/>
              <filter>
                <condition attribute='cr4f9_lavoratorelookup' operator='eq' value='{id}' />
              </filter>
            </link-entity>
          </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
        {
            Method = HttpMethod.Get,
            RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
        };
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                contatti = await response.Content.ReadFromJsonAsync<ContattoCollection>();
            }
            else
            {
                message = "An error occurred in the first request.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
                return; // Termina se la prima richiesta fallisce
            }     
        }
        else
        {
            message = "There was a problem authenticating.";
        }

        // Seconda richiesta.

        var tokenResultPartecipazioni = await TokenProvider.RequestAccessToken();

        if (tokenResultPartecipazioni.TryGetToken(out var tokenPart)) {
            logger.LogInformation("FETCH PARTECIPAZIONI: " + fetchXmlQueryPartecipazioni);
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
        {
            Method = HttpMethod.Get,
            RequestUri = new Uri($"{client.BaseAddress}new_partecipazionecorsoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQueryPartecipazioni)}")
        };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenPart.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                partecipazioni = await response.Content.ReadFromJsonAsync<PartecipazioneCollection>();

                foreach (var part in partecipazioni.value)
                {
                    part.Interna = true;
                }
            }
            else
            {
                message = "An error occurred in the first request.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
                return; // Termina se la prima richiesta fallisce
            }    
        }
        else
        {
            message = "There was a problem authenticating.";
        }

        var tokenResultPartecipazioniEsterne = await TokenProvider.RequestAccessToken();

        if (tokenResultPartecipazioniEsterne.TryGetToken(out var tokenPartEst))
        {
            logger.LogInformation("FETCH PARTECIPAZIONI ESTERNE: " + fetchXmlQueryPartecipazioniEsterne);
            var client = ClientFactory.CreateClient("DataverseClient");
            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_partecipazioneesternaprvs?fetchXml={Uri.EscapeDataString(fetchXmlQueryPartecipazioniEsterne)}");


            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenPartEst.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var partecipazioniEsterne = await response.Content.ReadFromJsonAsync<PartecipazioneEsternaCollection>();

                if (partecipazioniEsterne?.value !=null && partecipazioniEsterne.value.Length > 0)
                {
                    var listaPartecipazioni = partecipazioni.value.ToList();
                    foreach (var pEst in partecipazioniEsterne.value)
                    {
                        var nuovaPartecipazione = new Partecipazione
                            {
                                new_partecipazionecorsoprvid = null,
                                cr4f9_corsotipo = pEst.titolo,
                                dataFineCorso = pEst.new_data,
                                cr4f9_superato = true,
                                titolo = pEst.titolo,
                                Interna = false
                            };
                        listaPartecipazioni.Add(nuovaPartecipazione);
                    }
                    partecipazioni.value = listaPartecipazioni.ToArray();
                }
            }
            else
            {
                logger.LogError($"Errore nel recupero delle partecipazioni esterne: {response.ReasonPhrase}");
            }
        }
        else
        {
            logger.LogError("Errore di autenticazione durante il recupero delle partecipazioni esterne.");
        }

        // Terza richiesta per mansioni e sedi.

        var tokenResultMansioni = await TokenProvider.RequestAccessToken();

        if (tokenResultMansioni.TryGetToken(out var tokenMans))
        {
            logger.LogInformation("FETCH MANSIONI: " + fetchXmlQueryMansioniESedi);
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}new_lavorapressoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQueryMansioniESedi)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenMans.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                mansioni = await response.Content.ReadFromJsonAsync<MansioneCollection>();
            }
            else
            {
                message = "An error occurred in the first request.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
                return;
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }

        // Quarta richiesta per consegne dpi.

        var tokenResultConsegne = await TokenProvider.RequestAccessToken();

        if (tokenResultConsegne.TryGetToken(out var tokenConsegne))
        {
            logger.LogInformation("FETCH CONSEGNE: " + fetchXmlQueryConsegneDpi);
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_testataconsegnas?fetchXml={Uri.EscapeDataString(fetchXmlQueryConsegneDpi)}");

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenConsegne.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                consegne = await response.Content.ReadFromJsonAsync<ConsegneCollection>();
            }
            else
            {
                message = "An error occurred while fetching data.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
                return;
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }

        var tokenResultVisite = await TokenProvider.RequestAccessToken();

        if (tokenResultVisite.TryGetToken(out var tokenVisite))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_visitamedicadellavoratores?fetchXml={Uri.EscapeDataString(fetchXmlQueryVisite)}")
                    // RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?$top=100")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenVisite.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                visite = await response.Content.ReadFromJsonAsync<VisitaCollection>();
                logger.LogInformation($"Visita: {visite.value}");
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }

        var tokenResultScadenzeCorsiInterni = await TokenProvider.RequestAccessToken();

        if (tokenResultScadenzeCorsiInterni.TryGetToken(out var tokenScadenzeCorsiInterni))
        {
            var client = ClientFactory.CreateClient("DataverseClient");
            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_partecipazionecorsoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQueryScadenzeCorsiInterni)}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenScadenzeCorsiInterni.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if(response.IsSuccessStatusCode)
            {
                scadenzeCorsoInt = await response.Content.ReadFromJsonAsync<ScadenzaCorsoIntCollection>();
            }
            else
            {
                logger.LogError($"Error fetching scadenze corsi interni: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating for scadenze corsi interni.";
        }

        var tokenResultScadenzeCorsiEsterni = await TokenProvider.RequestAccessToken();

        if (tokenResultScadenzeCorsiEsterni.TryGetToken(out var tokenScadenzeCorsiEsterni))
        {
            var client = ClientFactory.CreateClient("DataverseClient");
            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_partecipazioneesternaprvs?fetchXml={Uri.EscapeDataString(fetchXmlQueryScadenzeCorsiEsterni)}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenScadenzeCorsiEsterni.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                scadenzeCorsoEst = await response.Content.ReadFromJsonAsync<ScadenzaCorsoEstCollection>();
            }
            else
            {
                logger.LogError($"Error fetching scadenze corsi esterni: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating for scadenze corsi esterni.";
        }

        var tokenResultScadenzeVisite = await TokenProvider.RequestAccessToken();

        if (tokenResultScadenzeVisite.TryGetToken(out var tokenScadenzeVisite))
        {
            var client = ClientFactory.CreateClient("DataverseClient");
            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_visitamedicadellavoratores?fetchXml={Uri.EscapeDataString(fetchXmlQueryScadenzeVisite)}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenScadenzeVisite.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                scadenzeVisite = await response.Content.ReadFromJsonAsync<ScadenzeVisiteCollection>();
            }
            else
            {
                logger.LogError($"Error fetching scadenze visite: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating for scadenze visite.";
        }

        var tokenResultScadenzeControlliDPI = await TokenProvider.RequestAccessToken();
        if (tokenResultScadenzeControlliDPI.TryGetToken(out var tokenScadenzeControlliDPI))
        {
            var client = ClientFactory.CreateClient("DataverseClient");
            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_elencocontrollidpis?fetchXml={Uri.EscapeDataString(fetchXmlQueryScadenzeControlliDPI)}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", tokenScadenzeControlliDPI.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                scadenzeControlli = await response.Content.ReadFromJsonAsync<ScadenzeControlliDPICollection>();
            }
            else
            {
                logger.LogError($"Error fetching scadenze controlli DPI: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating for scadenze controlli DPI.";
        }

        if (scadenzeCorsoInt?.value != null)
        {
            foreach (var corso in scadenzeCorsoInt.value)
            {
                scadenzeGeneriche.Add(new ScadenzaGenerica
                    {
						Id = corso.new_partecipazionecorsoprvid,
                        DataScadenza = corso.cr4f9_scadenza,
						DataEsecuzione = corso.dataFineCorso,
                        Titolo = corso.cr4f9_corsotipo,
                        TipoScadenza = "Formazione "
                    });
            }
        }

        // Conversione scadenze corsi esterni
        if (scadenzeCorsoEst?.value != null)
        {
            foreach (var corso in scadenzeCorsoEst.value)
            {
                scadenzeGeneriche.Add(new ScadenzaGenerica
                    {
                        Id = null,
                        DataScadenza = corso.new_scadenza,
						DataEsecuzione = corso.new_data,
                        Titolo = corso.new_titolocorso,
                        TipoScadenza = "Formazione"
                    });
            }
        }

        // Conversione scadenze visite
        if (scadenzeVisite?.value != null)
        {
            foreach (var visita in scadenzeVisite.value)
            {
                scadenzeGeneriche.Add(new ScadenzaGenerica
                    {
						Id = visita.cr4f9_visitamedicadellavoratoreid,
                        DataScadenza = visita.cr4f9_dataprossimavisita,
						DataEsecuzione = visita.cr4f9_datavisita,
                        Titolo = visita.cr4f9_riepilogovisita,
                        TipoScadenza = "Visita Medica"
                    });
            }
        }

        // Conversione scadenze controlli DPI
        if (scadenzeControlli?.value != null)
        {
            foreach (var controllo in scadenzeControlli.value)
            {
                scadenzeGeneriche.Add(new ScadenzaGenerica
                    {
                        Id = controllo.cr4f9_dispositivoconsegnato,
                        DataScadenza = controllo.cr4f9_datascadenzacontrollo,
						DataEsecuzione = controllo.cr4f9_dataesecuzione,
                        Titolo = controllo.Riepilogo,
                        TipoScadenza = "Controllo DPI"
                    });
            }
        }
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = System.Text.Json.JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new System.Text.Json.JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private bool FilterFunc(ScadenzaGenerica scadenza)
    {
        bool matches = true;
        if (!string.IsNullOrEmpty(searchTipologia))
        {
            matches &= scadenza.TipoScadenza != null && scadenza.TipoScadenza.ToLower().Contains(searchTipologia.ToLower());
        }

        if (dataEsecuzioneFrom.HasValue)
        {
            matches &= scadenza.DataEsecuzione >= dataEsecuzioneFrom.Value;
        }

        if (dataEsecuzioneTo.HasValue)
        {
            matches &= scadenza.DataEsecuzione <= dataEsecuzioneTo.Value;
        }

        if (dataScadenzaFrom.HasValue)
        {
            matches &= scadenza.DataScadenza >= dataScadenzaFrom.Value;
        }

        if (dataScadenzaTo.HasValue)
        {
            matches &= scadenza.DataScadenza <= dataScadenzaTo.Value;
        }

        return matches;
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private async Task ToggleEdit()
    {
        if (!editMode)
        {
            editMode = true;
        }
        else
        {
            await SalvaModifiche();

            editMode = false;
        }
    }

    private async Task SalvaModifiche()
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();

            if(tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var lavoratoreAggiornato = new
                {
                    cr4f9_codicefiscale = contatti.value[0].cr4f9_codicefiscale,
                    cr4f9_cognome = contatti.value[0].cr4f9_cognome,
                    cr4f9_nome = contatti.value[0].cr4f9_nome,
                    cr4f9_datadinascita = contatti.value[0].cr4f9_datadinascita,
                    cr4f9_luogodinascita = contatti.value[0].cr4f9_luogodinascita,
                    cr4f9_provinciadinascita = contatti.value[0].cr4f9_provinciadinascita,
                    cr4f9_nazionalita = contatti.value[0].cr4f9_nazionalita
                };

                var request = new HttpRequestMessage(new HttpMethod("PATCH"), $"{client.BaseAddress}cr4f9_contattoprvs({id})")
                    {
                        Content = JsonContent.Create(lavoratoreAggiornato)
                    };
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);
                if (response.IsSuccessStatusCode)
                {
                    logger.LogInformation("Modifiche salvate con successo.");
                    editMode = false;
                }
                else
                {
                    logger.LogError($"Errore durante il salvataggio delle modifiche: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il salvataggio delle modifiche.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il salvataggio: {ex.Message}");
        }
    }   

    private void ClearFilters()
    {
        searchTipologia = string.Empty;
        dataEsecuzioneFrom = null;
        dataEsecuzioneTo = null;
        dataScadenzaFrom = null;
        dataScadenzaTo = null;
    }

    private void GoBack()
    {
        // Utilizza la navigazione per tornare indietro nella cronologia
        Navigation.NavigateTo("javascript:history.back()");
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
        await CaricaClienteAssociato(userEmail);
    }

    private Task OpenDialogAsyncDpi()
    {
        var parameters = new DialogParameters();
        parameters.Add("id", id);

        logger.LogInformation($"Parametro id inviato :{id}");

        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                FullWidth = false,              // Impedisce al dialog di occupare tutta la larghezza della pagina
                MaxWidth = MaxWidth.Medium       // Imposta una larghezza massima ragionevole (puoi usare anche Small, Large, ecc.)
            };
        return DialogService.ShowAsync<AddTestataDpiLavoratore>("Simple Dialog", parameters, options);
    }

    private Task OpenDialogAsyncSede()
    {
        var parameters = new DialogParameters();
        parameters.Add("id", id);

        logger.LogInformation($"Parametro id inviato :{id}");

        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                FullWidth = false,              // Impedisce al dialog di occupare tutta la larghezza della pagina
                MaxWidth = MaxWidth.Medium       // Imposta una larghezza massima ragionevole (puoi usare anche Small, Large, ecc.)
            };
        return DialogService.ShowAsync<AddSedeALavoratore>("Simple Dialog", parameters, options);
    }

    public class Contatto
    {
        public string cr4f9_cognome { get; set; }
        public string cr4f9_nome { get; set; }
        public string cr4f9_codicefiscale { get; set; }
        public DateTime cr4f9_datadinascita { get; set; }
        public string cr4f9_luogodinascita { get; set; }
        public string cr4f9_provinciadinascita { get; set; }
        public string cr4f9_nazionalita { get; set; }
        public string cr4f9_telefonoprincipale { get; set; }
        public string cr4f9_emailprincipale { get; set; }

        public string dataNascita => cr4f9_datadinascita.ToString("dd/MM/yyyy");
    }

    public class ContattoCollection
    {
        public Contatto[] value { get; set; }
    }

    public class Partecipazione {
        public string new_partecipazionecorsoprvid { get; set; }
        public string cr4f9_corsotipo { get; set; }
        public DateTime dataFineCorso { get; set; }
        public bool cr4f9_superato { get; set; }

        public string dataFineCorsoString => dataFineCorso.ToString("dd/MM/yyyy");
        public string titolo { get; set; }
        public bool Interna { get; set; }
    }

    public class PartecipazioneCollection {

        public Partecipazione[] value { get; set; }
    }

    public class PartecipazioneEsterna
    {
        public DateTime new_data { get; set; }
        public string new_titolcorso { get; set; }
        public string titolo { get; set; }
    }

    public class PartecipazioneEsternaCollection
    {
        public PartecipazioneEsterna[] value { get; set; }
    }

    public class Mansione {

        public string sede { get; set; }
        public string mansione { get; set; }
        public bool cr4f9_inforza { get; set; }

    }

    public class MansioneCollection {

        public Mansione[] value { get; set; }
    }

    public class Consegna
    {
        public string cr4f9_idtestata { get; set; }
        public DateTime? cr4f9_dataconsegna { get; set; }
        public string cr4f9_testataconsegnaid { get; set; }
    }

    public class ConsegneCollection {

        public Consegna[] value { get; set; }
    }

    public class Visita
    {
        public Guid cr4f9_visitamedicadellavoratoreid { get; set; }
        public string cr4f9_riepilogovisita { get; set; }
        public DateTime cr4f9_datavisita { get; set; }
        public DateTime cr4f9_dataprossimavisita { get; set; }

        public int cr4f9_tipologiadivisita { get; set; }

        public int cr4f9_esitodellavisita { get; set; }

        public TipologiaVisita Tipologia
        {
            get => (TipologiaVisita)cr4f9_tipologiadivisita;
            set => cr4f9_tipologiadivisita = (int)value;
        }

        public string TipologiaDescrizione => Tipologia switch
        {
            TipologiaVisita.Preassuntiva => "Preassuntiva",
            TipologiaVisita.Periodica => "Periodica",
            TipologiaVisita.SuRichiesta => "Su richiesta",
            TipologiaVisita.Rientro => "Rientro da malattia/infortunio",
            TipologiaVisita.Fine => "Fine rapporto",
            _ => "Sconosciuto"
        };

        public EsitoVisita Esito
        {
            get => (EsitoVisita)cr4f9_esitodellavisita;
            set => cr4f9_esitodellavisita = (int)value;
        }

        public string EsitoDescrizione => Esito switch
        {
            EsitoVisita.Idoneo => "Idoneo",
            EsitoVisita.IdoneoConPrescrizioni => "Idoneo con prescrizioni",
            EsitoVisita.IdoneoConLimitazioni => "Idoneo con limitazioni",
            EsitoVisita.NonIdoneoTemporanemante => "Non idoneo temporaneamente",
            EsitoVisita.NonIdoneoPermanentemente => "Non idoneo permanentemente"
        };

        public string checkDate => cr4f9_datavisita.ToString("dd/MM/yyyy");
        public string nextCheckDate => cr4f9_dataprossimavisita.ToString("dd/MM/yyyy");
    }

    public class VisitaCollection
    {
        public Visita[] value { get; set; }
    }

    public enum TipologiaVisita
    {
        Preassuntiva = 644840000,
        Fine = 644840004,
        Periodica = 644840001,
        SuRichiesta = 644840002,
        Rientro = 644840003
    }

    public enum EsitoVisita
    {
        Idoneo = 644840000,
        IdoneoConPrescrizioni = 644840004,
        IdoneoConLimitazioni = 644840001,
        NonIdoneoTemporanemante = 644840002,
        NonIdoneoPermanentemente = 644840003
    }

    private DateTime? SelectedDate
    {
        get => contatti.value[0].cr4f9_datadinascita;
        set
        {
            if (value.HasValue)
            {
                contatti.value[0].cr4f9_datadinascita = value.Value;
            }
        }
    }

    public class ScadenzaCorsoInt 
    {
		public string new_partecipazionecorsoprvid { get; set; }
        public DateTime cr4f9_scadenza { get; set; }
        public string cr4f9_corsotipo { get; set; }
		public DateTime dataFineCorso { get; set; }
    }

    public class ScadenzaCorsoIntCollection 
    {
        public ScadenzaCorsoInt[] value { get; set; }
    }

    public class ScadenzaCorsoEst
    {
        public string new_titolocorso { get; set; }
        public DateTime new_scadenza { get; set; }
		public DateTime new_data { get; set; }
    }

    public class ScadenzaCorsoEstCollection
    {
        public ScadenzaCorsoEst[] value { get; set; }
    }

    public class ScadenzaVisita
    {
		public string cr4f9_visitamedicadellavoratoreid { get; set; }
        public string cr4f9_riepilogovisita { get; set; }
        public DateTime cr4f9_dataprossimavisita { get; set; }
        public DateTime cr4f9_datavisita { get; set; }
    }

    public class ScadenzeVisiteCollection
    {
        public ScadenzaVisita[] value { get; set; }
    }

    public class ScadenzaControlloDPI
    {
		public string cr4f9_dispositivoconsegnato { get; set; }
        public DateTime cr4f9_datascadenzacontrollo { get; set; }
		public DateTime cr4f9_dataesecuzione { get; set; }
        public string Riepilogo { get; set; }
    }

    public class ScadenzeControlliDPICollection
    {
        public ScadenzaControlloDPI[] value { get; set; }
    }

    public class ScadenzaGenerica
    {
		public string Id { get; set; }
        public DateTime DataScadenza { get; set; }
		public DateTime DataEsecuzione { get; set; }
        public string Titolo { get; set; }
        public string TipoScadenza { get; set; }
    }

}