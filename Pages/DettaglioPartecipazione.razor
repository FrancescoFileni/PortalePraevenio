@page "/dettagliopartecipazione/id={id}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using MudBlazor
@using System.Text
@using System.Net.Http;
@using System.Threading.Tasks;
@using System.Web;
@inject IJSRuntime JSRuntime
@inject IJSRuntime iJSRuntime
@inject IJSRuntime JS
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject NavigationManager Navigation

<link href="css/dettaglio-partecipazione.css" rel="stylesheet" />

<div class="toolbar">
	<div class="toolbar-left">
		<MudButton Variant="Variant.Text"
				   Color="Color.Error"
				   Class="back-btn"
				   StartIcon="@Icons.Material.Filled.ArrowBack"
				   OnClick="GoBack" />

		<MudText Typo="Typo.h5" Class="page-title">
			Dettaglio partecipazione
		</MudText>
	</div>
</div>


@if (partecipazioni?.value?.Length > 0)
{
	<div class="page-shell">

		<div class="table-card">
			<div class="table-card-header">
				<div class="table-card-title">
					<MudText Typo="Typo.h6">
						Partecipazione lavoratore
					</MudText>
					<MudText Typo="Typo.caption" Class="table-subtitle">
						@partecipazioni.value[0].cr4f9_cognome @partecipazioni.value[0].cr4f9_nome
					</MudText>
				</div>

				<MudButton Variant="Variant.Filled"
						   Color="Color.Error"
						   Disabled="@(!partecipazioni.value[0].cr4f9_superato)"
						   StartIcon="@Icons.Material.Filled.PictureAsPdf"
						   OnClick="openReport">
					Scarica attestato
				</MudButton>
			</div>

			<div class="card-body">

				<div class="details-grid">
					<div class="detail-card span-2">
						<MudDateRangePicker Margin="Margin.Dense"
											ReadOnly="true"
											Clearable="false"
											Class="range-picker"
											PlaceholderStart="@(partecipazioni.value[0].dataInizio == "01/01/0001" ? partecipazioni.value[0].dataInizioCorsoString : partecipazioni.value[0].dataInizio)"
											PlaceholderEnd="@(partecipazioni.value[0].dataFine == "01/01/0001" ? partecipazioni.value[0].dataFineCorsoString : partecipazioni.value[0].dataFine)" />
					</div>

					<div class="detail-card">
						<div class="info-row">
							<span class="label">Tipo corso</span>
							<span class="value">@partecipazioni.value[0].tipoCorso</span>
						</div>
					</div>

					<div class="detail-card">
						<div class="info-row">
							<span class="label">Corso sostenuto</span>
							<span class="value">@partecipazioni.value[0].titoloCorso</span>
						</div>
					</div>

					<div class="detail-card span-2">
						<div class="info-row">
							<span class="label">Esito</span>
							@if (partecipazioni.value[0].cr4f9_superato)
							{
								<span class="status-pill ok">Superato</span>
							}
							else
							{
								<span class="status-pill ko">Non superato</span>
							}
						</div>
					</div>
				</div>

				@if (!partecipazioni.value[0].cr4f9_superato)
				{
					<div class="hint">
						L’attestato è scaricabile solo se il corso risulta superato.
					</div>
				}
			</div>
		</div>
	</div>

}
else if (!string.IsNullOrEmpty(message))
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
} 
else
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}

@code {
    [Parameter]
    public string id { get; set; }

    private string message = "Loading...";
    private string userName;
    private string userEmail;
    private string fetchXmlQuery;

    private PartecipazioneCollection partecipazioni = new PartecipazioneCollection { value = Array.Empty<Partecipazione>() };

    /* Select values */
    string _value;
    Margin _margin;
    bool _dense;
    bool _disabled;
    bool _readonly = true;
    bool _placeholder;
    bool _helperText;
    bool _helperTextOnFocus;
    bool _clearable;
    bool _isEditing = false;
    private string Icon => _isEditing ? Icons.Material.Filled.Save : Icons.Material.Filled.Edit;

    private async Task GeneratePdf(string titolocorso, 
                                    string corsoId, 
                                    string corsoTipo, 
                                    string cognome, 
                                    string nome, 
                                    string intestazione1, 
                                    string intestazione2,
                                    string titoloAttestato,
                                    string normative,
                                    string testo3,
                                    string codiceFiscale,
                                    string dataNascita,
                                    string luogoNascita,
                                    string provinciaNascita,
                                    string azienda, 
                                    string testo4,
                                    string testo5,
                                    string dataInizio,
                                    string dataFine,
                                    string durata,
                                    string sedeDelCorso,
                                    string sedeTeoricaDelCorso,
                                    string sedePraticaDelCorso,
                                    string indicareSede,
                                    string indicareSedeTeorica,
                                    string indicareSedePratica,
                                    string indirizzoDue,
                                    string indirizzoTre,
                                    string sedeP,
                                    string sedeT,
                                    string docenteCognome,
                                    string docenteNome,
                                    string dataInizioCorso,
                                    string dataFineCorso,
                                    string pieDiPagina)
    {
        // Contenuto del PDF
        string content = titolocorso + corsoId;

        // Chiamata alla funzione JavaScript per generare il PDF
        await JS.InvokeVoidAsync("generatePDF", content, corsoId, corsoTipo, cognome, nome, intestazione1, intestazione2, titoloAttestato, normative, testo3, codiceFiscale,
                                 dataNascita, luogoNascita, provinciaNascita, azienda, testo4, testo5, dataInizio, dataFine, durata, sedeDelCorso, sedeTeoricaDelCorso, sedePraticaDelCorso,
                                 indicareSede, indicareSedeTeorica, indicareSedePratica, indirizzoDue, indirizzoTre, sedeP, sedeT, docenteCognome, docenteNome, dataInizioCorso, dataFineCorso, pieDiPagina);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); 

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
                        <fetch>
                            <entity name='new_partecipazionecorsoprv'>
                            <attribute name='cr4f9_cognome' />
                            <attribute name='cr4f9_nome' />
                            <attribute name='cr4f9_corsotipo' />
                            <attribute name='cr4f9_azienda' />
                            <attribute name='cr4f9_codicefiscale' />
                            <attribute name='cr4f9_datadinascita' />
                            <attribute name='cr4f9_superato' />
                            <attribute name='cr4f9_datadiinizio' />
                            <attribute name='new_dataconclusione' />
                            <filter>
                                <condition attribute='new_partecipazionecorsoprvid' operator='eq' value='{id}' />
                            </filter>
                            <link-entity name='cr4f9_corsoprv' from='cr4f9_corsoprvid' to='new_corso' alias='corso'>
                                <attribute name='cr4f9_titolocorso' alias='titoloCorso'/>
                                <attribute name='cr4f9_idcorso' alias='corsoId'/>
                                <attribute name='cr4f9_intestazione1' alias='intestazioneUno'/>
                                <attribute name='cr4f9_intestazione2' alias='intestazioneDue'/>
                                <attribute name='cr4f9_titoloattestato' alias='titoloAttestato'/>
                                <attribute name='cr4f9_normative' alias='normative'/>
                                <attribute name='cr4f9_testo3' alias='testoTre'/>
                                <attribute name='cr4f9_testo4' alias='testoQuattro'/>
                                <attribute name='cr4f9_testo5' alias='testoCinque'/>
                                <attribute name='cr4f9_duratacomplessivainore' alias='durata'/>
                                <attribute name='new_sedecorso' alias='sedeCorso'/>
                                <attribute name='new_sedeteorica' alias='sedeTeorica'/>
                                <attribute name='new_sedepratica' alias='sedePratica'/>
                                <attribute name='new_indicaresede' alias='indicareSede'/>
                                <attribute name='new_indicaresedeteorica' alias='indicareSedeTeorica'/>
                                <attribute name='new_indicaresedepratica' alias='indicareSedePratica'/>
                                <attribute name='cr4f9_indirizzo2' alias='indirizzoDue'/>
                                <attribute name='cr4f9_indirizzo3' alias='indirizzoTre'/>
                                <attribute name='cr4f9_sedep' alias='sedeP'/>
                                <attribute name='cr4f9_sedet' alias='sedeT'/>
                                <attribute name='cr4f9_docentecognome' alias='docenteCognome'/>
                                <attribute name='cr4f9_docentenome' alias='docenteNome'/>
                                <attribute name='cr4f9_datadiinizio' alias='dataInizioCorso'/>
                                <attribute name='cr4f9_datadifine' alias='dataFineCorso'/>
                                <attribute name='new_piedipaginaattestato' alias='pieDiPagina'/>
                                  <link-entity name='cr4f9_corsotipoprv' from='cr4f9_corsotipoprvid' to='cr4f9_corsotipo' alias='tipoCorso'>
                                    <attribute name='cr4f9_codicecorsotipo' alias='tipoCorso'/>
                                  </link-entity>
                            </link-entity>
                            <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='new_lavoratore' alias='lavoratore'>
                              <attribute name='cr4f9_luogodinascita' alias='luogonascita'/>
                              <attribute name='cr4f9_provinciadinascita' alias='provinciaNascita'/>
                            </link-entity>
                            </entity>
                        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}new_partecipazionecorsoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                partecipazioni = await response.Content.ReadFromJsonAsync<PartecipazioneCollection>();
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

    private async Task openReport()
    {
        var p = partecipazioni.value[0];
        await JS.InvokeVoidAsync("generatePDF",
            p.titoloCorso,
            p.idCorso,
            p.tipoCorso,
            p.cr4f9_cognome,
            p.cr4f9_nome,
            p.intestazioneUno,
            p.intestazioneDue,
            p.titoloAttestato,
            p.normative,
            p.testoTre,
            p.cr4f9_codicefiscale,
            p.dataNascita,
            p.luogonascita,
            p.provinciaNascita,
            p.cr4f9_azienda,
            p.testoQuattro,
            p.testoCinque,
            p.dataInizio,
            p.dataFine,
            p.durataInOre,
            p.sedeDelCorso,
            p.sedeTeoricaDelCorso,
            p.sedePraticaDelCorso,
            p.indicareSede,
            p.indicareSedeTeorica,
            p.indicareSedePratica,
            p.indirizzoDue,
            p.indirizzoTre,
            p.sedeP,
            p.sedeT,
            p.docenteCognome,
            p.docenteNome,
            p.dataInizioCorsoString,
            p.dataFineCorsoString,
            p.pieDiPagina
        );
    }


    private void GoBack()
    {
        // Utilizza la navigazione per tornare indietro nella cronologia
        Navigation.NavigateTo("javascript:history.back()");
    }

    public class Partecipazione
    {
        public string cr4f9_cognome { get; set; }
        public string cr4f9_nome { get; set; }
        public string cr4f9_codicefiscale { get; set; }
        public string cr4f9_azienda { get; set; }
        public DateTime cr4f9_datadiinizio { get; set; }
        public DateTime new_dataconclusione { get; set; }
        public DateTime dataFineCorso { get; set; }
        public DateTime dataInizioCorso { get; set; }
        public double durata { get; set; }
        public DateTime cr4f9_datadinascita { get; set; }
        public string cr4f9_corsotipo { get; set; }
        public string intestazioneUno { get; set; }
        public string intestazioneDue { get; set; }
        public string titoloAttestato { get; set; }
        public string normative { get; set; }
        public string testoTre { get; set; }
        public string testoQuattro { get; set; }
        public string testoCinque { get; set; }
        public string luogonascita { get; set; }
        public string provinciaNascita { get; set; }
        public bool cr4f9_superato { get; set; }
        public int corsoId { get; set; }
        public string tipoCorso { get; set; }
        public string titoloCorso { get; set; }
        public int sedeCorso { get; set; }
        public int sedeTeorica { get; set; }
        public int sedePratica { get; set; }
        public string indicareSede { get; set; }
        public string indicareSedeTeorica { get; set; }
        public string indicareSedePratica { get; set; }
        public string indirizzoDue { get; set; }
        public string indirizzoTre { get; set; }
        public string docenteCognome { get; set; }
        public string docenteNome { get; set; }
        public string pieDiPagina { get; set; }

        public string sedeP { get; set; }
        public string sedeT { get; set; }

        public string dataInizio => cr4f9_datadiinizio.ToString("dd/MM/yyyy");
        public string dataFine => new_dataconclusione.ToString("dd/MM/yyyy");
        public string dataNascita => cr4f9_datadinascita.ToString("dd/MM/yyyy");
        public string dataFineCorsoString => dataFineCorso.ToString("dd/MM/yyyy");
        public string dataInizioCorsoString => dataInizioCorso.ToString("dd/MM/yyyy");
        public string idCorso => corsoId.ToString();
        public string durataInOre => durata.ToString();

        public string sedeDelCorso => sedeCorso.ToString();
        public string sedeTeoricaDelCorso => sedeTeorica.ToString();
        public string sedePraticaDelCorso => sedePratica.ToString();
    }

    public class PartecipazioneCollection
    {
        public Partecipazione[] value { get; set; }
    }
}
