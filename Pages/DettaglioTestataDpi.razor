@page "/dettaglioTestataDpi/id={IdTestata}"
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject IHttpClientFactory ClientFactory
@inject IAccessTokenProvider TokenProvider
@inject ILogger<FetchSedi> logger
@inject NavigationManager Navigation
@inject IDialogService DialogService

<button @onclick="GoBack">
    <i class="fas fa-arrow-left" style="font-size: 24px; color: white;"></i>
</button>

<MudButton Color="Color.Primary" OnClick="OpenAddConsegneDialog">
    <i class="fas fa-plus"></i> Aggiungi DPI
</MudButton>

<MudTabs Elevation="2" Rounded="true" Class="my-6">
    <MudTabPanel Icon="@Icons.Material.Filled.Info" Text="Dettagli Testata">
        <div class="folder-container">

            <div class="folder-container">
                <div class="folder-tab">
                    Dettaglio Testata Consegna DPI
                </div>

                <div class="folder-section">
                    <MudTextField Label="ID Testata" Value="@codiceTestata" ReadOnly="true" Variant="Variant.Outlined"></MudTextField>
                    <MudDatePicker Label="Data di Consegna" @bind-Date="dataConsegna" Format="dd/MM/yyyy" ReadOnly="true" />
                    <MudTextField Label="Lavoratore" Value="@lavoratore" ReadOnly="true" Variant="Variant.Outlined"></MudTextField>
                </div>
            </div>

            <div class="folder-container">
                <div class="folder-tab">
                    Consegne DPI
                </div>

                <div class="folder-section">
                    <MudTable Items="consegneDpi" Dense="true" HeaderClass="mud-table-header" Hover="true">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Consegne DPI</MudText>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh>Codice DPI</MudTh>
                            <MudTh>Data di Consegna</MudTh>
                            <MudTh>Quantità</MudTh>
                            <MudTh>Numero Matricola</MudTh>
                        </HeaderContent>
                        <RowTemplate Context="consegna">
                            <MudTd DataLabel="Codice DPI">@consegna.nome</MudTd>
                            <MudTd DataLabel="Data di Consegna">@consegna.cr4f9_datadiconsegna.ToString("dd/MM/yyyy")</MudTd>
                            <MudTd DataLabel="Quantità">@consegna.cr4f9_quantita</MudTd>
                            <MudTd DataLabel="Numero Matricola">@consegna.cr4f9_numerodimatricola</MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                        </PagerContent>
                    </MudTable>
                </div>
            </div>
        </div>
    </MudTabPanel>
</MudTabs>

@code {
    [Parameter]
    public string IdTestata { get; set; }

    private Guid? idConsegnaTestata;
    private string codiceTestata;
    private DateTime? dataConsegna;
    private string lavoratore;
    private string id;

    private List<ConsegnaDpi> consegneDpi = new List<ConsegnaDpi>();

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"Testata {idConsegnaTestata}  ---  {IdTestata}");
        if (Guid.TryParse(IdTestata, out var testataId))
        {
            await LoadTestataDetails(testataId);
            await LoadConsegneDpi(testataId);
        }
        else
        {
            logger.LogError("ID della testata non valido.");
        }
    }

    // Carica i dettagli della testata con i dati del lavoratore
    private async Task LoadTestataDetails(Guid testataId)
    {
        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            // Usa la query Fetch aggiornata che include i dettagli del lavoratore
            var fetchXmlTestata = $@"
            <fetch>
              <entity name='cr4f9_testataconsegna'>
                <attribute name='cr4f9_idtestata'/>
                <attribute name='cr4f9_dataconsegna' />
                <filter>
                  <condition attribute='cr4f9_testataconsegnaid' operator='eq' value='{testataId}' />
                </filter>
                <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' link-type='inner' alias='Lavoratore'>
                  <attribute name='cr4f9_calcolonomeecognome' alias='nome'/>
                  <attribute name='cr4f9_contattoprvid' alias='id' />
                </link-entity>
              </entity>
            </fetch>";

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_testataconsegnas?fetchXml={Uri.EscapeDataString(fetchXmlTestata)}")
                };
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TestataCollection>();

                var resultJson = await response.Content.ReadAsStringAsync();
                logger.LogInformation($"Risposta JSON: {resultJson}");
                if (result?.value?.Length > 0)
                {
                    var testata = result.value[0];

                    lavoratore = testata.nome;
                    id = testata.id;

                    // Log per verificare che il dato venga estratto
                    logger.LogInformation($"Lavoratore: {lavoratore}");

                    // Assicurati di ottenere i dati dalla risposta
                    codiceTestata = testata.cr4f9_idtestata;
                    dataConsegna = testata.cr4f9_dataconsegna;

                    // Log per verificare i dati
                    logger.LogInformation($"Testata ID: {codiceTestata}, Data Consegna: {dataConsegna}, Lavoratore: {lavoratore}");
                }
                else
                {
                    logger.LogWarning("Nessuna testata trovata per l'ID specificato.");
                }
            }
            else
            {
                logger.LogError($"Errore nel recupero dei dettagli della testata: {response.ReasonPhrase}");
            }
        }
        else
        {
            logger.LogError("Token non ottenuto.");
        }
    }

    private void GoBack()
    {
        // Utilizza la navigazione per tornare indietro nella cronologia
        Navigation.NavigateTo("javascript:history.back()");
    }

    // Carica le consegne DPI
    private async Task LoadConsegneDpi(Guid testataId)
    {
        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var fetchXmlConsegne = $@"
                <fetch>
                  <entity name='cr4f9_associazionedpialavoratore'>
                    <link-entity name='cr4f9_dpifisico' from='cr4f9_dpifisicoid' to='cr4f9_dpifisico' link-type='inner' alias='DPI'>
                      <attribute name='cr4f9_nomedeldispositivofisico' alias='nome' />
                    </link-entity>
                    <attribute name='cr4f9_datadiconsegna' />
                    <attribute name='cr4f9_quantita' />
                    <attribute name='cr4f9_numerodimatricola' />
                    <filter>
                      <condition attribute='cr4f9_riferimentotestata' operator='eq' value='{testataId}' />
                    </filter>
                  </entity>
                </fetch>";

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_associazionedpialavoratores?fetchXml={Uri.EscapeDataString(fetchXmlConsegne)}")
                };
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            var resultJson = await response.Content.ReadAsStringAsync();
            logger.LogInformation($"Risposta JSON: {resultJson}");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ConsegnaCollection>();
                if (result?.value?.Length > 0)
                {
                    consegneDpi = result.value.ToList();
                }
            }
            else
            {
                logger.LogError($"Errore nel recupero delle consegne DPI: {response.ReasonPhrase}");
            }
        }
        else
        {
            logger.LogError("Token non ottenuto.");
        }
    }

    private async Task OpenAddConsegneDialog()
    {
        var parameters = new DialogParameters
        {
            {"IdTestata", IdTestata},
            {"Lavoratore", id},
            {"DataConsegna",dataConsegna}
        };
        // Mostra il dialog e attende il risultato
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<AddConsegne>("Aggiungi Consegne DPI", parameters, options);
        var result = await dialog.Result;
    }

    public class Testata
    {
        public string cr4f9_idtestata { get; set; }
        public Guid? cr4f9_testataconsegnaid { get; set; }
        public DateTime cr4f9_dataconsegna { get; set; }
        public string nome { get; set; }
        public string id { get; set; }
    }

    public class Lavoratore
    {
        public string cr4f9_calcolonomeecognome { get; set; }
    }

    public class TestataCollection
    {
        public Testata[] value { get; set; }
    }

    public class ConsegnaDpi
    {
        public string nome { get; set; }
        public DateTime cr4f9_datadiconsegna { get; set; }
        public int cr4f9_quantita { get; set; }
        public string cr4f9_numerodimatricola { get; set; }
    }

    public class ConsegnaCollection
    {
        public ConsegnaDpi[] value { get; set; }
    }
}

<style>

    /* Contenitore a forma di cartella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px; /* Per spostare il contenuto sotto la linguetta */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Ombra per un effetto elevato */
        margin-bottom: 100px;
    }

    /* Linguetta in alto a sinistra */
    .folder-tab {
        position: absolute;
        top: -25px; /* Altezza sopra il contenitore */
        left: 20px; /* Regola la posizione più verso sinistra */
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Ombra della linguetta */
    }

    /* Stile per la sezione aggiuntiva */
    .folder-section {
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #ccc; /* Separatore tra le sezioni */
    }

    /* Stile per le informazioni del corso */
    .course-info {
        font-size: 1rem;
        color: #333;
        margin-bottom: 12px;
    }

    /* Pulsante di azione */
    button {
        font-size: 1rem;
        background-color: #E53935; /* Stesso colore della linguetta */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #D32F2F; /* Colore più scuro al passaggio del mouse */
    }

    /* Contenitore delle informazioni del corso */
    .course-info {
        display: flex;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 12px 0;
        padding: 8px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Stile generale per lo stato */
    .course-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Stile per stato positivo */
    .course-status.success {
        color: #2e7d32; /* Verde scuro */
        background-color: #e8f5e9; /* Verde chiaro */
        border-left: 4px solid #2e7d32;
        padding-left: 12px;
    }

    /* Stile per stato negativo */
    .course-status.failure {
        color: #d32f2f; /* Rosso scuro */
        background-color: #ffebee; /* Rosso chiaro */
        border-left: 4px solid #d32f2f;
        padding-left: 12px;
    }

    /* Icone */
    .course-status .mud-icon {
        font-size: 1.5rem;
    }

    .mud-tab-slider {
        position: absolute;
        background: #A9A9A9;
    }

    .mud-tab.mud-tab-active {
        color: currentColor;
    }

    /* Tabella intestazione */
    .mud-table-header {
        background-color: #E53935;
    }

    .mud-table-header .mud-table-cell {
        color: white !important;
        font-weight: bold; /* Grassetto per l'intestazione */
    }

    /* Righe della tabella */
    .mud-table-row {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le righe */
    }

    /* Celle della tabella (MudTd) */
    .mud-table .mud-td, .mud-table .mud-th {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le celle */
        padding: 8px; /* Padding per le celle */
        vertical-align: middle; /* Allinea verticalmente il contenuto */
        text-align: center; /* Centra il testo */
    }

    /* Colore dei link nella tabella */
    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: center;
    }

    /* Hover sui link */
    .mud-table .mud-link.mud-typography.mud-primary-text:hover {
        color: red !important;
        cursor: pointer;
    }

</style>