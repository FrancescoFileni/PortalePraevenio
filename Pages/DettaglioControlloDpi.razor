@page "/dettagliocontrollodpi/id={id}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Text.Json
@using Microsoft.Xrm.Sdk
@using Newtonsoft.Json
@using System.Text.Json.Serialization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<AddTestataConsegne> logger
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar


<button @onclick="GoBack">
    <i class="fas fa-arrow-left" style="font-size: 24px; color: white;"></i>
</button>

@if (!datiCaricati)
{
    <MudText>Caricamento in corso…</MudText>
}
else if (controlliCollection.value.Length == 0)
{
    <MudText>Non ci sono controlli DPI da mostrare.</MudText>
}
else
{
    <div class="folder-container">
        <div class="folder-tab">
            Controllo Dpi @controlliCollection.value[0].Matricola - @controlliCollection.value[0].Nome
        </div>

        <div class="folder-section">
            <div class="course-info">
                <MudTextField @bind-Value="controlliCollection.value[0].Nome" Label="Nome del dispositivo" Variant="Variant.Outlined" Disabled="true" />
            </div>

            <div class="course-info">
                <MudTextField @bind-Value="controlliCollection.value[0].Matricola" Label="Matricola del dispositivo" Variant="Variant.Outlined" Disabled="true" />
            </div>

            <div class="course-info">
                <MudDatePicker @bind-Date="controlliCollection.value[0].cr4f9_dataesecuzione" Label="Data di esecuzione" Variant="Variant.Outlined" Disabled="@(!editMode)" />
            </div>

            <div class="course-info">
                <MudDatePicker @bind-Date="controlliCollection.value[0].cr4f9_datascadenzacontrollo" Label="Data di scadenza" Variant="Variant.Outlined" Disabled="true" />
            </div>

            <div class="course-info">
                <MudTextField @bind-Value="controlliCollection.value[0].cr4f9_periodicitadelcontrolloinmesi" Label="Periodicità del controllo in mesi" Variant="Variant.Outlined" Disabled="@(!editMode)" />
            </div>

            <div class="course-info">
                <MudSelect T="bool"
                @bind-Value="controlliCollection.value[0].cr4f9_eseguito"
                Label="Stato esecuzione"
                Variant="Variant.Outlined"
                Disabled="@(!editMode)"
                Dense="true">
                    <MudSelectItem T="bool" Value="true">Eseguito</MudSelectItem>
                    <MudSelectItem T="bool" Value="false">Non eseguito</MudSelectItem>
                </MudSelect>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                <!-- Seleziona + Carica -->
                <div style="display: flex; gap: 12px;">
                    <MudFileUpload T="IBrowserFile"
                                   OnFilesChanged="HandleFileSelected"
                                   MaxFiles="1"
                                   Accept="application/pdf,application/octet-stream">
                        <ActivatorContent>
                            <MudButton StartIcon="@Icons.Material.Filled.CloudUpload"
                                       Color="Color.Secondary"
                                       Size="Size.Medium">
                                Seleziona allegato
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>

                    <MudButton StartIcon="@Icons.Material.Filled.UploadFile"
                               Color="Color.Success"
                               Size="Size.Medium"
                               Disabled="@(_fileSelezionato == null)"
                               @onclick="UploadAllegatoAsync">
                        Carica allegato
                    </MudButton>
                </div>

                <!-- Scarica -->
                <div>
                    <MudButton StartIcon="@Icons.Material.Filled.Download"
                               Color="Color.Primary"
                               Size="Size.Medium"
                               @onclick="DownloadAllegatoAsync">
                        Scarica allegato
                    </MudButton>
                </div>
            </div>
        </div>
        <button @onclick="ToggleEdit">
            @if (!editMode)
            {
                <span>MODIFICA</span>
            }
            else
            {
                <span>SALVA MODIFICHE</span>
            }
        </button>
    </div>
}


@code {
    [Parameter]
    public string id { get; set; }

    
    private string clienteId;
    private Guid? azienda;
    private string userName;
    private string userEmail;

    private bool editMode = false;

    private bool originalEseguito;
    private IBrowserFile _fileSelezionato;


    private ControlliCollection controlliCollection = new ControlliCollection();
    private bool datiCaricati = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation();
        await CaricaControllo();
    }

    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
        await CaricaClienteAssociato(userEmail);
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = System.Text.Json.JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new System.Text.Json.JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private async Task CaricaControllo()
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();

            var fetchXmlQuery = BuildControlloDpiFetchXml();

            if(tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");
                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_elencocontrollidpis?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}");

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
                request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                { 
                    var responseBody = await response.Content.ReadAsStringAsync();
                    logger.LogInformation("RESPONSE BODY: " + responseBody);

                    controlliCollection = await response.Content.ReadFromJsonAsync<ControlliCollection>();
                    datiCaricati = true;
                }
                else
                {
                    await DialogService.ShowMessageBox("ERRORE", "An error occured while fetching data");
                    logger.LogError($"Errore durante il recupero del controllo DPI: {response.ReasonPhrase}");
                }
            }
            else
            {
                await DialogService.ShowMessageBox("ERRORE", "There was a problem authenticating");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del controllo DPI: {ex.Message}");
        }
    }

    private string BuildControlloDpiFetchXml()
    {
        return $@"
                <fetch>
                  <entity name='cr4f9_elencocontrollidpi'>
                    <attribute name='cr4f9_dataesecuzione' />
                    <attribute name='cr4f9_datascadenzacontrollo' />
                    <attribute name='cr4f9_eseguito' />
                    <attribute name='cr4f9_periodicitadelcontrolloinmesi' />
                    <attribute name='cr4f9_dispositivoconsegnato' alias='cr4f9_dispositivoconsegnato'/>
                    <filter>
                      <condition attribute='cr4f9_elencocontrollidpiid' operator='eq' value='{id}' />
                    </filter>
                    <link-entity name='cr4f9_associazionedpialavoratore' from='cr4f9_associazionedpialavoratoreid' to='cr4f9_dispositivoconsegnato' link-type='inner' alias='dpi'>
                      <link-entity name='cr4f9_dpifisico' from='cr4f9_dpifisicoid' to='cr4f9_dpifisico' link-type='inner' alias='dpiFisico'>
                        <attribute name='cr4f9_nomedeldispositivofisico' alias='Nome'/>
                        <attribute name='cr4f9_matricoladispositivo' alias='Matricola'/>
                        <filter>
                          <condition attribute='cr4f9_cliente' operator='eq' value='{azienda}' />
                        </filter>
                      </link-entity>
                    </link-entity>
                  </entity>
                </fetch>";
    }

    private async Task ToggleEdit()
    {
        if (editMode)
        {
            await AggiornaControllo();
            editMode = !editMode;
        }
        editMode = !editMode;
    }

    private async Task AggiornaControllo()
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (!tokenResult.TryGetToken(out var token))
            {
                logger.LogError("Errore autenticazione durante l'aggiornamento.");
                return;
            }

            var client = ClientFactory.CreateClient("DataverseClient");
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

            var ctrl = controlliCollection.value[0];

            // 1) PATCH sul controllo esistente
            var updateDto = new
            {
                cr4f9_dataesecuzione = ctrl.cr4f9_dataesecuzione,
                cr4f9_datascadenzacontrollo = ctrl.cr4f9_datascadenzacontrollo,
                cr4f9_periodicitadelcontrolloinmesi = ctrl.cr4f9_periodicitadelcontrolloinmesi,
                cr4f9_eseguito = ctrl.cr4f9_eseguito
            };
            var patchReq = new HttpRequestMessage(HttpMethod.Patch,
                $"{client.BaseAddress}cr4f9_elencocontrollidpis({id})")
                {
                    Content = JsonContent.Create(updateDto)
                };
            var patchResp = await client.SendAsync(patchReq);
            if (!patchResp.IsSuccessStatusCode)
            {
                logger.LogError($"Patch fallita: {patchResp.ReasonPhrase}");
                return;
            }

            // 2) Se siamo passati da false → true
            if (!originalEseguito && ctrl.cr4f9_eseguito)
            {
                await CreaNuovoControlloAsync(ctrl);
            }

            // 3) Conferma e reset
            logger.LogInformation("Operazione completata.");
            DialogService.ShowMessageBox("Successo", "Modifiche salvate.");
            // aggiorna originalEseguito per future modifiche
            originalEseguito = ctrl.cr4f9_eseguito;
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione AggiornaControllo: {ex.Message}");
            DialogService.ShowMessageBox("Errore", ex.Message);
        }
    }


    private async Task CreaNuovoControlloAsync(Controllo oldCtrl)
    {

        DateTime baseDate = oldCtrl.cr4f9_dataesecuzione
                            ?? throw new InvalidOperationException("Data di esecuzione mancante.");
        DateTime nuovaScadenza = baseDate.AddMonths(oldCtrl.cr4f9_periodicitadelcontrolloinmesi);

        logger.LogInformation($"consegna dpi: {oldCtrl.cr4f9_dispositivoconsegnato}");

         var newDto = new Dictionary<string, object>
         {
             ["cr4f9_Dispositivoconsegnato@odata.bind"] = $"/cr4f9_associazionedpialavoratores({oldCtrl.cr4f9_dispositivoconsegnato})",
             ["cr4f9_dataesecuzione"] = null,
             ["cr4f9_datascadenzacontrollo"] = nuovaScadenza,
             ["cr4f9_periodicitadelcontrolloinmesi"] = oldCtrl.cr4f9_periodicitadelcontrolloinmesi,
             ["cr4f9_eseguito"] = false
         };

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (!tokenResult.TryGetToken(out var token))
        {
            logger.LogError("Errore di autenticazione durante la creazione del record.");
            return;
        }

        var client = ClientFactory.CreateClient("DataverseClient");
        client.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", token.Value);

        // Passa direttamente l'oggetto newDto, non la stringa già serializzata
        var request = new HttpRequestMessage(HttpMethod.Post,
            $"{client.BaseAddress}cr4f9_elencocontrollidpis")
            {
                Content = JsonContent.Create(newDto)
            };

        var response = await client.SendAsync(request);
        var responseBody = await response.Content.ReadAsStringAsync();
        logger.LogInformation("Response body: " + responseBody);

            logger.LogInformation("payload inviato: {@contenuto}");

            if (response.IsSuccessStatusCode)
            {
                oldCtrl = new();
            }
                else
                {
                    await DialogService.ShowMessageBox("ERRORE", $"Errore nell'invio: {response.ReasonPhrase}");
                    logger.LogError($"Errore API: {response.StatusCode} - {response.ReasonPhrase}");
                    logger.LogError($"Dettagli risposta: {responseBody}");
                }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("javascript:history.back()");
    }

    private Task HandleFileSelected(InputFileChangeEventArgs args)
    {
        _fileSelezionato = args.File;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task UploadAllegatoAsync()
    {
        if (_fileSelezionato == null) return;

        byte[] buffer;
        using (var ms = new MemoryStream())
        {
            await _fileSelezionato.OpenReadStream(maxAllowedSize: 10_000_000).CopyToAsync(ms);
            buffer = ms.ToArray();
        }

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (!tokenResult.TryGetToken(out var token)) return;

        var client = ClientFactory.CreateClient("DataverseClient");

        var url = $"{client.BaseAddress}cr4f9_elencocontrollidpis({id})/cr4f9_allegato?x-ms-file-name={_fileSelezionato.Name}";

        var request = new HttpRequestMessage(HttpMethod.Patch, url)
            {
                Content = new ByteArrayContent(buffer)
            };
        request.Content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");
        request.Headers.Add("OData-MaxVersion", "4.0");
        request.Headers.Add("OData-Version", "4.0");
        request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

        var response = await client.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            _fileSelezionato = null;
            Snackbar.Add("Allegato caricato con successo!", Severity.Success);
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
            logger.LogError($"Errore upload allegato: {errorContent}");
            Snackbar.Add("Errore durante il caricamento dell'allegato.", Severity.Error);
        }
    }


    private async Task DownloadAllegatoAsync()
    {
        var tokenRes = await TokenProvider.RequestAccessToken();
        if (!tokenRes.TryGetToken(out var token))
        {
            logger.LogError("Token non ottenuto per il download dell'allegato.");
            return;
        }

        var client = ClientFactory.CreateClient("DataverseClient");
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

        var downloadUrl = $"{client.BaseAddress}cr4f9_elencocontrollidpis({id})/cr4f9_allegato/$value";

        var resp = await client.GetAsync(downloadUrl);
        if (!resp.IsSuccessStatusCode)
        {
            logger.LogError($"Errore nel download dell'allegato: {resp.ReasonPhrase}");
            Snackbar.Add("Errore nel download dell'allegato.", Severity.Error);
            return;
        }

        var bytes = await resp.Content.ReadAsByteArrayAsync();
        if (bytes == null || bytes.Length == 0)
        {
            logger.LogError("Allegato vuoto o non recuperato correttamente.");
            return;
        }

        // rileva il mime dal contenuto
        string mime = "application/pdf"; // default (puoi implementare come nella pagina visita)
        string base64 = Convert.ToBase64String(bytes);

        await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", base64, mime, $"allegato.pdf");
    }

    public class Controllo
    {
        public DateTime? cr4f9_dataesecuzione { get; set; }
        public DateTime? cr4f9_datascadenzacontrollo { get; set; }
        public bool cr4f9_eseguito { get; set; }
        public int cr4f9_periodicitadelcontrolloinmesi { get; set; }

		[JsonPropertyName("_cr4f9_dispositivoconsegnato_value")]
        public Guid? cr4f9_dispositivoconsegnato { get; set; }

        public string Nome { get; set; }
        public string Matricola { get; set; }
    }

    public class ControlliCollection
    {
        public Controllo[] value { get; set; } = Array.Empty<Controllo>();
    }

}

<style>

    /* Contenitore a forma di cartella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px; /* Per spostare il contenuto sotto la linguetta */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Ombra per un effetto elevato */
        margin-bottom: 100px;
    }

    /* Linguetta in alto a sinistra */
    .folder-tab {
        position: absolute;
        top: -25px; /* Altezza sopra il contenitore */
        left: 20px; /* Regola la posizione più verso sinistra */
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Ombra della linguetta */
    }

    /* Stile per la sezione aggiuntiva */
    .folder-section {
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #ccc; /* Separatore tra le sezioni */
    }

    /* Stile per le informazioni del corso */
    .course-info {
        font-size: 1rem;
        color: #333;
        margin-bottom: 12px;
    }

    /* Pulsante di azione */
    button {
        font-size: 1rem;
        background-color: #E53935; /* Stesso colore della linguetta */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #D32F2F; /* Colore più scuro al passaggio del mouse */
    }

    /* Contenitore delle informazioni del corso */
    .course-info {
        display: flex;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 12px 0;
        padding: 8px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Stile generale per lo stato */
    .course-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Stile per stato positivo */
    .course-status.success {
        color: #2e7d32; /* Verde scuro */
        background-color: #e8f5e9; /* Verde chiaro */
        border-left: 4px solid #2e7d32;
        padding-left: 12px;
    }

    /* Stile per stato negativo */
    .course-status.failure {
        color: #d32f2f; /* Rosso scuro */
        background-color: #ffebee; /* Rosso chiaro */
        border-left: 4px solid #d32f2f;
        padding-left: 12px;
    }

    /* Icone */
    .course-status .mud-icon {
        font-size: 1.5rem;
    }

    .mud-tab-slider {
        position: absolute;
        background: #A9A9A9;
    }

    .mud-tab.mud-tab-active {
        color: currentColor;
    }

    /* Tabella intestazione */
    .mud-table-header {
        background-color: #E53935;
    }

    .mud-table-header .mud-table-cell {
        color: white !important;
        font-weight: bold; /* Grassetto per l'intestazione */
    }

    /* Righe della tabella */
    .mud-table-row {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le righe */
    }

    /* Celle della tabella (MudTd) */
    .mud-table .mud-td, .mud-table .mud-th {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le celle */
        padding: 8px; /* Padding per le celle */
        vertical-align: middle; /* Allinea verticalmente il contenuto */
        text-align: center; /* Centra il testo */
    }

    /* Colore dei link nella tabella */
    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: center;
    }

    /* Hover sui link */
    .mud-table .mud-link.mud-typography.mud-primary-text:hover {
        color: red !important;
        cursor: pointer;
    }

    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: left;
        vertical-align: central;
        margin-top: 8px;
        margin-left: 16px;
    }

    /* Classe per uniformare l'aspetto degli input */
    .white-input input,
    .white-input .mud-input-slot {
        background-color: #ffffff !important;
        font-size: 0.8rem !important;
    }

    .date-filter-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
</style>
