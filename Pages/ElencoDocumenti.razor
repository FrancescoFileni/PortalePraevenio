@page "/elencotestatedocumenti"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Microsoft.Extensions.Logging
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@inject ILogger<ElencoDocumenti> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject IDialogService DialogService

<link href="css/testate-documenti.css?v=1" rel="stylesheet" />

<AuthorizeView>
	<Authorized>

		<!-- TOOLBAR -->
		<MudPaper Class="toolbar" Elevation="1">
			<div class="toolbar-left">
				<MudText Typo="Typo.h5" Class="page-title">TESTATE DOCUMENTI</MudText>
			</div>

			<div class="toolbar-right">
				<MudButton Variant="Variant.Filled"
						   StartIcon="@Icons.Material.Filled.Add"
						   Color="Color.Error"
						   Class="action-btn"
						   OnClick="OpenDialogAsync">
					Nuova
				</MudButton>
			</div>
		</MudPaper>

		@if (testate != null)
		{
			<div class="folder-container">
				<div class="folder-tab">Elenco Testate Documenti</div>

				<MudTable T="TestataDocumenti"
						  Items="testate.value"
						  Dense="true"
						  Hover="true"
						  Class="modern-table">

					<HeaderContent>
						<MudTh>
							<MudTableSortLabel InitialDirection="SortDirection.Ascending"
											   SortBy="new Func<TestataDocumenti, object>(x => x.cr4f9_name)">
								Id
							</MudTableSortLabel>
						</MudTh>
						<MudTh>
							<MudTableSortLabel InitialDirection="SortDirection.Ascending"
											   SortBy="new Func<TestataDocumenti, object>(x => x.cr4f9_nome)">
								Nome
							</MudTableSortLabel>
						</MudTh>
						<MudTh>
							<MudTableSortLabel InitialDirection="SortDirection.Ascending"
											   SortBy="new Func<TestataDocumenti, object>(x => x.cr4f9_email)">
								Email
							</MudTableSortLabel>
						</MudTh>
						<MudTh>
							<MudTableSortLabel InitialDirection="SortDirection.Ascending"
											   SortBy="new Func<TestataDocumenti, object>(x => x.cr4f9_note)">
								Note
							</MudTableSortLabel>
						</MudTh>
					</HeaderContent>

					<RowTemplate Context="testata">
						<MudTd DataLabel="Id">
							<MudLink Class="name-link"
									 Href="@($"/dettagliotestatadocumenti/id={testata.cr4f9_testatadocumentoclienteid}&numero={ExtractNumber(testata.cr4f9_name)}")">
								@ExtractNumber(testata.cr4f9_name)
							</MudLink>
						</MudTd>

						<MudTd DataLabel="Nome">@testata.cr4f9_nome</MudTd>
						<MudTd DataLabel="Email">@testata.cr4f9_email</MudTd>
						<MudTd DataLabel="Note">@testata.cr4f9_note</MudTd>
					</RowTemplate>

					<PagerContent>
						<MudTablePager PageSizeOptions="new int[]{10, 20}" />
					</PagerContent>
				</MudTable>
			</div>
		}
		else
		{
			<p><em>@message</em></p>
		}
	</Authorized>

	<NotAuthorized>
		<h3>Authentication Failure!</h3>
		<p>You're not signed in.</p>
	</NotAuthorized>
</AuthorizeView>

@code {
	private TestataCollection testate;
	private string message = "Loading...";
	private string userName;
	private string userEmail;
	private string clienteId;
	private Guid? azienda;
	private string fetchXmlQuery;

	protected override async Task OnInitializedAsync()
	{
		await LoadUserInformation();

		if (string.IsNullOrEmpty(clienteId))
		{
			message = "Cliente non trovato.";
			return;
		}

		fetchXmlQuery = $@"
            <fetch>
              <entity name='cr4f9_testatadocumentocliente'>
                <attribute name='cr4f9_testatadocumentoclienteid' />
                <attribute name='cr4f9_name' />
                <attribute name='cr4f9_nome' />
                <attribute name='cr4f9_email' />
                <attribute name='cr4f9_note' />
                <filter>
                  <condition attribute='cr4f9_cliente' operator='eq' value='{azienda}' />
                </filter>
              </entity>
            </fetch>";

		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");
			var request = new HttpRequestMessage(HttpMethod.Get,
				$"{client.BaseAddress}cr4f9_testatadocumentoclientes?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}");

			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
				testate = await response.Content.ReadFromJsonAsync<TestataCollection>();
			else
			{
				message = "An error occured while fetching data.";
				logger.LogError($"Error fetching data: {response.ReasonPhrase}");
			}
		}
		else message = "There was a problem authenticating";
	}

	private async Task LoadUserInformation()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			userName = user.Identity.Name;
			userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;
			logger.LogInformation("USER EMAIL: " + userEmail);
			await CaricaClienteAssociato(userEmail);
		}
	}

	private Task OpenDialogAsync()
	{
		var options = new DialogOptions { CloseOnEscapeKey = true };
		return DialogService.ShowAsync<AddTestataDocumenti>("Simple Dialog", options);
	}

	private string ExtractNumber(string nome)
	{
		var match = System.Text.RegularExpressions.Regex.Match(nome ?? "", @"-(\d+)$");
		return match.Success ? match.Groups[1].Value : string.Empty;
	}

	private async Task CaricaClienteAssociato(string email)
	{
		try
		{
			var tokenResult = await TokenProvider.RequestAccessToken();
			if (!tokenResult.TryGetToken(out var token)) return;

			var client = ClientFactory.CreateClient("DataverseClient");
			var fetchXml = BuildAziendaFetchXml(email);

			var request = new HttpRequestMessage(HttpMethod.Get,
				$"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

			var response = await client.SendAsync(request);
			if (!response.IsSuccessStatusCode) return;

			var responseBody = await response.Content.ReadAsStringAsync();
			var jsonDocument = System.Text.Json.JsonDocument.Parse(responseBody);
			var entities = jsonDocument.RootElement.GetProperty("value");

			if (entities.GetArrayLength() == 0) return;

			var entity = entities[0];
			if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
			{
				clienteId = newClienteProperty.GetString();
				azienda = newClienteProperty.GetGuid();
			}
		}
		catch (Exception ex)
		{
			logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
		}
	}

	private string BuildAziendaFetchXml(string email) => $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";

	public class TestataDocumenti
	{
		public Guid? cr4f9_testatadocumentoclienteid { get; set; }
		public string cr4f9_name { get; set; }
		public string cr4f9_nome { get; set; }
		public string cr4f9_email { get; set; }
		public string cr4f9_note { get; set; }
	}

	public class TestataCollection
	{
		public TestataDocumenti[] value { get; set; }
	}
}
