@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Newtonsoft.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<AddFile> logger
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudDialog Class="custom-dialog-red-gray" MaxWidth="600px">
    <TitleContent>
        <MudStack Direction="Row" Align="Center" JustifyContent="Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.FileUpload" Color="Color.Error" />
            <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
                Aggiorna File
            </MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        <MudPaper Class="content-area-red-gray" Elevation="1" Style="padding: 16px;">
            <MudForm @ref="form" Valis="isFormValid">
                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudDatePicker @bind-Date="dataScadenza" Label="Data Scadenza" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField T="string" @bind-Value="noteFile" Label="Note File" Variant="Variant.Outlined" Lines="3" FullWidth />
                    </MudItem>

                    <MudItem xs="12" class="d-flex justify-content-center">
                        <MudFileUpload T="IBrowserFile" OnFilesChanged="HandleFileSelected" Accept="*/*">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.CloudUpload" Style="height: 40px;">
                                    Carica File
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <div class="d-flex justify-content-end" style="gap: 8px;">
            <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
                Annulla
            </MudButton>
            <MudButton OnClick="Submit" Variant="Variant.Filled" Color="Color.Error">
                Conferma
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public string id { get; set; } = string.Empty;

    [Parameter]
	public string IdCartella { get; set; } = string.Empty;

    [Inject]
    public IDialogService DialogService { get; set; }

    
    private bool datiCaricati = false;
    private bool isLoading = false;
    private MudForm form;
    private string idFileCreato;
    private string noteFile;
    private DateTime? dataScadenza;

    private IBrowserFile? fileSelezionato;
    private FileCollection fileCollection = new FileCollection();

    protected override async Task OnInitializedAsync()
    {
        await CaricaFile();
    }


    private async Task CaricaFile()
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();

            var fetchXmlQuery = BuildFileFetchXml();

            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");
                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_filedocumentos?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}");

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
                request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();
                    logger.LogInformation("RESPONSE BODY: " + responseBody);

                    fileCollection = await response.Content.ReadFromJsonAsync<FileCollection>();
                    datiCaricati = true;
                }
                else
                {
                    await DialogService.ShowMessageBox("ERRORE", "An error occured while fetching data.");
                    logger.LogError($"Error fetching data: {response.ReasonPhrase}");
                }
            }
            else
            {
                await DialogService.ShowMessageBox("ERRORE", "There was a problem authenticating");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del file: {ex.Message}");
        }
    }

    private string BuildFileFetchXml()
    {
        return $@"
                <fetch>
                  <entity name='cr4f9_filedocumento'>
                    <attribute name='cr4f9_filedocumentoid' />
                    <attribute name='cr4f9_name' />
                    <attribute name='cr4f9_nome' />
                    <attribute name='cr4f9_file' />
                    <attribute name='cr4f9_notedocumento' />
                    <attribute name='createdon' />
                    <attribute name='cr4f9_datascadenza' />
                    <attribute name='cr4f9_invigore' />
                    <attribute name='cr4f9_cartella' />
                    <filter>
                      <condition attribute='cr4f9_filedocumentoid' operator='eq' value='{id}' />
                    </filter>
                    <link-entity name='cr4f9_cartelladocumenti' from='cr4f9_cartelladocumentiid' to='cr4f9_cartella' link-type='inner' alias='Cartella'>
                      <attribute name='cr4f9_name' alias='NomeCartella'/>
                    </link-entity>
                  </entity>
                </fetch>";
    }

    private async Task CreaRecordFile(FileRecord file)
    {
        try
        {
            isLoading = true;

            var dizionario = new Dictionary<string, object>
            {
                {"cr4f9_Cartella@odata.bind", $"/cr4f9_cartelladocumentis({file.Cartella})"},
                {"cr4f9_notedocumento", file.Note},
                {"cr4f9_nome", file.Nome},
                {"cr4f9_datascadenza", file.DataScadenza}
            };

            string contenuto = JsonConvert.SerializeObject(dizionario, Formatting.Indented);
            logger.LogInformation($"Contenuto: {contenuto}");

            await form.Validate();
            if (!form.IsValid)
            {
                Snackbar.Add("Please fill in all required fields.", Severity.Error);
                return;
            }

            var tokenResult = await TokenProvider.RequestAccessToken();
            if(tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var request = new HttpRequestMessage(HttpMethod.Post, "cr4f9_filedocumentos")
                    {
                        Content = JsonContent.Create(dizionario)
                    };

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);
                var responseBody = await response.Content.ReadAsStringAsync();
                logger.LogInformation("Payload inviato: {Payload}", contenuto);

                if(response.IsSuccessStatusCode)
                {
                    if (response.Headers.TryGetValues("OData-EntityId", out var entityIdValues))
                    {
                        var entityId = entityIdValues.FirstOrDefault();
                        if (entityId != null)
                        {
                            idFileCreato = entityId.Split('(').LastOrDefault()?.TrimEnd(')');
                            logger.LogInformation($"Record del file creato con successo. ID: {idFileCreato}");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun ID trovato nell'header della risposta.");
                    }
                }
                else
                {
                    await DialogService.ShowMessageBox("ERRORE", $"Errore nell'invio: {response.ReasonPhrase}");
                    logger.LogError("Error Api: {StatusCode} - {ReasonPhrase}", response.StatusCode, response.ReasonPhrase);
                    logger.LogError("Dettagli risposta: {ResponseBody}", responseBody);
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante la creazione del record.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError("Errore durante la creazione del record del file: {Error}", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CaricaFile(string idFileCreato, IBrowserFile file)
    {
        try
        {
            // Imposta un limite di 10 MB per il file
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            byte[] fileContent = memoryStream.ToArray();

            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                logger.LogInformation($"Token ottenuto: {token.Value}");

                string fileName = file.Name;
                string url = $"{client.BaseAddress}cr4f9_filedocumentos({idFileCreato})/cr4f9_file?x-ms-file-name={Uri.EscapeDataString(fileName)}";
                logger.LogInformation($"URL per il caricamento: {url}");

                var request = new HttpRequestMessage(HttpMethod.Patch, url)
                    {
                        Content = new ByteArrayContent(fileContent)
                    };

                // Forza il Content-Type a application/octet-stream
                request.Content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");

                request.Headers.Add("OData-MaxVersion", "4.0");
                request.Headers.Add("OData-Version", "4.0");
                request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                HttpResponseMessage response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    logger.LogInformation("File caricato con successo.");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    logger.LogError("Errore durante il caricamento del file: {StatusCode}. Dettagli: {ErrorContent}", response.StatusCode, errorContent);
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del file.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError("Eccezione durante il caricamento del file: {Error}", ex.Message);
        }
    }

    private async Task Aggiorna()
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (!tokenResult.TryGetToken(out var token))
            {
                logger.LogError("Errore autenticazione durante l'aggiornamento del file.");
                Snackbar.Add("Impossibile autenticarsi per l'aggiornamento.", Severity.Error);
                return;
            }

            // Prendo il primo (e unico) file caricato in fileCollection
            var file = fileCollection.value[0];
            var fileId = file.cr4f9_filedocumentoid;
            if (fileId == null)
            {
                logger.LogError("ID del file non trovato in fileCollection.");
                Snackbar.Add("ID del file mancante, impossibile aggiornare.", Severity.Error);
                return;
            }

            // Preparo il payload per aggiornare solo cr4f9_invigore
            var aggiornamento = new Dictionary<string, object>
        {
            { "cr4f9_invigore", false }
        };

            var client = ClientFactory.CreateClient("DataverseClient");
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

            // URL di patch: cr4f9_filedocumentos(<GUID>)
            var request = new HttpRequestMessage(HttpMethod.Patch,
                $"cr4f9_filedocumentos({fileId})")
                {
                    Content = JsonContent.Create(aggiornamento)
                };
            request.Headers.Add("OData-MaxVersion", "4.0");
            request.Headers.Add("OData-Version", "4.0");
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                logger.LogInformation($"File {fileId} aggiornato: cr4f9_invigore = false");
                Snackbar.Add("Campo in vigore disattivato con successo.", Severity.Success);
                // Qui puoi eventualmente chiudere il dialog e ricaricare la pagina
                MudDialog.Close(DialogResult.Ok(true));
                Navigation.NavigateTo($"/dettagliofile/id={id}", forceLoad: true);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                logger.LogError("Errore aggiornamento: {StatusCode} {Error}", response.StatusCode, error);
                Snackbar.Add("Errore durante l'aggiornamento.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            logger.LogError("Eccezione in Aggiorna: {Error}", ex.Message);
            Snackbar.Add("Si è verificato un errore.", Severity.Error);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();
        fileSelezionato = files?.FirstOrDefault();

        if (fileSelezionato != null)
        {
            logger.LogInformation($"File selezionato: {fileSelezionato.Name}, Dimensione: {fileSelezionato.Size} bytes");
            Snackbar.Add("File correttamente caricato", Severity.Success);
        }
        else
        {
            logger.LogWarning("Nessun file selezionato.");
        }

        await Task.CompletedTask;
    }

    private async Task Submit()
    {
        // 1) Verifica che i dati caricati siano disponibili
        if (fileCollection?.value == null || !fileCollection.value.Any())
        {
            Snackbar.Add("I dati non sono ancora caricati, riprova più tardi.", Severity.Error);
            return;
        }

        // 2) Prepara il nuovo record
        var primoFile = fileCollection.value[0];
		logger.LogWarning($"ID cartella: {IdCartella}");
        var fileRecord = new FileRecord
            {
                Cartella = IdCartella,
                Nome = primoFile.cr4f9_nome,
                Note = noteFile,
                DataScadenza = dataScadenza
            };

        // 3) Crea il nuovo record
        await CreaRecordFile(fileRecord);

        // 4) Controlla se l'ID del record è stato restituito
        if (string.IsNullOrEmpty(idFileCreato))
        {
            logger.LogWarning("ID file non valido. Assicurati che la creazione del record sia riuscita.");
            await DialogService.ShowMessageBox("ERRORE", "Record file non inserito", yesText: "Chiudi");
            return;
        }

        // 5) Se l'utente ha selezionato un file, caricalo sul nuovo record
        if (fileSelezionato != null)
        {
            await CaricaFile(idFileCreato, fileSelezionato);
            await DialogService.ShowMessageBox("INFO", "File caricato con successo", yesText: "Chiudi");
        }
        else
        {
            logger.LogWarning("Nessun file selezionato per il caricamento.");
            await DialogService.ShowMessageBox("INFO", "Record inserito con successo senza file", yesText: "Chiudi");
        }

        // 6) Disattiva il flag 'in vigore' sul vecchio record
        await Aggiorna();

        // 7) Chiudi dialog e naviga alla pagina di dettaglio
        MudDialog.Close(DialogResult.Ok(true));
        Navigation.NavigateTo($"/dettagliofile/id={id}&cartella={IdCartella}", forceLoad: true);
    }


    private void Cancel() => MudDialog.Cancel();

    public class File
    {
        public Guid? cr4f9_filedocumentoid { get; set; }
        public string cr4f9_name { get; set; }
        public string cr4f9_nome { get; set; }
        public string cr4f9_file { get; set; }
        public string cr4f9_notedocumento { get; set; }
        public DateTime? createdon { get; set; }
        public DateTime? cr4f9_datascadenza { get; set; }
        public bool cr4f9_invigore { get; set; }
		public Guid? cr4f9_cartella { get; set; }
        public string NomeCartella { get; set; }
    }

    public class FileRecord
    {
        public string Cartella { get; set; }
        public string Nome { get; set; }
        public string Note { get; set; }
        public DateTime? DataScadenza { get; set; }
    }

    public class FileCollection
    {
        public File[] value { get; set; }
    }

}


