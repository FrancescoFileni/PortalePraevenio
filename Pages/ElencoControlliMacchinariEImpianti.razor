@page "/elencocontrollimacchinarieimpianti"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using System.Text.Json
@using System.Text
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<ElencoMacchinariEImpianti> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService

<link href="css/controlli-macchinari.css?v=1" rel="stylesheet" />

<AuthorizeView>
	<Authorized>

		<!-- TOOLBAR -->
		<MudPaper Class="toolbar" Elevation="1">
			<div class="toolbar-left">
				<MudText Typo="Typo.h5" Class="page-title">CONTROLLI MACCHINARI E IMPIANTI</MudText>
			</div>

			<div class="toolbar-right">
				<MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
							   Color="Color.Error"
							   OnClick="ToggleFilters"
							   Class="filter-btn" />
			</div>
		</MudPaper>

		<!-- FILTRI -->
		<MudCollapse Expanded="@showFilters">
			<MudPaper Class="filters-panel" Elevation="0">
				<MudGrid GutterSize="8" Class="filters-grid">
					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Sede</MudText>
						<MudTextField @bind-Value="searchNomeSede"
									  Placeholder="Cerca per sede"
									  Variant="Variant.Outlined"
									  Class="white-input"
									  Immediate="true" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Impianto / Macchinario</MudText>
						<MudTextField @bind-Value="searchImpianto"
									  Placeholder="Cerca per impianto"
									  Variant="Variant.Outlined"
									  Class="white-input"
									  Immediate="true" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Tipo controllo</MudText>
						<MudTextField @bind-Value="searchTipo"
									  Placeholder="Cerca per tipo controllo"
									  Variant="Variant.Outlined"
									  Class="white-input"
									  Immediate="true" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Scadenza (Da)</MudText>
						<MudDatePicker @bind-Date="scadFrom"
									   Label="Da"
									   Variant="Variant.Outlined"
									   Class="white-input"
									   Clearable="true" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Scadenza (A)</MudText>
						<MudDatePicker @bind-Date="scadTo"
									   Label="A"
									   Variant="Variant.Outlined"
									   Class="white-input"
									   Clearable="true" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="filter-label">Stato</MudText>
						<MudSelect T="bool?" @bind-Value="filterEseguito"
								   Variant="Variant.Outlined"
								   Class="white-input"
								   Dense="true">
							<MudSelectItem Value="@((bool?)null)">Tutti</MudSelectItem>
							<MudSelectItem Value="@((bool?)true)">Eseguito</MudSelectItem>
							<MudSelectItem Value="@((bool?)false)">Da eseguire</MudSelectItem>
						</MudSelect>
					</MudItem>
				</MudGrid>

				<div class="filters-actions">
					<MudButton Variant="Variant.Outlined"
							   Color="Color.Primary"
							   StartIcon="@Icons.Material.Filled.Refresh"
							   OnClick="ResetFilters">
						Ripristina
					</MudButton>
				</div>
			</MudPaper>
		</MudCollapse>

		@if (controlliCollection?.value?.Any() ?? false)
		{
			@if (controlliDaEseguire.Any())
			{
				<div class="folder-container">
					<div class="folder-tab">Controlli Da Eseguire</div>

					<MudTable T="Controllo"
							  Items="controlliDaEseguire"
							  Dense="true"
							  Hover="true"
							  Filter="ToggleFunc"
							  FilterMode="TableFilterMode.Simple"
							  RowStyleFunc="@( (c, _) => GetRowStyle(c) )"
							  Class="modern-table"
							  FilteredItems="Filtered"
							  FilteredItemsChanged="OnFilteredChanged">


						<HeaderContent>
							<MudTh>Nome Sede</MudTh>
							<MudTh>Impianto</MudTh>
							<MudTh>Tipo di Controllo</MudTh>
							<MudTh>Data di Scadenza</MudTh>
							<MudTh>Stato</MudTh>
							<MudTh></MudTh>
						</HeaderContent>

						<RowTemplate Context="controllo">
							<MudTd DataLabel="Sede">@controllo.NomeSede</MudTd>
							<MudTd DataLabel="Impianto">@controllo.Impianto</MudTd>
							<MudTd DataLabel="Tipo">@controllo.TipoControllo</MudTd>
							<MudTd DataLabel="Scadenza">
								@(controllo.cr4f9_datadiscadenza?.ToString("dd/MM/yyyy") ?? "")
							</MudTd>
							<MudTd DataLabel="Stato">
								<span style="color:@GetEseguitoColor(controllo)">Da Eseguire</span>
							</MudTd>
							<MudTd DataLabel="Dettaglio">
								<MudLink Href="@($"/dettagliocontrollomacchinario/id={controllo.cr4f9_elencocontrollimacchinarieimpiantiid}")"
										 Class="icon-link">
									<MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Medium" />
								</MudLink>
							</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>

					<div class="color-legend">
						<span>Giorni mancanti alla scadenza:</span>
						<div class="legend-item bg-red-light"></div><span>Scaduto</span>
						<div class="legend-item bg-orange-light"></div><span>0–6 giorni</span>
						<div class="legend-item bg-yellow-light"></div><span>7–30 giorni</span>
						<div class="legend-item bg-green-light"></div><span>&gt; 30 giorni</span>
					</div>
				</div>
			}

			@if (controlliEseguiti.Any())
			{
				<div class="folder-container mt-8">
					<div class="folder-tab">Controlli Eseguiti</div>

					<MudTable T="Controllo"
							  Items="controlliEseguiti"
							  Dense="true"
							  Hover="true"
							  Filter="ToggleFunc"
							  FilterMode="TableFilterMode.Simple"
							  Class="modern-table"
							  FilteredItems="Filtered"
							  FilteredItemsChanged="OnFilteredChanged">

						<HeaderContent>
							<MudTh>Nome Sede</MudTh>
							<MudTh>Impianto</MudTh>
							<MudTh>Tipo di Controllo</MudTh>
							<MudTh>Data di Esecuzione</MudTh>
							<MudTh>Stato</MudTh>
							<MudTh></MudTh>
						</HeaderContent>

						<RowTemplate Context="controllo">
							<MudTd DataLabel="Sede">@controllo.NomeSede</MudTd>
							<MudTd DataLabel="Impianto">@controllo.Impianto</MudTd>
							<MudTd DataLabel="Tipo">@controllo.TipoControllo</MudTd>
							<MudTd DataLabel="Esecuzione">
								@(controllo.cr4f9_datadiesecuzione?.ToString("dd/MM/yyyy") ?? "")
							</MudTd>
							<MudTd DataLabel="Stato"><span class="status-ok">Eseguito</span></MudTd>
							<MudTd DataLabel="Dettaglio">
								<MudLink Href="@($"/dettagliocontrollomacchinario/id={controllo.cr4f9_elencocontrollimacchinarieimpiantiid}")"
										 Class="icon-link">
									<MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Medium" />
								</MudLink>
							</MudTd>
						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>
				</div>
			}
		}
		else
		{
			<MudProgressCircular Color="Color.Default" Indeterminate="true" />
		}

	</Authorized>
</AuthorizeView>

@code {
	private string userName;
	private string userEmail;
	private Guid? azienda;
	private string clienteId;

	private string fetchXmlQuery;
	private string message = "Loading...";

	private ControlliCollection controlliCollection = new ControlliCollection();

	private List<Controllo> controlliEseguiti = new();
	private List<Controllo> controlliDaEseguire = new();

	private bool showFilters = false;
	private string searchNomeSede = "";
	private string searchImpianto = "";
	private string searchTipo = "";
	private bool? filterEseguito = null;
	private DateTime? scadFrom;
	private DateTime? scadTo;

	// utile se vuoi log o debug (opzionale)
	private IEnumerable<Controllo> Filtered { get; set; } = Array.Empty<Controllo>();
	private void OnFilteredChanged(IEnumerable<Controllo> items) => Filtered = items;

	protected override async Task OnInitializedAsync()
	{
		await LoadUserInformation();

		fetchXmlQuery = BuildFetchXmlControlli();
		if (string.IsNullOrWhiteSpace(fetchXmlQuery))
		{
			message = "Cliente non determinato: impossibile costruire la query.";
			return;
		}

		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");
			var requestUrl = $"{client.BaseAddress}cr4f9_elencocontrollimacchinarieimpiantis?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}";
			var request = new HttpRequestMessage(HttpMethod.Get, requestUrl);

			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
			{
				controlliCollection = await response.Content.ReadFromJsonAsync<ControlliCollection>();

				if (controlliCollection?.value != null)
					ApplyFilters();
			}
			else
			{
				message = "An error occured while fetching data.";
				logger.LogError($"Error fetching data: {response.ReasonPhrase}");
			}
		}
		else
		{
			message = "There was a problem authenticating";
		}
	}

	private async Task LoadUserInformation()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			userName = user.Identity.Name;
			userEmail = user.Claims.FirstOrDefault(c => c.Type == "preferred_username")?.Value;
			logger.LogInformation("USER EMAIL: " + userEmail);
		}
		else
		{
			message = "User not authenticated.";
		}

		await CaricaClienteAssociato(userEmail);
	}

	private async Task CaricaClienteAssociato(string email)
	{
		try
		{
			var tokenResult = await TokenProvider.RequestAccessToken();
			if (!tokenResult.TryGetToken(out var token))
				return;

			var client = ClientFactory.CreateClient("DataverseClient");
			var fetchXml = BuildFetchXml(email);

			var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

			var response = await client.SendAsync(request);
			if (!response.IsSuccessStatusCode)
				return;

			var responseBody = await response.Content.ReadAsStringAsync();
			var jsonDocument = JsonDocument.Parse(responseBody);
			var entities = jsonDocument.RootElement.GetProperty("value");

			if (entities.GetArrayLength() == 0)
				return;

			var entity = entities[0];
			if (entity.TryGetProperty("_new_cliente_value", out var newClientProperty))
			{
				clienteId = newClientProperty.GetString();
				if (Guid.TryParse(clienteId, out var g))
					azienda = g;
			}
		}
		catch (Exception ex)
		{
			logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
		}
	}

	private string BuildFetchXml(string email) => $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";

	private string BuildFetchXmlControlli()
	{
		if (azienda == null) return string.Empty;

		return $@"
        <fetch>
          <entity name='cr4f9_elencocontrollimacchinarieimpianti'>
            <attribute name='cr4f9_elencocontrollimacchinarieimpiantiid' />
            <attribute name='cr4f9_datadiesecuzione' />
            <attribute name='cr4f9_datadiscadenza' />
            <attribute name='cr4f9_eseguito' />

            <link-entity name='cr4f9_macchinarioimpiantofisico' from='cr4f9_macchinarioimpiantofisicoid' to='cr4f9_macchinariooimpianto' link-type='inner' alias='Macchinario'>
              <attribute name='cr4f9_nome' alias='Impianto' />
              <link-entity name='new_sedeprv' from='new_sedeprvid' to='cr4f9_sede' link-type='inner' alias='Sede'>
                <attribute name='new_localita' alias='NomeSede'/>
                <filter>
                  <condition attribute='new_cliente' operator='eq' value='{azienda}' />
                </filter>
              </link-entity>
            </link-entity>

            <link-entity name='cr4f9_tipologiedicontrollo' from='cr4f9_tipologiedicontrolloid' to='cr4f9_controllo' link-type='inner' alias='Controllo'>
              <attribute name='cr4f9_tipocontrollo' alias='TipoControllo'/>
            </link-entity>

          </entity>
        </fetch>";
	}

	private void ToggleFilters() => showFilters = !showFilters;

	private void ResetFilters()
	{
		searchNomeSede = "";
		searchImpianto = "";
		searchTipo = "";
		filterEseguito = null;
		scadFrom = null;
		scadTo = null;
	}

	private void ApplyFilters()
	{
		var filtered = controlliCollection.value.Where(ToggleFunc).ToList();
		controlliEseguiti = filtered.Where(c => c.cr4f9_eseguito == true).ToList();
		controlliDaEseguire = filtered.Where(c => c.cr4f9_eseguito != true).ToList();
	}

	private bool ToggleFunc(Controllo c)
	{
		bool ok = true;

		if (!string.IsNullOrWhiteSpace(searchNomeSede))
			ok &= c.NomeSede?.Contains(searchNomeSede, StringComparison.OrdinalIgnoreCase) ?? false;

		if (!string.IsNullOrWhiteSpace(searchImpianto))
			ok &= c.Impianto?.Contains(searchImpianto, StringComparison.OrdinalIgnoreCase) ?? false;

		if (!string.IsNullOrWhiteSpace(searchTipo))
			ok &= c.TipoControllo?.Contains(searchTipo, StringComparison.OrdinalIgnoreCase) ?? false;

		if (filterEseguito.HasValue)
			ok &= (c.cr4f9_eseguito == filterEseguito.Value);

		if (scadFrom.HasValue)
			ok &= (c.cr4f9_datadiscadenza.HasValue && c.cr4f9_datadiscadenza.Value.Date >= scadFrom.Value.Date);

		if (scadTo.HasValue)
			ok &= (c.cr4f9_datadiscadenza.HasValue && c.cr4f9_datadiscadenza.Value.Date <= scadTo.Value.Date);

		return ok;
	}

	private string GetRowClass(Controllo controllo)
	{
		if (controllo?.cr4f9_datadiscadenza == null) return string.Empty;

		var giorni = (controllo.cr4f9_datadiscadenza.Value.Date - DateTime.Today).TotalDays;

		if (giorni > 30) return "bg-green-light";
		if (giorni >= 7) return "bg-yellow-light";
		if (giorni >= 0) return "bg-orange-light";
		return "bg-red-light";
	}

	private string GetEseguitoColor(Controllo controllo)
	{
		if (controllo?.cr4f9_datadiscadenza == null) return "black";
		var giorni = (controllo.cr4f9_datadiscadenza.Value.Date - DateTime.Today).TotalDays;
		return giorni > 30 ? "black" : "red";
	}

	private string GetRowStyle(Controllo controllo)
	{
		if (controllo?.cr4f9_datadiscadenza == null)
			return string.Empty;

		var giorni = (controllo.cr4f9_datadiscadenza.Value.Date - DateTime.Today).TotalDays;

		if (giorni > 30) return "background-color: #e0e0e0;";
		if (giorni >= 7) return "background-color: #ffffcc;";
		if (giorni >= 0) return "background-color: #ffe5b4;";
		return "background-color: #ffcccc;";
	}


	public class Controllo
	{
		public string cr4f9_elencocontrollimacchinarieimpiantiid { get; set; }
		public DateTime? cr4f9_datadiesecuzione { get; set; }
		public DateTime? cr4f9_datadiscadenza { get; set; }
		public bool? cr4f9_eseguito { get; set; }

		[JsonPropertyName("NomeSede")]
		public string NomeSede { get; set; }

		[JsonPropertyName("Impianto")]
		public string Impianto { get; set; }

		[JsonPropertyName("TipoControllo")]
		public string TipoControllo { get; set; }
	}

	public class ControlliCollection
	{
		public Controllo[] value { get; set; }
	}
}
