@page "/elencopartecipazioni"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService

<h3>Partecipazioni</h3>

<AuthorizeView>
    <Authorized>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Download" Style="color: #4CAF50; margine-left:16px;" @onclick="ExportToExcel">
            Esporta in Excel
        </MudButton>

        <MudIconButton Icon="@Icons.Material.Filled.FilterAlt" Color="Color.Primary" OnClick="ToggleFilters" Class="mt-4" Style="color: #E53935; margin-bottom:12px;" />

        @if(showFilters)
        {
            <div class="folder-container compact">
                <div class="folder-tab">Filtri</div>

                <MudGrid GutterSize="8">
                    <MudItem sm="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">Cognome</MudText>
                        <MudTextField @bind-Value="searchCognome" Placeholder="Cerca per cognome"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        Class="white-input"
                        Style="margin-top: 6px;"/>
                    </MudItem>

                    <MudItem sm="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">Nome</MudText>
                        <MudTextField @bind-Value="searchNome" Placeholder="Cerca per nome"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        Class="white-input"
                        Style="margin-top: 6px;" />
                    </MudItem>

                    <MudItem sm="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">Codice Fiscale</MudText>
                        <MudTextField @bind-Value="searchCF" Placeholder="Cerca per codice fiscale"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        Class="white-input"
                        Style="margin-top: 6px;" />
                    </MudItem>
                </MudGrid>

                <MudGrid>
                    <MudItem sm="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">Titolo Corso</MudText>
                        <MudTextField @bind-Value="searchTitoloCorso" Placeholder="Cerca per titolo corso"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        Class="white-input"
                        Style="margin-top: 6px;" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935;">Data Fine Corso</MudText>
                        <MudGrid GutterSize="4">
                            <MudItem xs="6">
                                <MudDatePicker @bind-Date="dataFineForm"
                                Label="Da"
                                Variant="Variant.Outlined"
                                Class="white-input"
                                Clearable="true"
                                ClearIcon="@Icons.Material.Filled.Clear" />
                            </MudItem>
                            <MudItem xs="6">
                                <MudDatePicker @bind-Date="dataFineTo"
                                Label="A"
                                Variant="Variant.Outlined"
                                Class="white-input"
                                Clearable="true"
                                ClearIcon="@Icons.Material.Filled.Clear" />
                            </MudItem>
                        </MudGrid>
                    </MudItem>

                    <MudItem sm="12" md="4">
                        <MudText Typo="Typo.subtitle1" Class="mb-1" Style="color: #E53935; margin-left: 4px;">Sede Corso</MudText>
                        <MudTextField @bind-Value="searchSedeCorso" Placeholder="Cerca per sede corso"
                        Variant="Variant.Outlined"
                        Immediate="true"
                        Class="white-input"
                        Style="margin-top: 6px;" />
                    </MudItem>
                </MudGrid>
            </div>
        }


        @if (corsi != null)
        {
            <div class="folder-container">
                <div class="folder-tab">Elenco Partecipazioni</div>
                <MudTable Items="corsi.value" Filter="ToggleFunc" Dense="true" HeaderClass="mud-table-header" Hover="true" >
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Partecipazioni</MudText>
                        <MudSpacer />
                        @* <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField> *@
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x=>x.cr4f9_cognome)">Cognome</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x=>x.cr4f9_nome)">Nome</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x => x.cr4f9_codicefiscale)">Codice Fiscale</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x=>x.titoloCorso)">Titolo Corso</MudTableSortLabel></MudTh>
                        <!-- Nuova colonna -->
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x=>x.dataFineCorso)">Data Fine Corso</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Corsi, object>(x=>x.SedeDescrizione)">Sede del corso</MudTableSortLabel></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="corsi">
                        <MudLink DataLabel="riepilogo" Href="@($"/dettagliopartecipazione/id={corsi.new_partecipazionecorsoprvid}&idCorso={corsi._new_corso_value}")">
                            @corsi.cr4f9_cognome
                        </MudLink>
                        <MudTd DataLabel="idcorso">@corsi.cr4f9_nome</MudTd>
                        <MudTd DataLabel="codicefiscale">@corsi.cr4f9_codicefiscale</MudTd>
                        <MudTd DataLabel="titolocorso">@corsi.titoloCorso</MudTd>
                        <!-- Nuova cella per la nuova colonna -->
                        <MudTd DataLabel="datacorso">@corsi.dataFineCorsoString</MudTd>
                        <MudTd DataLabel="datacorso">
                            @(corsi.SedeDescrizione == "Vuoto" ? corsi.SedeTeoricaDescrizione + " e " + corsi.SedePraticaDescrizione : corsi.SedeDescrizione)
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                    </PagerContent>
                </MudTable>
            </div>
        }
        else
        {
            <p><em>@message</em></p>
        }
    </Authorized>
    <NotAuthorized>
        <h3>Authentication Failure!</h3>
        <p>You're not signed in.</p>
    </NotAuthorized>
</AuthorizeView>

@code {

    private string searchString1 = "";
    private Corsi selectedItem1 = null;
    private CorsiCollection corsi;
    private string message = "Loading...";
    private bool showFilters = false;
    private string searchCognome;
    private string searchNome;
    private string searchCF;
    private string searchTitoloCorso;
    private string searchSedeCorso;
    private DateTime? dataFineForm;
    private DateTime? dataFineTo;

    // Variabili per le informazioni dell'utente autenticato
    private string userName;
    private string userEmail;

    // Definire la query FetchXML, ma senza email statica
    private string fetchXmlQuery;

    [Inject] IJSRuntime JS { get; set; }

    private bool FilterFunc1(Corsi corsi) => FilterFunc(corsi, searchString1);

    private bool FilterFunc(Corsi corsi, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        return (corsi.cr4f9_cognome?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
               (corsi.cr4f9_nome?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
               (corsi.cr4f9_corsotipo?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false);
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); // Chiama il metodo per caricare le informazioni dell'utente

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
        <fetch>
            <entity name='new_partecipazionecorsoprv'>
                <attribute name='new_partecipazionecorsoprvid' />
                <attribute name='cr4f9_cognome' />
                <attribute name='cr4f9_nome' />
                <attribute name='cr4f9_codicefiscale' />
                <attribute name='cr4f9_corsotipo' />
                <attribute name='new_corso' />
                <attribute name='new_dataconclusione' />
                <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                    <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                        <filter>
                            <condition attribute='new_email' operator='eq' value='{userEmail}' />
                        </filter>
                    </link-entity>
                </link-entity>
                <link-entity name='cr4f9_corsoprv' from='cr4f9_corsoprvid' to='new_corso' alias='corso'>
                  <attribute name='cr4f9_datadifine' alias='dataFineCorso'/>
                  <attribute name='cr4f9_titolocorso' alias='titoloCorso'/>
                  <attribute name='new_sedecorso' alias='sedeCorso'/>
                  <attribute name='new_sedeteorica' alias='sedeTeorica'/>
                  <attribute name='new_sedepratica' alias='sedePratica'/>
                  <attribute name='new_indicaresede' alias='indicareSede'/>
                  <attribute name='new_indicaresedeteorica' alias='indicareSedeTeorica'/>
                  <attribute name='new_indicaresedepratica' alias='indicareSedePratica'/>
                  <attribute name='cr4f9_indirizzo2' alias='indirizzoDue'/>
                  <attribute name='cr4f9_indirizzo3' alias='indirizzoTre'/>
                  <attribute name='cr4f9_sedep' alias='sedeP'/>
                  <attribute name='cr4f9_sedet' alias='sedeT'/>
                </link-entity>
            </entity>
        </fetch>";

        logger.LogInformation("FETCH XML QUERY: " + fetchXmlQuery);

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}new_partecipazionecorsoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                corsi = await response.Content.ReadFromJsonAsync<CorsiCollection>();
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

    private Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        return DialogService.ShowAsync<AddPartecipazione>("Simple Dialog", options);
    }

    private async Task ExportToExcel()
    {
        if (corsi == null || corsi.value.Length == 0)
        {
            message = "Nessun dato da esportare.";
            return;
        }

        var jsonData = corsi.value.Select(c => new
        {
            Nome = c.cr4f9_nome,
            Cognome = c.cr4f9_cognome,
            CodiceFiscale = c.cr4f9_codicefiscale,
            CorsoTipo = c.cr4f9_corsotipo,
            TitoloCorso = c.titoloCorso,
            SedeCorso = c.SedeDescrizione,
            SedeTeorica = c.SedeTeoricaDescrizione,
            SedePratica = c.SedePraticaDescrizione,
            DataFineCorso = c.dataFineCorso.ToString("dd/MM/yyyy")
        });

        await JS.InvokeVoidAsync("downloadExcelFromBlazor", "PartecipazioniCorsi.xlsx", jsonData);
    }

    private bool ToggleFunc(Corsi corso)
    {
        bool matches = true;

        if(!string.IsNullOrWhiteSpace(searchCognome))
        {
            matches &= corso.cr4f9_cognome != null && corso.cr4f9_cognome.ToLower().Contains(searchCognome.ToLower());
        }

        if(!string.IsNullOrWhiteSpace(searchNome))
        {
            matches &= corso.cr4f9_nome != null && corso.cr4f9_nome.ToLower().Contains(searchNome.ToLower());
        }

        if(!string.IsNullOrWhiteSpace(searchCF))
        {
            matches &= corso.cr4f9_codicefiscale != null && corso.cr4f9_codicefiscale.ToLower().Contains(searchCF.ToLower());
        }

        if(!string.IsNullOrWhiteSpace(searchTitoloCorso))
        {
            matches &= corso.titoloCorso != null && corso.titoloCorso.ToLower().Contains(searchTitoloCorso.ToLower());
        }

        if(dataFineForm.HasValue)
        {
            matches &= corso.dataFineCorso >= dataFineForm.Value;
        }

        if(dataFineTo.HasValue)
        {
            matches &= corso.dataFineCorso <= dataFineTo.Value;
        }

        if(!string.IsNullOrWhiteSpace(searchSedeCorso))
        {
            matches &= corso.SedeDescrizione != null && corso.SedeDescrizione.ToLower().Contains(searchSedeCorso.ToLower());
        }

        return matches;
    }

    private void ToggleFilters() => showFilters = !showFilters;

    public class Corsi
    {
        public Guid new_partecipazionecorsoprvid { get; set; }
        public Guid? _new_corso_value { get; set; }
        public string cr4f9_cognome { get; set; }
        public string cr4f9_nome { get; set; }
        public string cr4f9_codicefiscale { get; set; }
        public string cr4f9_corsotipo { get; set; }
        public string titoloCorso { get; set; }
        public DateTime new_dataconclusione { get; set; }
        public DateTime dataFineCorso { get; set; }
        public int sedeCorso { get; set; }
        public int sedeTeorica { get; set; }
        public int sedePratica { get; set; }
        public string indicareSede { get; set; }
        public string indicareSedeTeorica { get; set; }
        public string indicareSedePratica { get; set; }
        public string indirizzoDue { get; set; }
        public string indirizzoTre { get; set; }
        public string sedeP { get; set; }
        public string sedeT { get; set; }

        public string dataFine => new_dataconclusione.ToString("dd/MM/yyyy");
        public string dataFineCorsoString => dataFineCorso.ToString("dd/MM/yyyy");

        public SedeCorso Sede
        {
            get => (SedeCorso)sedeCorso;
            set => sedeCorso = (int)value;
        } 

        public SedeCorso SedeTeoricaInt
        {
            get => (SedeCorso)sedeTeorica;
            set => sedeTeorica = (int)value;
        }

        public SedeCorso SedePraticaInt
        {
            get => (SedeCorso)sedePratica;
            set => sedePratica = (int)value;
        }

        public string SedeDescrizione => Sede switch
        {
            SedeCorso.PRAEVENIO => "Praevenio SRLS",
            SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
            SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
            SedeCorso.SEDE_CLIENTE => string.IsNullOrWhiteSpace(sedeT) ? sedeP : sedeT,
            SedeCorso.ALTRO => indicareSede,
            SedeCorso.VUOTO => ""
        };

        public string SedeTeoricaDescrizione => SedeTeoricaInt switch
        {
            SedeCorso.PRAEVENIO => "Praevenio SRLS",
            SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
            SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
            SedeCorso.SEDE_CLIENTE => indirizzoDue,
            SedeCorso.ALTRO => indicareSedeTeorica,
            SedeCorso.VUOTO => ""

        };

        public string SedePraticaDescrizione => SedePraticaInt switch
        {
            SedeCorso.PRAEVENIO => "Praevenio SRLS",
            SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
            SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
            SedeCorso.SEDE_CLIENTE => indirizzoTre,
            SedeCorso.ALTRO => indicareSedePratica,
            SedeCorso.VUOTO => ""
        };

    }

    public enum SedeCorso
    {
        PRAEVENIO = 100000000,
        ELEARNING = 100000001,
        VIDEOCONFERENZA = 100000002,
        SEDE_CLIENTE = 100000003,
        ALTRO = 100000004,
        VUOTO = 0
    }

    public class CorsiCollection
    {
        public Corsi[] value { get; set; }
    }

}

<style>

    /* Contenitore principale della tabella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px;
    }

    /* Tabella principale */
    .mud-table {
        width: 100%; /* Assicurati che la tabella occupi tutta la larghezza disponibile */
        border-radius: 8px;
        border-collapse: collapse; /* Per una gestione più uniforme dei bordi */
    }

    /* Tabella intestazione */
    .mud-table-header {
        background-color: #E53935;
    }

    .mud-table-header .mud-table-cell {
        color: white !important;
        font-weight: bold; /* Grassetto per l'intestazione */
    }

    /* Righe della tabella */
    .mud-table-row {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le righe */
    }

    /* Celle della tabella (MudTd) */
    .mud-table .mud-td, .mud-table .mud-th {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le celle */
        padding: 8px; /* Padding per le celle */
        vertical-align: middle; /* Allinea verticalmente il contenuto */
        text-align: center; /* Centra il testo */
    }

    /* Colore dei link nella tabella */
    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: left;
        vertical-align: middle;
        margin-left: 8px;
        padding: 16px;
    }

    /* Hover sui link */
    .mud-table .mud-link.mud-typography.mud-primary-text:hover {
        color: red !important;
        cursor: pointer;
    }

    /* Contenitore della tabella */
    .folder-tab {
        position: absolute;
        top: -25px;
        left: 20px;
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
    }

    /* Nascondi informazioni di paginazione */
    .mud-table-pagination-information {
        display: none;
    }

    .white-input input,
    .white-input .mud-input-slot {
        background-color: #ffffff !important;
        font-size: 0.8rem !important;
    }

    .date-filter-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }

</style>