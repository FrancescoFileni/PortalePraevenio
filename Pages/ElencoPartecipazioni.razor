@page "/elencopartecipazioni"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using System.Text
@using System.Text.Json
@using MudBlazor
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject IJSRuntime JS

<link href="css/partecipazioni.css?v=1" rel="stylesheet" />

<AuthorizeView>
	<Authorized>

		<!-- TOOLBAR -->
		<MudPaper Class="toolbar" Elevation="1">
			<div class="toolbar-left">
				<MudText Typo="Typo.h5" Class="page-title">PARTECIPAZIONI</MudText>
			</div>

			<div class="toolbar-right">
				<MudButton Variant="Variant.Outlined"
						   StartIcon="@Icons.Material.Filled.FileDownload"
						   Color="Color.Success"
						   Class="action-btn"
						   OnClick="ExportToExcel">
					Esporta
				</MudButton>

				<MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
							   Color="Color.Error"
							   OnClick="ToggleFilters"
							   Class="filter-btn" />
			</div>
		</MudPaper>

		<!-- FILTRI -->
		<MudCollapse Expanded="@showFilters">
			<MudPaper Class="filters-panel" Elevation="0">
				<MudGrid GutterSize="8">

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Cognome
						</MudText>
						<MudTextField @bind-Value="searchCognome"
									  Placeholder="Cerca per cognome"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Nome
						</MudText>
						<MudTextField @bind-Value="searchNome"
									  Placeholder="Cerca per nome"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Codice Fiscale
						</MudText>
						<MudTextField @bind-Value="searchCF"
									  Placeholder="Cerca per codice fiscale"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Titolo Corso
						</MudText>
						<MudTextField @bind-Value="searchTitoloCorso"
									  Placeholder="Cerca per titolo corso"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Data Fine Corso
						</MudText>

						<div class="date-range">
							<MudDatePicker @bind-Date="dataFineForm"
										   Label="Da"
										   Variant="Variant.Outlined"
										   Class="white-input date-input"
										   Clearable="true" />

							<MudDatePicker @bind-Date="dataFineTo"
										   Label="A"
										   Variant="Variant.Outlined"
										   Class="white-input date-input"
										   Clearable="true" />
						</div>
					</MudItem>


					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Sede Corso
						</MudText>
						<MudTextField @bind-Value="searchSedeCorso"
									  Placeholder="Cerca per sede corso"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>
				</MudGrid>

				<div class="mt-4 filters-actions">
					<MudButton Variant="Variant.Outlined"
							   Color="Color.Primary"
							   StartIcon="@Icons.Material.Filled.Refresh"
							   OnClick="ResetFilters">
						Ripristina
					</MudButton>
				</div>
			</MudPaper>
		</MudCollapse>

		@if (corsi != null)
		{
			<div class="folder-container">
				<div class="folder-tab">Elenco Partecipazioni</div>

				<MudTable T="Corsi"
						  Items="corsi.value"
						  Filter="ToggleFunc"
						  Dense="true"
						  Hover="true"
						  Class="modern-table">

					<HeaderContent>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.cr4f9_cognome)">Cognome</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.cr4f9_nome)">Nome</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.cr4f9_codicefiscale)">Codice Fiscale</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.titoloCorso)">Titolo Corso</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.dataFineCorso)">Data Fine Corso</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<Corsi, object>(x=>x.SedeDescrizione)">Sede del corso</MudTableSortLabel></MudTh>

						<!-- AZIONI -->
						<MudTh></MudTh>
					</HeaderContent>

					<RowTemplate Context="r">
						<MudTd DataLabel="cognome">
							<MudLink Href="@($"/dettagliopartecipazione/id={r.new_partecipazionecorsoprvid}")"
									 Class="name-link">
								@r.cr4f9_cognome
							</MudLink>
						</MudTd>

						<MudTd DataLabel="nome">@r.cr4f9_nome</MudTd>
						<MudTd DataLabel="codicefiscale">@r.cr4f9_codicefiscale</MudTd>
						<MudTd DataLabel="titolocorso">@r.titoloCorso</MudTd>
						<MudTd DataLabel="datafine">@r.dataFineCorsoString</MudTd>

						<MudTd DataLabel="sedecorso">
							@(r.SedeDescrizione == "Vuoto"
														? (r.SedeTeoricaDescrizione + " e " + r.SedePraticaDescrizione)
														: r.SedeDescrizione)
						</MudTd>

						<!-- PULSANTE "ELIMINA" (DISATTIVA PARTECIPAZIONE) -->
						<MudTd DataLabel="azioni" Class="text-right">
							<MudIconButton Icon="@Icons.Material.Filled.Delete"
										   Color="Color.Error"
										   Disabled="@(isDeleting)"
										   Title="Elimina (disattiva partecipazione)"
										   OnClick="async () => await ConfermaEDisattivaAsync(r)" />
						</MudTd>
					</RowTemplate>

					<PagerContent>
						<MudTablePager PageSizeOptions="new int[]{10, 20}" />
					</PagerContent>
				</MudTable>
			</div>
		}
		else
		{
			<p><em>@message</em></p>
		}

	</Authorized>

	<NotAuthorized>
		<h3>Authentication Failure!</h3>
		<p>You're not signed in.</p>
	</NotAuthorized>
</AuthorizeView>

@code {
	private string searchString1 = "";
	private Corsi selectedItem1 = null;
	private CorsiCollection corsi;
	private string message = "Loading...";
	private bool showFilters = false;

	private string searchCognome;
	private string searchNome;
	private string searchCF;
	private string searchTitoloCorso;
	private string searchSedeCorso;
	private DateTime? dataFineForm;
	private DateTime? dataFineTo;

	private string userName;
	private string userEmail;

	private string fetchXmlQuery;

	private bool isDeleting = false;

	protected override async Task OnInitializedAsync()
	{
		await LoadUserInformation();

		// Mostra solo partecipazioni ATTIVE (statecode = 0)
		fetchXmlQuery = $@"
        <fetch>
            <entity name='new_partecipazionecorsoprv'>
                <attribute name='new_partecipazionecorsoprvid' />
                <attribute name='cr4f9_cognome' />
                <attribute name='cr4f9_nome' />
                <attribute name='cr4f9_codicefiscale' />
                <attribute name='cr4f9_corsotipo' />
                <attribute name='new_corso' />
                <attribute name='new_dataconclusione' />

                <filter>
                    <condition attribute='statecode' operator='eq' value='0' />
                </filter>

                <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                    <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                        <filter>
                            <condition attribute='new_email' operator='eq' value='{userEmail}' />
                        </filter>
                    </link-entity>
                </link-entity>

                <link-entity name='cr4f9_corsoprv' from='cr4f9_corsoprvid' to='new_corso' alias='corso'>
                  <attribute name='cr4f9_datadifine' alias='dataFineCorso'/>
                  <attribute name='cr4f9_titolocorso' alias='titoloCorso'/>
                  <attribute name='new_sedecorso' alias='sedeCorso'/>
                  <attribute name='new_sedeteorica' alias='sedeTeorica'/>
                  <attribute name='new_sedepratica' alias='sedePratica'/>
                  <attribute name='new_indicaresede' alias='indicareSede'/>
                  <attribute name='new_indicaresedeteorica' alias='indicareSedeTeorica'/>
                  <attribute name='new_indicaresedepratica' alias='indicareSedePratica'/>
                  <attribute name='cr4f9_indirizzo2' alias='indirizzoDue'/>
                  <attribute name='cr4f9_indirizzo3' alias='indirizzoTre'/>
                  <attribute name='cr4f9_sedep' alias='sedeP'/>
                  <attribute name='cr4f9_sedet' alias='sedeT'/>
                </link-entity>
            </entity>
        </fetch>";

		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");

			var request = new HttpRequestMessage()
				{
					Method = HttpMethod.Get,
					RequestUri = new Uri($"{client.BaseAddress}new_partecipazionecorsoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
				};

			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
				corsi = await response.Content.ReadFromJsonAsync<CorsiCollection>();
			else
				message = "An error occurred.";
		}
		else
		{
			message = "There was a problem authenticating.";
		}
	}

	private async Task LoadUserInformation()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			userName = user.Identity.Name;
			userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;
		}
	}

	private async Task ExportToExcel()
	{
		if (corsi?.value == null || corsi.value.Length == 0)
		{
			message = "Nessun dato da esportare.";
			return;
		}

		var jsonData = corsi.value.Where(ToggleFunc).Select(c => new
		{
			Nome = c.cr4f9_nome,
			Cognome = c.cr4f9_cognome,
			CodiceFiscale = c.cr4f9_codicefiscale,
			CorsoTipo = c.cr4f9_corsotipo,
			TitoloCorso = c.titoloCorso,
			SedeCorso = c.SedeDescrizione,
			SedeTeorica = c.SedeTeoricaDescrizione,
			SedePratica = c.SedePraticaDescrizione,
			DataFineCorso = c.dataFineCorso.ToString("dd/MM/yyyy")
		});

		await JS.InvokeVoidAsync("downloadExcelFromBlazor", "PartecipazioniCorsi.xlsx", jsonData);
	}

	private void ResetFilters()
	{
		searchCognome = string.Empty;
		searchNome = string.Empty;
		searchCF = string.Empty;
		searchTitoloCorso = string.Empty;
		searchSedeCorso = string.Empty;
		dataFineForm = null;
		dataFineTo = null;
	}

	private void ToggleFilters() => showFilters = !showFilters;

	private bool ToggleFunc(Corsi corso)
	{
		bool matches = true;

		if (!string.IsNullOrWhiteSpace(searchCognome))
			matches &= corso.cr4f9_cognome?.Contains(searchCognome, StringComparison.OrdinalIgnoreCase) ?? false;

		if (!string.IsNullOrWhiteSpace(searchNome))
			matches &= corso.cr4f9_nome?.Contains(searchNome, StringComparison.OrdinalIgnoreCase) ?? false;

		if (!string.IsNullOrWhiteSpace(searchCF))
			matches &= corso.cr4f9_codicefiscale?.Contains(searchCF, StringComparison.OrdinalIgnoreCase) ?? false;

		if (!string.IsNullOrWhiteSpace(searchTitoloCorso))
			matches &= corso.titoloCorso?.Contains(searchTitoloCorso, StringComparison.OrdinalIgnoreCase) ?? false;

		if (dataFineForm.HasValue)
			matches &= corso.dataFineCorso >= dataFineForm.Value;

		if (dataFineTo.HasValue)
			matches &= corso.dataFineCorso <= dataFineTo.Value;

		if (!string.IsNullOrWhiteSpace(searchSedeCorso))
			matches &= (corso.SedeDescrizione?.Contains(searchSedeCorso, StringComparison.OrdinalIgnoreCase) ?? false);

		return matches;
	}

	// ============================
	// ELIMINAZIONE (DISATTIVAZIONE)
	// ============================

	private async Task ConfermaEDisattivaAsync(Corsi partecipazione)
	{
		if (partecipazione == null) return;

		var ok = await DialogService.ShowMessageBox(
			title: "Conferma eliminazione",
			markupMessage: (MarkupString)$@"
				Stai per <b>eliminare</b> la partecipazione (in realtà verrà <b>disattivata</b>).<br/><br/>
				<b>{partecipazione.cr4f9_cognome} {partecipazione.cr4f9_nome}</b><br/>
				CF: {partecipazione.cr4f9_codicefiscale}<br/>
				Corso: {partecipazione.titoloCorso}<br/><br/>
				Vuoi continuare?",
			yesText: "Sì, elimina",
			cancelText: "Annulla",
			options: new DialogOptions { CloseOnEscapeKey = true });

		if (ok != true) return;

		await DisattivaPartecipazioneAsync(partecipazione);
	}

	private async Task DisattivaPartecipazioneAsync(Corsi partecipazione)
	{
		if (isDeleting) return;
		isDeleting = true;

		try
		{
			var tokenResult = await TokenProvider.RequestAccessToken();
			if (!tokenResult.TryGetToken(out var token))
			{
				message = "Token non disponibile.";
				return;
			}

			var client = ClientFactory.CreateClient("DataverseClient");

			// EntitySet: new_partecipazionecorsoprvs (già usato nella GET)
			var id = partecipazione.new_partecipazionecorsoprvid;
			var url = $"{client.BaseAddress}new_partecipazionecorsoprvs({id})";

			var payload = new
			{
				statecode = 1 // Inattivo
			};

			var req = new HttpRequestMessage(new HttpMethod("PATCH"), url);
			req.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			req.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
			req.Headers.TryAddWithoutValidation("If-Match", "*");
			req.Content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, "application/json");

			var resp = await client.SendAsync(req);

			if (!resp.IsSuccessStatusCode)
			{
				var body = await resp.Content.ReadAsStringAsync();
				logger.LogError($"Errore disattivazione partecipazione: {resp.StatusCode} - {body}");
				message = "Errore durante la disattivazione.";
				return;
			}

			// Rimuovi subito dalla tabella (dato che mostri solo statecode=0)
			corsi = new CorsiCollection
				{
					value = corsi.value.Where(x => x.new_partecipazionecorsoprvid != partecipazione.new_partecipazionecorsoprvid).ToArray()
				};
			StateHasChanged();
		}
		finally
		{
			isDeleting = false;
		}
	}

	// ============================
	// MODELS
	// ============================

	public class Corsi
	{
		public Guid new_partecipazionecorsoprvid { get; set; }
		public Guid? _new_corso_value { get; set; }
		public string cr4f9_cognome { get; set; }
		public string cr4f9_nome { get; set; }
		public string cr4f9_codicefiscale { get; set; }
		public string cr4f9_corsotipo { get; set; }
		public string titoloCorso { get; set; }
		public DateTime new_dataconclusione { get; set; }
		public DateTime dataFineCorso { get; set; }
		public int sedeCorso { get; set; }
		public int sedeTeorica { get; set; }
		public int sedePratica { get; set; }
		public string indicareSede { get; set; }
		public string indicareSedeTeorica { get; set; }
		public string indicareSedePratica { get; set; }
		public string indirizzoDue { get; set; }
		public string indirizzoTre { get; set; }
		public string sedeP { get; set; }
		public string sedeT { get; set; }

		public string dataFine => new_dataconclusione.ToString("dd/MM/yyyy");
		public string dataFineCorsoString => dataFineCorso.ToString("dd/MM/yyyy");

		public SedeCorso Sede
		{
			get => (SedeCorso)sedeCorso;
			set => sedeCorso = (int)value;
		}

		public SedeCorso SedeTeoricaInt
		{
			get => (SedeCorso)sedeTeorica;
			set => sedeTeorica = (int)value;
		}

		public SedeCorso SedePraticaInt
		{
			get => (SedeCorso)sedePratica;
			set => sedePratica = (int)value;
		}

		public string SedeDescrizione => Sede switch
		{
			SedeCorso.PRAEVENIO => "Praevenio SRLS",
			SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
			SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
			SedeCorso.SEDE_CLIENTE => string.IsNullOrWhiteSpace(sedeT) ? sedeP : sedeT,
			SedeCorso.ALTRO => indicareSede,
			SedeCorso.VUOTO => ""
		};

		public string SedeTeoricaDescrizione => SedeTeoricaInt switch
		{
			SedeCorso.PRAEVENIO => "Praevenio SRLS",
			SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
			SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
			SedeCorso.SEDE_CLIENTE => indirizzoDue,
			SedeCorso.ALTRO => indicareSedeTeorica,
			SedeCorso.VUOTO => ""
		};

		public string SedePraticaDescrizione => SedePraticaInt switch
		{
			SedeCorso.PRAEVENIO => "Praevenio SRLS",
			SedeCorso.ELEARNING => "Corso svolto in modalità E-Learning",
			SedeCorso.VIDEOCONFERENZA => "Corso svolto in modalità di videoconferenza sincrona",
			SedeCorso.SEDE_CLIENTE => indirizzoTre,
			SedeCorso.ALTRO => indicareSedePratica,
			SedeCorso.VUOTO => ""
		};
	}

	public enum SedeCorso
	{
		PRAEVENIO = 100000000,
		ELEARNING = 100000001,
		VIDEOCONFERENZA = 100000002,
		SEDE_CLIENTE = 100000003,
		ALTRO = 100000004,
		VUOTO = 0
	}

	public class CorsiCollection
	{
		public Corsi[] value { get; set; }
	}
}
