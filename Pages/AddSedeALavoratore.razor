@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using System.Text
@using System.Text.Json
@using Newtonsoft.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<AddLavoratoreSede> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject NavigationManager Navigation

<MudDialog Class="custom-dialog-red-gray">
	<TitleContent>
		<MudStack>
			<MudIcon Icon="@Icons.Material.Filled.House" Color="Color.Error"/>
			<MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
				Associa sede al lavoratore
			</MudText>
		</MudStack>
	</TitleContent>
	<DialogContent>
		<MudPaper Class="content-area-red-gray" Elevation="1">
			<MudForm @ref="form" Valid="isFormValid">
				<MudGrid>
					<MudItem xs="12">
						<MudStack Row Spacing="2">
							<MudSelect T="Sede"
									   @bind-Value="selectedSede"
									   Variant="Variant.Outlined"
									   Label="Sede"
									   Searchable="true"
									   Placeholder="Seleziona Sede">
								@foreach (var sede in sediOrdinate.value)
								{
									<MudSelectItem Value="@sede">@sede.new_localita</MudSelectItem>
								}
							</MudSelect>
							<MudButton Variant="Variant.Filled"
									   Color="Color.Primary"
									   Disabled="selectedSede == null"
									   OnClick="async () => await ConfirmSede()">
								Conferma sede
							</MudButton>

						</MudStack>
					</MudItem>

					@* Mansione: mostrala solo dopo conferma sede *@
					@if (isSedeConfirmed)
					{
						<MudItem xs="12" md="6">
							<MudSelect T="Mansione"
									   @bind-Value="selectedMansione"
									   Variant="Variant.Outlined"
									   Label="Mansione"
									   Required="true"
									   Virtualized="true"
									   Searchable="true"
									   Placeholder="Seleziona Mansione">
								@foreach (var mansione in mansioniOrdinate.value)
								{
									<MudSelectItem Value="@mansione">@mansione.new_mansione</MudSelectItem>
								}
							</MudSelect>
						</MudItem>
					}
				</MudGrid>
			</MudForm>
		</MudPaper>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
			Annulla
		</MudButton>
		<MudButton OnClick="Submit"
				   Variant="Variant.Filled"
				   Color="Color.Error"
				   Disabled="!isSedeConfirmed || selectedMansione == null">
			Conferma
		</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[Parameter]
	public string id { get; set; }

	[CascadingParameter]
	private MudDialogInstance MudDialog { get; set; }

	private MudForm form;

	private string userName;
	private string userEmail;
	private Guid? azienda;
	private string clienteId;
	
	private string idPrestazioneCreata;

	private bool isSedeConfirmed = false;

	private Sede selectedSede;
	private SedeCollection sedi = new SedeCollection { value = Array.Empty<Sede>() };
	private SedeCollection sediOrdinate = new SedeCollection { value = Array.Empty<Sede>() };

	private Mansione selectedMansione;
	private MansioneCollection mansioni = new MansioneCollection { value = Array.Empty<Mansione>() };
	private MansioneCollection mansioniOrdinate = new MansioneCollection { value = Array.Empty<Mansione>() };

	private Lavoratore lavoratore = new Lavoratore { cr4f9_calcolonomeecognome = "", cr4f9_contattoprvid = "" };

	private LavoratoreCollection lavoratori = new LavoratoreCollection { value = Array.Empty<Lavoratore>() };

	protected override async Task OnInitializedAsync()
	{
		await LoadUserInformation();
		await CaricaLavoratore();
		await CaricaSedi();
	}

	private async Task LoadUserInformation()
	{
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;

		if (user.Identity.IsAuthenticated)
		{
			userName = user.Identity.Name;
			userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;
			logger.LogInformation("USER EMAIL: " + userEmail);
		}
		await CaricaClienteAssociato(userEmail);
	}

	private async Task CaricaClienteAssociato(string email)
	{
		try
		{
			var tokenResult = await TokenProvider.RequestAccessToken();
			if (tokenResult.TryGetToken(out var token))
			{
				var client = ClientFactory.CreateClient("DataverseClient");

				var fetchXml = BuildFetchXml(email);

				var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeUriString(fetchXml)}");
				request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

				var response = await client.SendAsync(request);

				if (response.IsSuccessStatusCode)
				{
					var responseBody = await response.Content.ReadAsStringAsync();

					var jsonDocument = JsonDocument.Parse(responseBody);
					var entities = jsonDocument.RootElement.GetProperty("value");

					logger.LogInformation("FETCH: " + fetchXml);

					if (entities.GetArrayLength() > 0)
					{
						var entity = entities[0];

						string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new JsonSerializerOptions
							{
								WriteIndented = true
							});
						logger.LogInformation($"Entities JSON: {entitiesJson}");

						if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
						{
							clienteId = newClienteProperty.GetString();
							azienda = newClienteProperty.GetGuid();

							logger.LogInformation($"Entities reference: {clienteId}");
							logger.LogInformation($"Azienda reference: {azienda}");
						}
						else
						{
							logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
						}
					}
					else
					{
						logger.LogWarning("Nessun record trovato per l'email fornita.");
					}
				}
				else
				{
					logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
				}
			}
			else
			{
				logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
			}
		}
		catch (Exception ex)
		{
			logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
		}
	}

	private string BuildFetchXml(string email)
	{
		return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
	}

	private async Task CaricaSedi()
	{
		var tokenResult = await TokenProvider.RequestAccessToken();
		var fetchXml = BuildFetchXmlSedi();
		if(tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");

			var request = new HttpRequestMessage()
				{
					Method = HttpMethod.Get,
					RequestUri = new Uri($"{client.BaseAddress}new_sedeprvs?fetchXml={Uri.EscapeUriString(fetchXml)}"),
				};

			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
			{ 
				sedi = await response.Content.ReadFromJsonAsync<SedeCollection>();
				sediOrdinate.value = sedi.value.OrderBy(s => s.new_localita).ToArray();
				logger.LogInformation($"lista sedi caricata");
			}
			else
			{
				await DialogService.ShowMessageBox("ERRORE", "An error occurred while fetching data.");
				logger.LogError($"Error fetching data: {response.ReasonPhrase}");
			}
		}
		else
		{
			await DialogService.ShowMessageBox("ERRORE", "There was a problem authenticating.");
		}
	}

	private string BuildFetchXmlSedi()
	{
		return $@"
		<fetch>
		  <entity name='new_sedeprv'>
			<attribute name='new_sedeprvid' />
			<attribute name='new_localita' />
			<filter>
			  <condition attribute='new_cliente' operator='eq' value='{azienda}' />
			</filter>
		  </entity>
		</fetch>";
	}

	public async Task CaricaMansioni()
	{
		var tokenResult = await TokenProvider.RequestAccessToken();
		var fetchXml = BuildFetchXmlMansioni();

		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");

			var request = new HttpRequestMessage()
				{
					Method = HttpMethod.Get,
					RequestUri = new Uri($"{client.BaseAddress}new_mansionetabellamasters?fetchXml={Uri.EscapeDataString(fetchXml)}")
				};

			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
			{
				mansioni = await response.Content.ReadFromJsonAsync<MansioneCollection>();
				mansioniOrdinate.value = mansioni.value.OrderBy(m => m.new_mansione).ToArray();
				logger.LogInformation($"Lista mansioni caricata: {mansioniOrdinate.value.Length} elementi");

				// Assicuriamoci di rinfrescare il UI thread
				await InvokeAsync(StateHasChanged);
			}
				else
				{
					await DialogService.ShowMessageBox("ERRORE", "An error occured.");
					logger.LogError($"Error fetching data: {response.ReasonPhrase}");
				}
		}
		else
		{
			await DialogService.ShowMessageBox("ERRORE", "There was a problem authenticating.");
		}
	}

	private string BuildFetchXmlMansioni()
	{
		return $@"
    <fetch>
      <entity name='new_mansionetabellamaster'>
        <attribute name='new_mansionetabellamasterid' />
        <attribute name='new_mansione' />
        <filter>
          <condition attribute='cr4f9_sede' operator='eq' value='{selectedSede.new_sedeprvid}' />
        </filter>
      </entity>
    </fetch>";
	}


	public async Task CaricaLavoratore()
	{
		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");

			var fetchXml = BuildFetchXmlLavoratore();

			var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_contattoprvs?fetchXml={Uri.EscapeUriString(fetchXml)}");
			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
			{
				lavoratori = await response.Content.ReadFromJsonAsync<LavoratoreCollection>();
				if (lavoratori != null && lavoratori.value != null && lavoratori.value.Length > 0)
				{
					lavoratore = lavoratori.value[0];
					logger.LogInformation($"Lavoratore trovato: {lavoratore.cr4f9_calcolonomeecognome}");
				}
				else
				{
					logger.LogWarning("Nessun lavoratore trovato.");
				}
			}
			else
			{
				await DialogService.ShowMessageBox("ERRORE", "An error occured while fetching the lavoratore.");
				logger.LogError($"Error fetching data: {response.ReasonPhrase}");
			}
		}
		else
		{
			await DialogService.ShowMessageBox("ERRORE", "There was a problem authenticating.");
		}
	}

		private string BuildFetchXmlLavoratore()
		{
				return $@"
				<fetch>
					<entity name='cr4f9_contattoprv'>
						<attribute name='cr4f9_calcolonomeecognome' />
						<attribute name='cr4f9_contattoprvid' />
						<filter>
							<condition attribute='cr4f9_contattoprvid' operator='eq' value='{id}' />
						</filter>
					</entity>
				</fetch>";
		}

	private async Task CreaPrestazioneLavorativa(PrestazioneDiLavoro prestazione)
	{
		try
		{
			var dizionario = new Dictionary<string,object>
			{
				{"new_Lavoratore@odata.bind", $"/cr4f9_contattoprvs({id})"},
				{"new_Azienda@odata.bind", $"/cr4f9_clienteprvs({azienda})"},
				{"new_Sede@odata.bind", $"/new_sedeprvs({prestazione.Sede})"},
				{"cr4f9_Mansione@odata.bind", $"/new_mansionetabellamasters({prestazione.Mansione})"},
				{"cr4f9_inforza", prestazione.InForza}
			};

			string contenuto = JsonConvert.SerializeObject(dizionario, Formatting.Indented);

			logger.LogInformation($"Contenuto JSON: {contenuto}");

			await form.Validate();

			if(!form.IsValid)
			{
				await DialogService.ShowMessageBox("ERRORE", "Il modulo non è valido. Compila tutti i campi richiesti.");
				return;
			}

			var tokenResult = await TokenProvider.RequestAccessToken();
			if (tokenResult.TryGetToken(out var token))
			{
				var client = ClientFactory.CreateClient("DataverseClient");

				var request = new HttpRequestMessage(HttpMethod.Post, "new_lavorapressoprvs")
					{
						Content = JsonContent.Create(contenuto)
					};

				request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

				var response = await client.SendAsync(request);
				var responseBody = await response.Content.ReadAsStringAsync();
				logger.LogInformation("Payload inviato: {@contenuto}");

				if (response.IsSuccessStatusCode)
				{
					if (response.Headers.TryGetValues("OData-EntityId", out var entityIdValues))
					{
						var entityId = entityIdValues.FirstOrDefault();

						if (entityId != null)
						{
							idPrestazioneCreata = entityId.Split('(').LastOrDefault()?.TrimEnd(')');
							logger.LogInformation($"Record della prestazione creato con successo. ID: {idPrestazioneCreata}");
						}
					}
					else
					{
						logger.LogWarning("Nessun ID trovato nell'header della risposta.");
					}

					prestazione = new();
				}
				else
				{
					await DialogService.ShowMessageBox("ERRORE", $"Errore nell'invio: {response.ReasonPhrase}");
					logger.LogError($"Errore API: {response.StatusCode} - {response.ReasonPhrase}");
					logger.LogError($"Dettagli risposta: {responseBody}");
				}
			}
			else
			{
				logger.LogError("Errore di autenticazione durante la creazione del record.");
			}
		}
		catch (Exception ex)
		{
			logger.LogError($"Errore durante la creazione del record della prestazione di lavoro: {ex.Message}");
		}
	}

	private async Task OnSedeChanged(Sede newSede)
	{
		selectedSede = newSede;
		selectedMansione = null;        // reset mansione precedente
		await CaricaMansioni();         // ricarica il dropdown
		await InvokeAsync(StateHasChanged);              // forza il re-render del componente
	}

	private void OnMansioneChange()
	{
		if (selectedMansione != null)
		{
			var mansioneId = selectedMansione.new_mansionetabellamasterid;
			logger.LogInformation($"Mansione selezionata: {selectedMansione.new_mansionetabellamasterid}, Mansione ID: {mansioneId}");
		}
	}

	private async Task Submit()
	{
		if (selectedSede != null)
		{
			var sedeId = selectedSede.new_sedeprvid;
			logger.LogInformation($"Sede selezionata: {selectedSede.new_localita}, Sede ID: {sedeId}");

			var prestazione = new PrestazioneDiLavoro
			{
				Lavoratore = lavoratore.cr4f9_contattoprvid,
				Azienda = clienteId,
				Sede = sedeId,
				Mansione = selectedMansione?.new_mansionetabellamasterid,
				InForza = true
			};

			await CreaPrestazioneLavorativa(prestazione);

			if (!string.IsNullOrEmpty(idPrestazioneCreata))
			{
				await DialogService.ShowMessageBox(
					"INFO",
					"Sede aggiunta al lavoratore con successo",
					yesText: "Chiudi");

				MudDialog.Close(DialogResult.Ok(true));
			}
			else
			{
				logger.LogWarning("ID prestazione non valido. Assicurati che la creazione della prestazione di lavoro sia riuscita.");

				await DialogService.ShowMessageBox(
					"ERRORE",
					"Lavoratore non inserito",
					yesText: "Chiudi");
			}
		}
	}
	private void Cancel() => MudDialog.Cancel();

	private async Task ConfirmSede()
	{
		if (selectedSede == null) return;

		await CaricaMansioni();
		isSedeConfirmed = true;

		// rinfresca il component
		await InvokeAsync(StateHasChanged);
	}

	public class Sede
	{
		[JsonPropertyName("new_sedeprvid")]
		public string new_sedeprvid { get; set; }

		[JsonPropertyName("new_localita")]
		public string new_localita { get; set; }
	}


	public class SedeCollection
	{
		public Sede[] value { get; set; }
	}

	public class PrestazioneDiLavoro
	{
		public string Lavoratore { get; set; }
		public string Azienda { get; set; }
		public string Sede { get; set; }
		public string Mansione { get; set; }
		public bool InForza { get; set; }
	}

	public class Mansione
	{
		public string new_mansionetabellamasterid { get; set; }
		public string new_mansione { get; set; }
	}

	public class MansioneCollection
	{
		public Mansione[] value { get; set; }
	}

	public class Lavoratore
	{
		public string cr4f9_contattoprvid { get; set; }
		public string cr4f9_calcolonomeecognome { get; set; }
	}

	public class LavoratoreCollection
	{
		public Lavoratore[] value { get; set; }
	}
}

<style>
	.custom-dialog-red-gray {
		padding: 16px;
		border-radius: 8px;
		background-color: #f2f2f2;
		/* Imposta dimensioni più contenute */
		width: 50vw; /* Larghezza pari al 50% della viewport, oppure usa un valore fisso */
		height: auto; /* Lascia l'altezza adeguarsi al contenuto */
		max-width: 600px; /* Imposta un limite massimo alla larghezza */
		max-height: 90vh; /* Imposta un limite massimo all'altezza */
		display: flex;
		flex-direction: column;
	}

	.content-area-red-gray {
		margin: 16px 0;
		padding: 16px;
		background-color: #ffffff; /* Bianco */
		border: 1px solid #e0e0e0; /* Bordo grigio */
		border-radius: 4px;
		flex-grow: 1; /* Permette alla sezione del contenuto di espandersi */
		overflow-y: auto; /* Abilita lo scorrimento verticale se necessario */
	}

	.mud-dialog-actions {
		justify-content: center; /* Centra i bottoni */
	}

	.mud-button {
		margin: 0 8px; /* Spaziatura tra i bottoni */
	}
</style>
