@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Newtonsoft.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<AddFile> logger
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudDialog Class="custom-dialog-red-gray" MaxWidth="600px">
    <TitleContent>
        <MudStack Direction="Row" Align="Center" JustifyContent="Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.FileUpload" Color="Color.Error" />
            <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
                Inserisci File
            </MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        <MudPaper Class="content-area-red-gray" Elevation="1" Style="padding: 16px;">
            <MudForm @ref="form" Valid="isFormValid">
                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudTextField T="string" @bind-Value="noteFile" Label="Note File" Variant="Variant.Outlined" Lines="5" FullWidth />
                    </MudItem>

                    <MudItem xs="12" class="d-flex justify-content-center">
                        <MudFileUpload T="IBrowserFile" OnFilesChanged="HandleFileSelected" Accept="*/*">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.CloudUpload" Style="height: 40px;">
                                    Carica File
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <div class="d-flex justify-content-end" style="gap: 8px;">
            <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
                Annulla
            </MudButton>
            <MudButton OnClick="Submit" Variant="Variant.Filled" Color="Color.Error">
                Conferma
            </MudButton>
        </div>
    </DialogActions>

</MudDialog>


@code {
    [CascadingParameter]
    public MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public string IdCartella { get; set; }

    [Parameter]
    public string Titolo { get; set; }

    [Inject]
    public IDialogService DialogService { get; set; }

    private MudForm form;
    private bool isFormValid = false;
    private bool isLoading = false;
    private string message;
    private IBrowserFile? fileSelezionato;
    private string idFileCreato;
    private string? noteFile;

    // Gestione della selezione del file
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles();
        fileSelezionato = files?.FirstOrDefault();

        if (fileSelezionato != null)
        {
            logger.LogInformation($"File selezionato: {fileSelezionato.Name}, Dimensione: {fileSelezionato.Size} bytes");
            Snackbar.Add("File correttamente caricato", Severity.Success);
        }
        else
        {
            logger.LogWarning("Nessun file selezionato.");
        }

        await Task.CompletedTask;
    }

    // Creazione del record del file (payload JSON)
    private async Task CreaRecordFile(FileRecord fileRecord)
    {
        try
        {
            isLoading = true;


            var dizionario = new Dictionary<string, object>
            {
                { "cr4f9_Cartella@odata.bind", $"/cr4f9_cartelladocumentis({fileRecord.Cartella})" },
                { "cr4f9_notedocumento", fileRecord.Note }
            };

            string contenuto = JsonConvert.SerializeObject(dizionario, Formatting.Indented);
            logger.LogInformation($"Contenuto: {contenuto}");

            // Valida il form prima di procedere
            await form.Validate();
            if (!form.IsValid)
            {
                message = "Il modulo non è valido. Compila tutti i campi richiesti.";
                return;
            }

            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var request = new HttpRequestMessage(HttpMethod.Post, "cr4f9_filedocumentos")
                    {
                        Content = JsonContent.Create(dizionario)
                    };

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);
                var responseBody = await response.Content.ReadAsStringAsync();
                logger.LogInformation("Payload inviato: {Payload}", contenuto);

                if (response.IsSuccessStatusCode)
                {
                    if (response.Headers.TryGetValues("OData-EntityId", out var entityIdValues))
                    {
                        var entityId = entityIdValues.FirstOrDefault();
                        if (entityId != null)
                        {
                            idFileCreato = entityId.Split('(').LastOrDefault()?.TrimEnd(')');
                            logger.LogInformation($"Record del file creato con successo. ID: {idFileCreato}");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun ID trovato nell'header della risposta.");
                    }
                }
                else
                {
                    message = $"Errore nell'invio: {response.ReasonPhrase}";
                    logger.LogError("Error Api: {StatusCode} - {ReasonPhrase}", response.StatusCode, response.ReasonPhrase);
                    logger.LogError("Dettagli risposta: {ResponseBody}", responseBody);
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante la creazione del record.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError("Errore durante la creazione del record del file: {Error}", ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    // Caricamento del file sul record appena creato
    private async Task CaricaFile(string idFileCreato, IBrowserFile file)
    {
        try
        {
            // Imposta un limite di 10 MB per il file
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            byte[] fileContent = memoryStream.ToArray();

            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                logger.LogInformation($"Token ottenuto: {token.Value}");

                string fileName = file.Name;
                string url = $"{client.BaseAddress}cr4f9_filedocumentos({idFileCreato})/cr4f9_file?x-ms-file-name={Uri.EscapeDataString(fileName)}";
                logger.LogInformation($"URL per il caricamento: {url}");

                var request = new HttpRequestMessage(HttpMethod.Patch, url)
                    {
                        Content = new ByteArrayContent(fileContent)
                    };

                // Forza il Content-Type a application/octet-stream
                request.Content.Headers.ContentType = new MediaTypeHeaderValue("application/octet-stream");

                request.Headers.Add("OData-MaxVersion", "4.0");
                request.Headers.Add("OData-Version", "4.0");
                request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                HttpResponseMessage response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    logger.LogInformation("File caricato con successo.");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    logger.LogError("Errore durante il caricamento del file: {StatusCode}. Dettagli: {ErrorContent}", response.StatusCode, errorContent);
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del file.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError("Eccezione durante il caricamento del file: {Error}", ex.Message);
        }
    }

    // Metodo Submit: crea il record e carica il file se presente
    private async Task Submit()
    {
        if (!string.IsNullOrEmpty(IdCartella))
        {
            var cartellaId = IdCartella;
            var fileRecord = new FileRecord
                {
                    Cartella = cartellaId,
                    Note = noteFile
                };

            await CreaRecordFile(fileRecord);

            if (!string.IsNullOrEmpty(idFileCreato))
            {
                if (fileSelezionato != null)
                {
                    await CaricaFile(idFileCreato, fileSelezionato);
                }
                else
                {
                    logger.LogWarning("Nessun file selezionato per il caricamento.");
                    await DialogService.ShowMessageBox("INFO", "Record inserito con successo senza file", yesText: "Chiudi");
                    MudDialog.Close(DialogResult.Ok(true));
                    Navigation.NavigateTo($"/elencofile/id={IdCartella}&titolo={Titolo}", forceLoad: true);
                    return;
                }

                await DialogService.ShowMessageBox("INFO", "File inserito con successo", yesText: "Chiudi");
                MudDialog.Close(DialogResult.Ok(true));
                Navigation.NavigateTo($"/elencofile/id={IdCartella}&titolo={Titolo}", forceLoad: true);
            }
            else
            {
                logger.LogWarning("ID file non valido. Assicurati che la creazione del record sia riuscita");
                await DialogService.ShowMessageBox("ERRORE", "Record file non inserito", yesText: "Chiudi");
            }
        }
        else
        {
            logger.LogWarning("Nessun id");
        }
    }

    private void Cancel() => MudDialog.Cancel();

    public class FileRecord
    {
        public string Cartella { get; set; }
        public string Note { get; set; }
    }
}
