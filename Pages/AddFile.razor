@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using Newtonsoft.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<AddCartellaDocumenti> logger
@inject NavigationManager Navigation

<MudDialog FullWidth="true" Class="custom-dialog-red-gray">
	<TitleContent>
		<MudStack Direction="row" AlignItems="AlignItems.Center" JustifyContent="Center" Spacing="2">
			<MudIcon Icon="@Icons.Material.Filled.FileCopy" Color="Color.Error" />
			<MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
				Crea Nuovo File
			</MudText>
		</MudStack>
	</TitleContent>

	<DialogContent>
		<MudPaper Class="content-area-red-gray" Elevation="1">
			<MudForm @ref="form" Valid="isFormValid">
				<MudGrid Spacing="2">
					<MudItem xs="12">
						<MudTextField T="string" Label="Nome File" @bind-Value="file.cr4f9_notedocumento" Required="true" Variant="Variant.Outlined"/>
					</MudItem>
				</MudGrid>
			</MudForm>
		</MudPaper>
	</DialogContent>

	<DialogActions>
		<MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
			Annulla
		</MudButton>
		<MudButton OnClick="SalvaFile" Variant="Variant.Filled" Color="Color.Error">
			Salva
		</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter]
	public MudDialogInstance MudDialog { get; set; }

	[Parameter]
	public string IdCartella { get; set; }

	[Parameter]
	public string Titolo { get; set; }

	[Inject]
	private IDialogService DialogService { get; set; }

	private MudForm form;
	private bool isFormValid = false;
	private File file = new();

	private void Cancel() => MudDialog.Cancel();

	private async Task SalvaFile()
	{
		await form.Validate();

		if(!form.IsValid)
		{
			await DialogService.ShowMessageBox("Errore", "Il modulo non è valido. Compila tutti i campi richiesti.");
			return;
		}

		var payload = new Dictionary<string, object>
		{
			{"cr4f9_notedocumento", file.cr4f9_notedocumento},
			{"cr4f9_Cartella@odata.bind", $"/cr4f9_cartelladocumentis({IdCartella})"}
		};

		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			try
			{
				var client = ClientFactory.CreateClient("DataverseClient");
				var request = new HttpRequestMessage(HttpMethod.Post, "cr4f9_filedocumentos")
					{
						Content = JsonContent.Create(payload)
					};

				request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

				var response = await client.SendAsync(request);
				var responseBody = await response.Content.ReadAsStringAsync();
				logger.LogInformation("Payload inviato: {@Payload}", payload);

				if(response.IsSuccessStatusCode)
				{
					await DialogService.ShowMessageBox(
						"INFO",
						"File inserito con successo.",
						yesText: "Chiudi");

					Navigation.NavigateTo($"/elencofile/id={IdCartella}&titolo={Titolo}", forceLoad: true);
				}
				else
				{
					await DialogService.ShowMessageBox("Errore", $"Errore durante il salvataggio: {response.ReasonPhrase}");
					logger.LogError("Errore API: {StatusCode} - {ReasonPhrase}. Dettagli: {ResponseBody}",
						response.StatusCode, response.ReasonPhrase, responseBody);
				}
			}
			catch (Exception ex)
			{
				await DialogService.ShowMessageBox("Errore", "Errore durante il salvataggio della cartella.");
				logger.LogError("Eccezione: {Exception}", ex.Message);
			}
		}
		else
		{
			await DialogService.ShowMessageBox("Errore", "Token non ottenuto.");
		}
	}

	public class File
	{
		public string cr4f9_notedocumento { get; set; }
	}
}