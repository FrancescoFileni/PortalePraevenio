@page "/elencoconsegnedpi"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using ClosedXML.Excel
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<link href="css/consegne-dpi.css?v=1" rel="stylesheet" />

<AuthorizeView>
	<Authorized>

		<!-- TOOLBAR -->
		<MudPaper Class="toolbar" Elevation="1">
			<div class="toolbar-left">
				<MudText Typo="Typo.h5" Class="page-title">CONSEGNE DPI</MudText>
			</div>

			<div class="toolbar-right">
				<MudButton Variant="Variant.Outlined"
						   StartIcon="@Icons.Material.Filled.FileDownload"
						   Color="Color.Success"
						   Class="action-btn"
						   OnClick="DownloadExcel">
					Esporta
				</MudButton>

				<MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
							   Color="Color.Error"
							   OnClick="ToggleFilters"
							   Class="filter-btn" />
			</div>
		</MudPaper>

		<!-- FILTRI -->
		<MudCollapse Expanded="@showFilters">
			<MudPaper Class="filters-panel" Elevation="0">
				<MudGrid GutterSize="8">
					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Nome o Cognome
						</MudText>
						<MudTextField @bind-Value="searchRiepilogo"
									  Placeholder="Cerca per nome o cognome"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Data Consegna
						</MudText>

						<div class="date-range">
							<MudDatePicker @bind-Date="dataTestataFrom"
										   Label="Da"
										   Variant="Variant.Outlined"
										   Class="white-input date-field"
										   Clearable="true" />

							<MudDatePicker @bind-Date="dataTestataTo"
										   Label="A"
										   Variant="Variant.Outlined"
										   Class="white-input date-field"
										   Clearable="true" />
						</div>
					</MudItem>


					<MudItem xs="12" md="4">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Numero Testata
						</MudText>
						<MudTextField @bind-Value="searchNumTestata"
									  Placeholder="Cerca per numero di testata"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>
				</MudGrid>

				<div class="mt-4 filters-actions">
					<MudButton Variant="Variant.Outlined"
							   Color="Color.Primary"
							   StartIcon="@Icons.Material.Filled.Refresh"
							   OnClick="ResetFilters">
						Ripristina
					</MudButton>
				</div>
			</MudPaper>
		</MudCollapse>

		@if (consegne != null)
		{
			<div class="folder-container">
				<div class="folder-tab">Elenco Consegne</div>

				<MudTable T="Consegna"
						  Items="consegne.value"
						  Filter="ToggleFunc"
						  Dense="true"
						  Hover="true"
						  Class="modern-table">

					<HeaderContent>
						<MudTh Style="width: 42px;"></MudTh>
						<MudTh>Id Testata</MudTh>
						<MudTh>Data Consegna</MudTh>
						<MudTh>Lavoratore</MudTh>
					</HeaderContent>

					<RowTemplate Context="consegna">
						<!-- colonna azione -->
						<MudTd Style="width: 42px;">
							<MudIconButton Icon="@Icons.Material.Filled.ViewList"
										   Class="row-action-btn"
										   @ref="@(refMap[consegna.cr4f9_testataconsegnaid.Value])"
										   OnClick="@(async () => await ShowPopover(consegna.cr4f9_testataconsegnaid))" />

							<MudPopover Open="@popoverStates[consegna.cr4f9_testataconsegnaid.Value]"
										AnchorOrigin="Origin.BottomLeft"
										Elevation="8"
										Class="popover-dpi"
										OpenChanged="(val) => popoverStates[consegna.cr4f9_testataconsegnaid.Value] = val"
										AnchorReference="refMap[consegna.cr4f9_testataconsegnaid.Value]">

								@if (dpiPerTestata.ContainsKey(consegna.cr4f9_testataconsegnaid))
								{
									<MudTable Dense="true"
											  Items="dpiPerTestata[consegna.cr4f9_testataconsegnaid]"
											  Class="popover-table">

										<HeaderContent>
											<MudTh>Nome DPI</MudTh>
											<MudTh>Matricola</MudTh>
											<MudTh>Data</MudTh>
											<MudTh>Quantità</MudTh>
										</HeaderContent>

										<RowTemplate Context="dpi">
											<MudTd>@dpi.nome</MudTd>
											<MudTd>@dpi.cr4f9_numerodimatricola</MudTd>
											<MudTd>@dpi.cr4f9_datadiconsegna.ToString("dd/MM/yyyy")</MudTd>
											<MudTd>@dpi.cr4f9_quantita</MudTd>
										</RowTemplate>
									</MudTable>
								}
								else
								{
									<MudText Color="Color.Secondary">Nessun DPI associato.</MudText>
								}
							</MudPopover>
						</MudTd>

						<!-- id testata -->
						<MudTd>
							<MudLink Href="@($"/dettaglioTestataDpi/id={consegna.cr4f9_testataconsegnaid}")"
									 Class="name-link">
								@consegna.cr4f9_idtestata
							</MudLink>
						</MudTd>

						<MudTd>@consegna.cr4f9_dataconsegna?.ToString("dd/MM/yyyy")</MudTd>
						<MudTd>@consegna.Nome</MudTd>
					</RowTemplate>

					<PagerContent>
						<MudTablePager PageSizeOptions="new int[]{10, 20}" />
					</PagerContent>
				</MudTable>
			</div>
		}
		else
		{
			<p><em>@message</em></p>
		}

	</Authorized>

	<NotAuthorized>
		<h3>Authentication Failure!</h3>
		<p>You're not signed in.</p>
	</NotAuthorized>
</AuthorizeView>

@code {
    private ConsegneCollection consegne;
    private string message = "Loading...";
    private string clienteId;
    private Guid? azienda;
    private string userName;
    private string userEmail;
    private string fetchXmlQuery;
    private bool showFilters = false;
    private List<ConsegnaDpi> consegneDpi = new List<ConsegnaDpi>();
    private DateTime? dataTestataFrom;
    private DateTime? dataTestataTo;
    private string searchRiepilogo = "";
    private string searchNumTestata = "";
    private HashSet<Guid?> expandedRows = new HashSet<Guid?>();
    private Dictionary<Guid?, List<ConsegnaDpi>> dpiPerTestata = new();

    private Dictionary<Guid, bool> popoverStates = new();
    private Dictionary<Guid, MudIconButton> refMap = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation();

        if (string.IsNullOrEmpty(clienteId))
        {
            message = "Cliente non trovato.";
            return;
        }

        fetchXmlQuery = $@"
        <fetch>
          <entity name='cr4f9_testataconsegna'>
            <attribute name='cr4f9_idtestata' />
            <attribute name='cr4f9_testataconsegnaid' />
            <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' link-type='inner' alias='Lavoratore'>
              <attribute name='cr4f9_cognomeenomecalcolato' alias='Nome' />
            </link-entity>
            <attribute name='cr4f9_dataconsegna' />
            <filter>
              <condition attribute='cr4f9_cliente' operator='eq' value='{azienda}' />
            </filter>
          </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_testataconsegnas?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}");

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                consegne = await response.Content.ReadFromJsonAsync<ConsegneCollection>();

                popoverStates = consegne?.value?.ToDictionary(c => c.cr4f9_testataconsegnaid.GetValueOrDefault(), c => false) ?? new();
                refMap = new Dictionary<Guid, MudIconButton>();
                foreach (var consegna in consegne.value)
                {
                    var id = consegna.cr4f9_testataconsegnaid.GetValueOrDefault();
                    if (!refMap.ContainsKey(id))
                        refMap.Add(id, null);
                }
            }
            else
            {
                message = "An error occurred while fetching data.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
    }

    private bool ToggleFunc(Consegna testata)
    {
        bool matches = true;

        if(!string.IsNullOrWhiteSpace(searchRiepilogo))
        {
            matches &= testata.Nome != null && testata.Nome.ToLower().Contains(searchRiepilogo.ToLower());
        }

        if (!string.IsNullOrWhiteSpace(searchNumTestata))
        {
            matches &= testata.cr4f9_idtestata != null && testata.cr4f9_idtestata.ToLower().Contains(searchNumTestata.ToLower());
        }

        if(dataTestataFrom.HasValue)
        {
            matches &= testata.cr4f9_dataconsegna >= dataTestataFrom.Value;
        }

        if(dataTestataTo.HasValue)
        {
            matches &= testata.cr4f9_dataconsegna <= dataTestataTo.Value;
        }

        return matches;
    }

    private void ResetFilters()
    {
        searchRiepilogo = string.Empty;
        searchNumTestata = string.Empty;
        dataTestataFrom = null;
        dataTestataTo = null;
    }

    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);

            await CaricaClienteAssociato(userEmail);
        }
    }

    private void ToggleFilters() => showFilters = !showFilters;

    private Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };

        return DialogService.ShowAsync<AddTestataConsegne>("Simple Dialog", options);
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = System.Text.Json.JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new System.Text.Json.JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private async Task LoadConsegneDpi(Guid? testataId)
    {
        if (testataId == null || dpiPerTestata.ContainsKey(testataId))
            return;

        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var fetchXmlConsegne = $@"
            <fetch>
              <entity name='cr4f9_associazionedpialavoratore'>
                <link-entity name='cr4f9_dpifisico' from='cr4f9_dpifisicoid' to='cr4f9_dpifisico' link-type='inner' alias='DPI'>
                  <attribute name='cr4f9_nomedeldispositivofisico' alias='nome' />
                </link-entity>
                <attribute name='cr4f9_datadiconsegna' />
                <attribute name='cr4f9_quantita' />
                <attribute name='cr4f9_numerodimatricola' />
                <filter>
                  <condition attribute='cr4f9_riferimentotestata' operator='eq' value='{testataId}' />
                </filter>
              </entity>
            </fetch>";

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_associazionedpialavoratores?fetchXml={Uri.EscapeDataString(fetchXmlConsegne)}")
                };
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            var resultJson = await response.Content.ReadAsStringAsync();
            logger.LogInformation($"Risposta JSON: {resultJson}");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ConsegnaCollection>();
                if (result?.value?.Length > 0)
                {
                    dpiPerTestata[testataId] = result.value.ToList(); // Salviamo i dati nel dizionario
                }
                else
                {
                    dpiPerTestata[testataId] = new List<ConsegnaDpi>(); // Se vuoto, evitiamo problemi
                }
            }
            else
            {
                logger.LogError($"Errore nel recupero delle consegne DPI: {response.ReasonPhrase}");
            }
        }
        else
        {
            logger.LogError("Token non ottenuto.");
        }
    }


    private async Task DownloadExcel()
    {
        // Creo un file Excel in memoria utilizzando ClosedXML
        using var workbook = new XLWorkbook();
        // Creo un unico foglio per tutte le consegne
        var sheet = workbook.Worksheets.Add("Consegne DPI");

        // Imposto l'intestazione delle colonne
        sheet.Cell(1, 1).Value = "ID Testata";
        sheet.Cell(1, 2).Value = "Nome Consegna";
        sheet.Cell(1, 3).Value = "Numero di Matricola";
        sheet.Cell(1, 4).Value = "Data Consegna";
        sheet.Cell(1, 5).Value = "Lavoratore";
        sheet.Range("A1:E1").Style.Font.Bold = true;

        int row = 2;

        // Itero su ogni testata di consegna
        foreach (var testata in consegne.value.Where(ToggleFunc))
        {
            // Azzero la lista delle consegne DPI per ogni testata
            consegneDpi.Clear();

            // Carico le consegne DPI relative alla testata specifica
            await LoadConsegneDpi(testata.cr4f9_testataconsegnaid);

            if (consegneDpi.Count > 0)
            {
                // Se sono presenti consegne DPI, scrivo una riga per ciascuna
                foreach (var dpi in consegneDpi)
                {
                    sheet.Cell(row, 1).Value = testata.cr4f9_idtestata;
                    sheet.Cell(row, 2).Value = dpi.nome;
                    sheet.Cell(row, 3).Value = dpi.cr4f9_numerodimatricola;
                    sheet.Cell(row, 4).Value = dpi.cr4f9_datadiconsegna.ToString("dd/MM/yyyy");
                    sheet.Cell(row, 5).Value = testata.Nome;
                    row++;
                }
            }
            else
            {
                // Se non ci sono consegne DPI per la testata, aggiungo una riga con i dati della testata
                sheet.Cell(row, 1).Value = testata.cr4f9_idtestata;
                sheet.Cell(row, 5).Value = testata.Nome;
                row++;
            }
        }

        // Salvo il file in un MemoryStream e lancio il download
        using (var stream = new MemoryStream())
        {
            workbook.SaveAs(stream);
            var fileBytes = stream.ToArray();
            var fileName = "ConsegneDPI.xlsx";
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileBytes, fileName);
        }
    }

    private void ToggleRow(Guid? id)
    {
        if (expandedRows.Contains(id))
            expandedRows.Remove(id);
        else
            expandedRows.Add(id);
    }

    private async Task ShowPopover(Guid? testataId)
    {
        if (testataId == null) return;

        if (!dpiPerTestata.ContainsKey(testataId))
            await LoadConsegneDpi(testataId);

        // Verifica se il popover è già aperto
        if (popoverStates.ContainsKey(testataId.Value) && popoverStates[testataId.Value])
        {
            // Se il popover è già aperto, lo chiudiamo
            popoverStates[testataId.Value] = false;
        }
        else
        {
            // Altrimenti, chiudiamo tutti i popover e apriamo quello specifico
            foreach (var key in popoverStates.Keys.ToList())
                popoverStates[key] = false;

            popoverStates[testataId.Value] = true;
        }
    }


    public class Consegna
    {
        public string cr4f9_idtestata { get; set; }
        public string Nome { get; set; }
        public DateTime? cr4f9_dataconsegna { get; set; }
        public Guid? cr4f9_testataconsegnaid { get; set; } //questo è il vero guid

        public string checkDate => cr4f9_dataconsegna?.ToString("dd/MM/yyyy");
    }

    public class ConsegneCollection
    {
        public Consegna[] value { get; set; }
    }

    public class ConsegnaDpi
    {
        public string nome { get; set; }
        public DateTime cr4f9_datadiconsegna { get; set; }
        public int cr4f9_quantita { get; set; }
        public string cr4f9_numerodimatricola { get; set; }
    }

    public class ConsegnaCollection
    {
        public ConsegnaDpi[] value { get; set; }
    }
}
