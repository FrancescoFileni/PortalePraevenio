
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using MudBlazor
@using System.Text
@using System.Text.Json
@using Newtonsoft.Json;
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<MudDialog FullWidth="true" Class="custom-dialog-red-gray">
    <TitleContent>
        <MudStack Direction="Row" Align="Center" JustifyContent="Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Color="Color.Error" />
            <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
                Inserisci nuova visita medica
            </MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudPaper Class="content-area-red-gray" Elevation="1">
            <!-- MudForm per la validazione -->
            <MudForm @ref="form" Valid="isFormValid">
                <!-- Prima riga: Lavoratore -->
                <MudGrid>
                    <MudItem xs="12">
                        <MudSelect Variant="Variant.Outlined" T="Lavoratore" Label="Lavoratore" MultiSelection="false"
                        @bind-Value="@selectedLavoratore" @onchange="OnLavoratoreChanged" Required="true"
                        Virtualized="true" Searchable="true" Class="custom-select" AnchorOrigin="Origin.BottomCenter" Placeholder="Seleziona lavoratore">
                            @foreach (var lavoratore in lavoratoriOrdinati.value)
                            {
                                <MudSelectItem Value="@lavoratore">
                                    @lavoratore.cr4f9_calcolonomeecognome
                                </MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>

                <!-- Seconda riga: Tipologia visita e Carica dati visita -->
                <MudGrid>
                    <MudItem xs="6">
                        <MudSelect @bind-Value="@tipologiaVisita" Variant="Variant.Outlined" T="int?" Label="Tipologia visita" MultiSelection="false" Required="true" Placeholder="Seleziona tipologia visita" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem T="int?" Value="preassuntiva">Preassuntiva</MudSelectItem>
                            <MudSelectItem T="int?" Value="periodica">Periodica</MudSelectItem>
                            <MudSelectItem T="int?" Value="suRichiesta">Su richiesta</MudSelectItem>
                            <MudSelectItem T="int?" Value="rientro">Rientro da malattia/infortunio</MudSelectItem>
                            <MudSelectItem T="int?" Value="fineRapporto">Fine rapporto</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="6" class="d-flex align-items-center">
                        <MudButton Class="mud-button" OnClick="CaricaDatiVisita" Variant="Variant.Filled" Color="Color.Error" Style="height: 40px; margin-left: 16px;">
                            Carica dati visita medica
                        </MudButton>
                    </MudItem>
                </MudGrid>

                <!-- Terza riga: Accertamenti, Periodicità e Durata visita -->
                <MudGrid>
                    <!-- Accertamenti occupa metà della riga -->
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" Label="Accertamenti" @bind-Value="@elencopuntato" Variant="Variant.Outlined" Lines="5"
                        Class="form-field" Required="true" />
                    </MudItem>
                    <!-- Periodicità e Durata occupano la seconda metà -->
                    <MudItem xs="12" md="6">
                        <!-- Periodicità -->
                        <MudTextField T="string" @bind-Value="@periodicitaStringa" Label="Periodicità" Variant="Variant.Outlined"
                        Class="form-field" Lines="1" Required="true" />
                        <!-- Spaziatura verticale -->
                        <div style="margin-top: 16px;"></div>
                        <!-- Durata del controllo -->

                        <MudNumericField @bind-Value="durataControllo" Label="Durata del controllo (minuti)" Variant="Variant.Outlined" Min="0" Max="400"
                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Timer"
                        Class="form-field" Required="true" />
                    </MudItem>
                </MudGrid>



                <!-- Quarta riga: Data visita e Data prossima visita -->
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Data visita" @bind-Date="dataVisita" Orientation="Orientation.Landscape"
                        Color="Color.Error" Required="true" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudDatePicker Label="Data prossima visita" @bind-Date="dataProssimaVisita" Orientation="Orientation.Landscape"
                        Color="Color.Error" Required="true" />
                    </MudItem>
                </MudGrid>

                <!-- Quinta riga: Esito visita e Carica certificato -->
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect Variant="Variant.Outlined" @bind-Value="@esitoVisita" T="int?" Label="Esito visita" MultiSelection="false" PlaceHolder="Seleziona esito visita" Required="true" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem T="int?" Value="idoneo">Idoneo</MudSelectItem>
                            <MudSelectItem T="int?" Value="idoneoPrescrizioni">Idoneo con prescrizioni</MudSelectItem>
                            <MudSelectItem T="int?" Value="idoneoLimitazioni">Idoneo con limitazioni</MudSelectItem>
                            <MudSelectItem T="int?" Value="nonidoneoTemp">Non idoneo temporaneamente</MudSelectItem>
                            <MudSelectItem T="int?" Value="nonIdoneoPerm">Non idoneo permanentemente</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6" class="d-flex align-items-center">
                        <MudFileUpload T="IBrowserFile" OnFilesChanged="HandleFileSelected">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.CloudUpload"
                                Style="height: 40px; margin-left: 16px;">
                                    Carica certificato
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudItem>
                </MudGrid>

                <!-- Sesta riga: Note del medico e Sede visita -->
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" @bind-Value="noteMedico" Label="Note del medico" Variant="Variant.Outlined" Lines="5"
                        Class="form-field" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField T="string" @bind-Value="sedeVisita" Label="Sede della visita" Variant="Variant.Outlined" Lines="5"
                        Class="form-field" />
                    </MudItem>
                </MudGrid>

            </MudForm>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
            Annulla
        </MudButton>
        <MudButton Color="Color.Error" OnClick="Submit" Variant="Variant.Filled">
            Conferma
        </MudButton>
    </DialogActions>
</MudDialog>






@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }
    private MudForm form;

    private Lavoratore selectedLavoratore;
    private LavoratoreCollection lavoratori = new LavoratoreCollection { value = Array.Empty<Lavoratore>() };
    private LavoratoreCollection lavoratoriOrdinati = new LavoratoreCollection { value = Array.Empty<Lavoratore>() };
    private List<Mansione> mansioni = new List<Mansione>();
    private List<FattoreDiRischio> fattori = new List<FattoreDiRischio>();
    private List<Accertamenti> accertamenti = new List<Accertamenti>();
    private bool isLoading = false;
    IList<IBrowserFile> _files = new List<IBrowserFile>();


    private string message = "Loading...";
    private string userName;
    private string userEmail;
    private string fetchXmlQuery;
    private Guid? azienda;
    private string clienteId;
    private int? tipologiaVisita;


    private string elencopuntato;
    private int preassuntiva = 644840000;
    private int periodica = 644840001;
    private int suRichiesta = 644840002;
    private int rientro = 644840003;
    private int fineRapporto = 644840004;
    private int? esitoVisita;
    private int idoneo = 644840000;
    private int idoneoPrescrizioni = 644840001;
    private int idoneoLimitazioni = 644840002;
    private int nonidoneoTemp = 644840003;
    private int nonIdoneoPerm = 644840004;
    private int periodicitaMinima;
    private string periodicitaStringa;
    private int durataControllo;
    private DateTime? dataVisita;
    private DateTime? dataProssimaVisita;
    private string noteMedico;
    private string sedeVisita;
    private IBrowserFile? fileSelezionato;
    private string idVisitaCreata;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); // Chiama il metodo per caricare le informazioni dell'utente

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
        <fetch>
            <entity name='cr4f9_contattoprv'>
                <attribute name='cr4f9_calcolonomeecognome' />
                <attribute name='cr4f9_contattoprvid' /> <!-- Aggiunto il campo -->
                <link-entity name='new_lavorapressoprv' from='new_lavoratore' to='cr4f9_contattoprvid' alias='lavoraPresso'>
                    <filter>
                        <condition attribute='cr4f9_inforza' operator='eq' value='1' />
                    </filter>
                    <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                        <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                            <filter>
                                <condition attribute='new_email' operator='eq' value='{userEmail}' />
                            </filter>
                        </link-entity>
                    </link-entity>
                </link-entity>
            </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                lavoratori = await response.Content.ReadFromJsonAsync<LavoratoreCollection>();
                lavoratoriOrdinati.value = lavoratori.value.OrderBy(l => l.cr4f9_calcolonomeecognome).ToArray();
                logger.LogInformation($"Lista lavoratori caricata");
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);

            await CaricaClienteAssociato(userEmail);
        }
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private async Task CaricaMansioniAssociato(Lavoratore selectedLavoratore, string azienda)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");
                var fetchXml = BuildMansioniFetchXml(selectedLavoratore, azienda);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_lavorapressoprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");


                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();
                    var jsonDocument = JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        mansioni.Clear(); // Pulisci la lista prima di popolarla
                        foreach (var entity in entities.EnumerateArray())
                        {
                            if (entity.TryGetProperty("Mansione", out var mansioneProperty))
                            {
                                var mansione = new Mansione
                                    {
                                        cr4f9_mansione = mansioneProperty.GetString()
                                    };

                                mansioni.Add(mansione);
                                logger.LogInformation($"Mansione trovata: {mansione.cr4f9_mansione}");
                            }
                            else
                            {
                                logger.LogWarning("Il campo 'Mansione' non è presente nel record.");
                            }
                        }
                        if (mansioni.Count > 0)
                        {
                            logger.LogInformation("Lista delle mansioni:");
                            foreach (var mansione in mansioni)
                            {
                                logger.LogInformation($"- {mansione.cr4f9_mansione}");
                            }
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per il lavoratore e l'azienda forniti.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero delle mansioni: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento delle mansioni.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento delle mansioni: {ex.Message}");
        }
    }

    private async Task CaricaFattoriDiRischio(List<Mansione> mansioni)
    {
        try
        {

            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                foreach (var mansione in mansioni)
                {
                    logger.LogInformation($"Mansione inserita nella fetch: {mansione.cr4f9_mansione}");
                    var fetchXml = BuildFattoriDiRischioFetchXml(mansione); // Costruzione della query

                    var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_fattoredirischios?fetchXml={Uri.EscapeDataString(fetchXml)}");
                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                    var response = await client.SendAsync(request);

                    if (response.IsSuccessStatusCode)
                    {
                        var responseBody = await response.Content.ReadAsStringAsync();
                        var jsonDocument = JsonDocument.Parse(responseBody);
                        var entities = jsonDocument.RootElement.GetProperty("value");

                        logger.LogInformation("FETCH: " + fetchXml);

                        if (entities.GetArrayLength() > 0)
                        {
                            foreach (var entity in entities.EnumerateArray())
                            {
                                if (entity.TryGetProperty("cr4f9_fattoredirischio", out var fattoreProperty) &&
                                            entity.TryGetProperty("cr4f9_fattoredirischioid", out var fattoreIdProperty))
                                {
                                    var fattore = new FattoreDiRischio
                                        {
                                            cr4f9_fattoredirischio = fattoreProperty.GetString(),
                                            cr4f9_fattoredirischioid = fattoreIdProperty.GetString()
                                        };

                                    logger.LogInformation($"- {fattore.cr4f9_fattoredirischio}");
                                    logger.LogInformation($"- {fattore.cr4f9_fattoredirischioid}");

                                    fattori.Add(fattore);
                                    logger.LogInformation($"Fattore di rischio trovato: {fattore.cr4f9_fattoredirischioid}");
                                }
                                else
                                {
                                    logger.LogWarning("Almeno una delle proprietà 'cr4f9_fattoredirischio' o 'cr4f9_fattoredirischioid' non è presente nel record.");
                                }


                            }
                        }
                        else
                        {
                            logger.LogWarning($"Nessun fattore di rischio trovato per la mansione: {mansione.cr4f9_mansione}");
                        }
                    }
                    else
                    {
                        logger.LogError($"Errore durante il caricamento dei fattori di rischio per la mansione {mansione.cr4f9_mansione}: {response.ReasonPhrase}");
                    }
                }

                // Stampa i fattori di rischio trovati
                if (fattori.Count > 0)
                {
                    logger.LogInformation("Lista dei fattori di rischio:");
                    foreach (var fattore in fattori)
                    {
                        logger.LogInformation($"- {fattore.cr4f9_fattoredirischioid}");
                    }
                }
                else
                {
                    logger.LogWarning("Nessun fattore di rischio trovato.");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento dei fattori di rischio.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento dei fattori di rischio: {ex.Message}");
        }
    }

    private async Task CaricaAccertamenti(List<FattoreDiRischio> fattori)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                foreach (var fattore in fattori)
                {
                    logger.LogInformation($"Fattore di rischio inserito nella fetch: {fattore.cr4f9_fattoredirischio}");

                    var fetchXml = BuildAccertamentiFetchXml(fattore);

                    var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_accertamentos?fetchXml={Uri.EscapeDataString(fetchXml)}");
                    request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                    var response = await client.SendAsync(request);

                    if (response.IsSuccessStatusCode)
                    {
                        var responseBody = await response.Content.ReadAsStringAsync();
                        var jsonDocument = JsonDocument.Parse(responseBody);
                        var entities = jsonDocument.RootElement.GetProperty("value");

                        logger.LogInformation("FETCH: " + fetchXml);

                        if (entities.GetArrayLength() > 0)
                        {
                            foreach (var entity in entities.EnumerateArray())
                            {
                                if (entity.TryGetProperty("cr4f9_accertamento", out var accertamentoProperty) &&
                                    entity.TryGetProperty("cr4f9_accertamentoid", out var accertamentoIdProperty) &&
                                    entity.TryGetProperty("cr4f9_periodicitaunder50", out var periodicitaProperty))
                                {
                                    var accertamento = new Accertamenti
                                        {
                                            cr4f9_accertamento = accertamentoProperty.GetString(),
                                            cr4f9_accertamentoid = accertamentoIdProperty.GetString(),
                                            cr4f9_periodicitaunder50 = periodicitaProperty.GetInt32(), // Aggiungiamo la periodicità
                                        };

                                    logger.LogInformation($"- {accertamento.cr4f9_accertamento}");
                                    logger.LogInformation($"- {accertamento.cr4f9_accertamentoid}");
                                    logger.LogInformation($"- {accertamento.cr4f9_periodicitaunder50}"); // Log della periodicità

                                    accertamenti.Add(accertamento);
                                    logger.LogInformation($"Accertamento trovato: {accertamento.cr4f9_accertamentoid}");
                                }
                                else
                                {
                                    logger.LogWarning("Almeno una delle proprietà 'cr4f9_accertamento', 'cr4f9_accertamentoid' o 'cr4f9_periodicitaunder50' non è presente nel record.");
                                }
                            }
                            periodicitaMinima = AggiornaPeriodicitaMinima(accertamenti,periodicitaMinima);
                            periodicitaStringa = periodicitaMinima.ToString();
                            elencopuntato = CreaElencoPuntatoAccertamenti(accertamenti);
                            durataControllo = 20;
                            dataVisita = DateTime.Today;
                            dataProssimaVisita = dataVisita.Value.AddMonths(periodicitaMinima);
                        }
                        else
                        {
                            logger.LogWarning($"Nessun accertamento trovato per il fattore di rischio: {fattore.cr4f9_fattoredirischio}");
                        }
                    }
                    else
                    {
                        logger.LogError($"Errore durante il caricamento degli accertamenti per il fattore di rischio {fattore.cr4f9_fattoredirischio}: {response.ReasonPhrase}");
                    }
                }

                // Stampa gli accertamenti trovati
                if (accertamenti.Count > 0)
                {
                    logger.LogInformation("Lista degli accertamenti:");
                    foreach (var accertamento in accertamenti)
                    {
                        logger.LogInformation($"- {accertamento.cr4f9_accertamentoid}");
                        logger.LogInformation($"- Periodicità: {accertamento.cr4f9_periodicitaunder50}");
                    }
                }
                else
                {
                    logger.LogWarning("Nessun accertamento trovato.");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento degli accertamenti.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento degli accertamenti: {ex.Message}");
        }
    }

    private string CreaElencoPuntatoAccertamenti(List<Accertamenti> accertamenti)
    {
        var elencoPuntato = new StringBuilder();
        var accertamentiAggiunti = new HashSet<string>();  // HashSet per evitare duplicati
        string elencoAccertamenti = "";

        elencopuntato = "";
        elencoPuntato.AppendLine("");

        foreach (var accertamento in accertamenti)
        {
            // Aggiungi l'accertamento all'HashSet se non è già presente
            if (accertamentiAggiunti.Add(accertamento.cr4f9_accertamento))
            {
                elencoPuntato.AppendLine($"• {accertamento.cr4f9_accertamento} \n");
            }
        }

        elencoAccertamenti = elencoPuntato.ToString();

        logger.LogInformation(elencoAccertamenti);

        return elencoAccertamenti;
    }


    private int AggiornaPeriodicitaMinima(List<Accertamenti> accertamenti, int periodicita)
    {

        if (accertamenti == null || accertamenti.Count == 0)
        {
            logger.LogWarning("La lista degli accertamenti è vuota.");
            return periodicita = 0;
        }


        int periodicitaMinima = int.MaxValue;


        foreach (var accertamento in accertamenti)
        {

            if (accertamento.cr4f9_periodicitaunder50 < periodicitaMinima)
            {
                periodicitaMinima = accertamento.cr4f9_periodicitaunder50;
            }
        }


        if (periodicitaMinima != int.MaxValue)
        {
            periodicita = periodicitaMinima;
            logger.LogInformation($"Periodicità aggiornata a {periodicita}.");
        }
        else
        {
            logger.LogWarning("Non è stato possibile trovare una periodicità valida.");
        }
        return periodicita;
    }

    private async Task CaricaDatiVisita()
    {
        try
        {
            if (selectedLavoratore != null)
            {
                logger.LogInformation($"Caricamento dei dati per il lavoratore: {selectedLavoratore}");

                // Carica i dati necessari
                await CaricaMansioniAssociato(selectedLavoratore, clienteId);
                await CaricaFattoriDiRischio(mansioni);
                await CaricaAccertamenti(fattori);

                logger.LogInformation($"{elencopuntato}");
                StateHasChanged();

            }
            else
            {
                logger.LogWarning("Nessun lavoratore selezionato.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Errore durante l'aggiornamento degli accertamenti: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private string BuildMansioniFetchXml(Lavoratore selectedLavoratore, string azienda) {
        return $@"
        <fetch>
          <entity name='new_lavorapressoprv'>
            <attribute name='cr4f9_mansione' alias='Mansione' />
              <filter>
                <condition attribute='new_lavoratore' operator='eq' value='{selectedLavoratore.cr4f9_contattoprvid}' uitype='cr4f9_contattoprv' />
                <condition attribute='new_azienda' operator='eq' value='{azienda}' uiname='0.3 S.R.L.' uitype='cr4f9_clienteprv' />
              </filter>
          </entity>
        </fetch>";
    }

    private string BuildFattoriDiRischioFetchXml(Mansione mansione)
    {
        return $@"
    <fetch>
      <entity name='cr4f9_fattoredirischio'>
        <attribute name='cr4f9_fattoredirischio' />
        <attribute name='cr4f9_fattoredirischioid' />
        <link-entity name='cr4f9_new_mansionetabellamaster_cr4f9_fattore' from='cr4f9_fattoredirischioid' to='cr4f9_fattoredirischioid' link-type='inner'>
          <filter>
            <condition attribute='new_mansionetabellamasterid' operator='eq' value='{mansione.cr4f9_mansione}' />
          </filter>
        </link-entity>
      </entity>
    </fetch>";
    }

    public string BuildAccertamentiFetchXml(FattoreDiRischio fattore)
    {
        return $@"
    <fetch>
      <entity name='cr4f9_accertamento'>
        <attribute name='cr4f9_accertamento'/>
        <attribute name='cr4f9_periodicitaunder50' />
        <link-entity name='cr4f9_accertamento_cr4f9_fattoredirisch' from='cr4f9_accertamentoid' to='cr4f9_accertamentoid' link-type='inner'>
          <attribute name='cr4f9_fattoredirischioid' />
          <attribute name='cr4f9_accertamentoid' />
          <filter>
            <condition attribute='cr4f9_fattoredirischioid' operator='eq' value='{fattore.cr4f9_fattoredirischioid}' />
          </filter>
        </link-entity>
      </entity>
    </fetch>";
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        // Accedi alla lista di file selezionati
        var files = e.GetMultipleFiles();

        fileSelezionato = files?.FirstOrDefault();

        if (fileSelezionato != null)
        {
            logger.LogInformation($"File selezionato: {fileSelezionato.Name}, Dimensione: {fileSelezionato.Size} bytes");
            // Puoi processare il file qui
        }
        else
        {
            logger.LogWarning("Nessun file selezionato.");
        }

        await Task.CompletedTask;
    }


    private async Task CreaVisitaMedica(VisitaMedica visitaMedica)
    {
        try
        {
            isLoading = true;
            logger.LogInformation($"Azienda reference: {azienda.ToString()}");

            var dizionario = new Dictionary<string, object>
            {
                { "cr4f9_Lavoratore@odata.bind", $"/cr4f9_contattoprvs({visitaMedica.Lavoratore})" },
                { "cr4f9_tipologiadivisita", visitaMedica.TipologiaVisita },
                { "cr4f9_accertamenti", visitaMedica.Accertamenti },
                { "cr4f9_periodicita", visitaMedica.Periodicita },
                { "cr4f9_duratavisita", visitaMedica.DurataVisita },
                { "cr4f9_datavisita", visitaMedica.DataVisita },
                { "cr4f9_dataprossimavisita", visitaMedica.DataProssimaVisita },
                { "cr4f9_esitodellavisita", visitaMedica.EsitoVisita },
                { "cr4f9_notedelmedico", visitaMedica.NoteMedico },
                { "cr4f9_sedevisita", visitaMedica.SedeVisita },
            };

            string contenuto = JsonConvert.SerializeObject(dizionario, Formatting.Indented);

            logger.LogInformation($"Contenuto : {contenuto}");

            await form.Validate();

            if (!form.IsValid)
            {
                message = "Il modulo non è valido. Compila tutti i campi richiesti.";
                isLoading = false;
                return;
            }
            // Ottieni il token di accesso
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var request = new HttpRequestMessage(HttpMethod.Post, "cr4f9_visitamedicadellavoratores")
                    {
                        Content = JsonContent.Create(contenuto)
                    };

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);
                var responseBody = await response.Content.ReadAsStringAsync();
                logger.LogInformation("Payload inviato: {@contenuto}");


                if (response.IsSuccessStatusCode)
                {
                    // Recupera l'header "OData-EntityId" o un header simile che contiene l'URL del record creato
                    if (response.Headers.TryGetValues("OData-EntityId", out var entityIdValues))
                    {
                        var entityId = entityIdValues.FirstOrDefault();

                        if (entityId != null)
                        {
                            // Estrai l'ID dal valore dell'header
                            idVisitaCreata = entityId.Split('(').LastOrDefault()?.TrimEnd(')');
                            logger.LogInformation($"Record della visita medica creato con successo. ID: {idVisitaCreata}");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun ID trovato nell'header della risposta.");
                    }

                    visitaMedica = new();
                }
                else
                {
                    message = $"Errore nell'invio: {response.ReasonPhrase}";
                    logger.LogError($"Errore API: {response.StatusCode} - {response.ReasonPhrase}");
                    logger.LogError($"Dettagli risposta: {responseBody}");
                }

            }
            else
            {
                logger.LogError("Errore di autenticazione durante la creazione del record.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Errore durante la creazione del record della visita medica: {ex.Message}");
        }
        isLoading = false;
    }

    private async Task CaricaCertificato(string idVisitaCreata, IBrowserFile file)
    {
        try
        {
            using var stream = file.OpenReadStream();
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            byte[] fileContent = memoryStream.ToArray();

            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                // Log per controllare il token
                logger.LogInformation($"Token ottenuto: {token.Value}");

                string fileName = file.Name;
                string url = $"{client.BaseAddress}cr4f9_visitamedicadellavoratores({idVisitaCreata})/cr4f9_certificato?x-ms-file-name={fileName}";
                logger.LogInformation($"URL per il caricamento: {url}");

                var request = new HttpRequestMessage(HttpMethod.Patch, url)
                    {
                        Content = new ByteArrayContent(fileContent)
                    };

                request.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/octet-stream");
                request.Headers.Add("OData-MaxVersion", "4.0");
                request.Headers.Add("OData-Version", "4.0");
                request.Headers.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json"));
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                HttpResponseMessage response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    logger.LogInformation("Certificato caricato con successo.");
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    logger.LogError($"Errore durante il caricamento del certificato: {response.StatusCode}. Dettagli: {errorContent}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del certificato.");
            }

        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del certificato: {ex.Message}");
        }
    }

    private void OnLavoratoreChanged()
    {
        if (selectedLavoratore != null)
        {
            var contattoId = selectedLavoratore.cr4f9_contattoprvid;
            logger.LogInformation($"Lavoratore selezionato: {selectedLavoratore.cr4f9_calcolonomeecognome}, Contatto ID: {contattoId}");
        }
    }

    private async Task Submit()
    {
        if (selectedLavoratore != null)
        {
            var contattoId = selectedLavoratore.cr4f9_contattoprvid;

            logger.LogInformation($"Lavoratore selezionato: {selectedLavoratore.cr4f9_calcolonomeecognome}, Contatto ID: {contattoId}");

            var visitaMedica = new VisitaMedica
                {
                    Lavoratore = contattoId,
                    TipologiaVisita = tipologiaVisita,
                    Accertamenti = elencopuntato,
                    Periodicita = periodicitaStringa,
                    DurataVisita = durataControllo,
                    DataVisita = DateTime.Today.AddDays(1),
                    DataProssimaVisita = DateTime.Today.AddMonths(periodicitaMinima).AddDays(1),
                    EsitoVisita = esitoVisita,
                    NoteMedico = noteMedico,
                    SedeVisita = sedeVisita,
                };

            await CreaVisitaMedica(visitaMedica);

            if (!string.IsNullOrEmpty(idVisitaCreata) && fileSelezionato != null)
            {
                await CaricaCertificato(idVisitaCreata, fileSelezionato);
            }
            else
            {
                if (string.IsNullOrEmpty(idVisitaCreata))
                    logger.LogWarning("ID visita non valido. Assicurati che la creazione della visita sia riuscita.");

                if (fileSelezionato == null)
                    logger.LogWarning("Nessun file selezionato per il caricamento.");
            }

            MudDialog.Close(DialogResult.Ok(true));
            await JSRuntime.InvokeVoidAsync("alert", "VISITA MEDICA AGGIUNTA CORRETTAMENTE");


            Navigation.NavigateTo("/visitemediche", forceLoad: true);

        }
        else
        {
            logger.LogWarning("Nessun lavoratore selezionato.");
        }
    }

    private void Cancel() => MudDialog.Cancel();

    public class Lavoratore
    {
        public string cr4f9_calcolonomeecognome { get; set; }
        public string cr4f9_contattoprvid { get; set; }
    }

    public class LavoratoreCollection
    {
        public Lavoratore[] value { get; set; }
    }

    public class LavoratorePresso
    {
        public string new_lavoratore { get; set; }
        public string new_azienda { get; set; }
        public string cr4f9_mansione { get; set; }
        public string new_lavorapressoprvid { get; set; }
    }

    public class Mansione
    {
        public string cr4f9_mansione { get; set; }
    }

    public class FattoreDiRischio
    {
        public string cr4f9_fattoredirischio { get; set; }
        public string cr4f9_fattoredirischioid { get; set; }
    }

    public class Accertamenti
    {
        public string cr4f9_accertamentoid { get; set; }
        public string cr4f9_accertamento { get; set; }
        public int cr4f9_periodicitaunder50 { get; set; }

    }

    public class VisitaMedica
    {
        public string Lavoratore { get; set; }
        public int? TipologiaVisita { get; set; }
        public string Accertamenti { get; set; }
        public string Periodicita { get; set; }
        public int DurataVisita { get; set; }
        public DateTime DataVisita { get; set; }
        public DateTime DataProssimaVisita { get; set; }
        public int? EsitoVisita { get; set; }
        public string NoteMedico { get; set; }
        public string SedeVisita { get; set; }
    }



}

<style>
    .custom-dialog-red-gray {
        padding: 16px;
        border-radius: 8px;
        background-color: #f2f2f2; /* Grigio chiaro */
        width: 100vw; /* Larghezza del 90% della viewport */
        height: 100vh; /* Altezza del 90% della viewport */
        max-width: none; /* Disabilita il limite massimo della larghezza predefinita */
        max-height: none; /* Disabilita il limite massimo dell'altezza predefinita */
        display: flex; /* Garantisce un comportamento flessibile */
        flex-direction: column; /* Imposta il layout a colonna */
    }

    .content-area-red-gray {
        margin: 16px 0;
        padding: 16px;
        background-color: #ffffff; /* Bianco */
        border: 1px solid #e0e0e0; /* Bordo grigio */
        border-radius: 4px;
        flex-grow: 1; /* Permette alla sezione del contenuto di espandersi */
        overflow-y: auto; /* Abilita lo scorrimento verticale se necessario */
    }

    .mud-dialog-actions {
        justify-content: center; /* Centra i bottoni */
    }

    .mud-button {
        margin: 0 8px; /* Spaziatura tra i bottoni */
    }
    
</style>
