@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using MudBlazor
@using System.Text
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<AddVisitaMedica> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject NavigationManager Navigation

<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true" Class="custom-dialog-red-gray">
    <TitleContent>
        <MudStack Direction="Row" Align="Center" JustifyContent="Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Color="Color.Error" />
            <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Error">
                Inserisci nuova visita medica
            </MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudPaper Class="content-area-red-gray" Elevation="1">
            <!-- Selettore Lavoratori -->
            <MudSelect Variant="Variant.Outlined" T="string" Label="Lavoratore" MultiSelection="false">
                @foreach (var lavoratore in lavoratori.value)
                {
                    <MudSelectItem Value="@lavoratore.cr4f9_calcolonomeecognome">
                        @lavoratore.cr4f9_calcolonomeecognome
                    </MudSelectItem>
                }
            </MudSelect>

            <MudSelect Variant="Variant.Outlined" T="string" Label="Tipologia visita" MultiSelection="false">
                <MudSelectItem T="string">Preassuntiva</MudSelectItem>
                <MudSelectItem T="string">Periodica</MudSelectItem>
                <MudSelectItem T="string">Su richiesta</MudSelectItem>
                <MudSelectItem T="string">Rientro da malattia/infortunio</MudSelectItem>
                <MudSelectItem T="string">Fine rapporto</MudSelectItem>
            </MudSelect>

            <MudTextField T="string"
                          Label="Accertamenti"
                          Variant="Variant.Outlined"
                          Lines="5"
                          Style="background-color: #fff; margin-bottom: 16px; border-radius: 8px;" />

            <!-- Campo numerico per la periodicità del controllo -->
            <MudNumericField Style="margin-top: 16px; background-color: #fff; border-radius: 8px; margin-bottom: 16px;"
                             Label="Periodicità del controllo (mesi)"
                             Variant="Variant.Outlined"
                             Min="0"
                             Max="400"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.CalendarToday" />

            <!-- Campo numerico per la durata del controllo -->
            <MudNumericField Style="margin-top: 16px; background-color: #fff; border-radius: 8px; margin-bottom: 16px;"
                             Label="Durata del controllo (minuti)"
                             Variant="Variant.Outlined"
                             Min="0"
                             Max="400"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Timer" />
            <MudDatePicker Label="Data visita" Orientation="Orientation.Landscape" Color="Color.Error" />
            <MudDatePicker Label="Data prossima visita" Orientation="Orientation.Landscape" Color="Color.Error" />

            <MudSelect Variant="Variant.Outlined" T="string" Label="Esito visita" MultiSelection="false">
                <MudSelectItem T="string">Idoneo</MudSelectItem>
                <MudSelectItem T="string">Idoneo con prescrizioni</MudSelectItem>
                <MudSelectItem T="string">Idoneo con limitazioni</MudSelectItem>
                <MudSelectItem T="string">Non idoneo temporaneamente</MudSelectItem>
                <MudSelectItem T="string">Non idoneo permanentemente</MudSelectItem>
            </MudSelect>

            <MudTextField T="string"
                          Label="Note del medico"
                          Variant="Variant.Outlined"
                          Lines="5"
                          Style="background-color: #fff; margin-bottom: 16px; border-radius: 8px;" />

            <MudTextField T="string"
                          Label="Sede della visita"
                          Variant="Variant.Outlined"
                          Lines="5"
                          Style="background-color: #fff; margin-bottom: 16px; border-radius: 8px;" />

            <MudFileUpload T="IBrowserFile">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.CloudUpload">
                        Carica certificato
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Dark">
            Annulla
        </MudButton>
        <MudButton Color="Color.Error" OnClick="Submit" Variant="Variant.Filled">
            Conferma
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }

    private string message = "Loading...";
    private string userName;
    private string userEmail;
    private string fetchXmlQuery;

    private LavoratoreCollection lavoratori = new LavoratoreCollection { value = Array.Empty<Lavoratore>() };

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); // Chiama il metodo per caricare le informazioni dell'utente

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
        <fetch>
            <entity name='cr4f9_contattoprv'>
                <attribute name='cr4f9_calcolonomeecognome' />
                <link-entity name='new_lavorapressoprv' from='new_lavoratore' to='cr4f9_contattoprvid' alias='lavoraPresso'>
                    <filter>
                        <condition attribute='cr4f9_inforza' operator='eq' value='1' />
                    </filter>
                    <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                        <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                            <filter>
                                <condition attribute='new_email' operator='eq' value='{userEmail}' />
                            </filter>
                        </link-entity>
                    </link-entity>
                </link-entity>
            </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                    // RequestUri = new Uri($"{client.BaseAddress}cr4f9_contattoprvs?$top=100")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                lavoratori = await response.Content.ReadFromJsonAsync<LavoratoreCollection>();
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

    // Metodo per chiudere il dialogo
    private void Submit() => MudDialog.Close(DialogResult.Ok(true));
    private void Cancel() => MudDialog.Cancel();

    public class Lavoratore
    {
        public string cr4f9_calcolonomeecognome { get; set; }
    }

    public class LavoratoreCollection
    {
        public Lavoratore[] value { get; set; }
    }
}

<style>
    .custom-dialog-red-gray {
        padding: 16px;
        border-radius: 8px;
        background-color: #f2f2f2; /* Grigio chiaro */
    }

    .content-area-red-gray {
        margin: 16px 0;
        padding: 16px;
        background-color: #ffffff; /* Bianco */
        border: 1px solid #e0e0e0; /* Bordo grigio */
        border-radius: 4px;
    }

    .mud-dialog-actions {
        justify-content: center; /* Centra i bottoni */
    }

    .mud-button {
        margin: 0 8px; /* Spaziatura tra i bottoni */
    }
</style>
