@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Text.Json
@using MudBlazor
@using Newtonsoft.Json
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory ClientFactory
@inject IAccessTokenProvider TokenProvider
@inject ILogger<AddConsegne> logger

<MudDialog>
    <DialogContent>
        @if (dpiList == null)
        {
            <MudProgressCircular Color="Color.Primary" />
        }
        else
        {
            <MudTable MultiSelection="true" Items="@dpiList" Hover="true" @bind-SelectedItems="selectedItems">
                <HeaderContent>
                    <MudTh>Nome Dispositivo</MudTh>
                    <MudTh>Matricola</MudTh>
                    <MudTh>Taglia</MudTh>
                </HeaderContent>
                <RowTemplate Context="dpi">
                    <MudTd DataLabel="Nome">@dpi.cr4f9_nomedeldispositivofisico</MudTd>
                    <MudTd DataLabel="Matricola">@dpi.cr4f9_matricoladispositivo</MudTd>
                    <MudTd DataLabel="Taglia">@dpi.cr4f9_taglia</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="ConfirmSelection" Disabled="@(selectedItems == null || !selectedItems.Any())">Conferma</MudButton>
        <MudButton Color="Color.Secondary" OnClick="Cancel">Annulla</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public string IdTestata { get; set; }

    [Parameter]
    public string Lavoratore { get; set; }

    [Parameter]
    public DateTime DataConsegna { get; set; }

    [Inject]
    private IDialogService DialogService { get; set; }

    private List<DpiFisico> dpiList;
    private HashSet<DpiFisico> selectedItems = new HashSet<DpiFisico>();

    private string userName;
    private string userEmail;
    private Guid? azienda;
    private string clienteId;
    private string idConsegnaCreata;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation();
        await LoadDpi();
    }

    private async Task LoadDpi()
    {
        var tokenResult = await TokenProvider.RequestAccessToken();

        if (tokenResult.TryGetToken(out var token))
        {
            try
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = $@"
                    <fetch>
                      <entity name='cr4f9_dpifisico'>
                        <attribute name='cr4f9_nomedeldispositivofisico' />
                        <attribute name='cr4f9_matricoladispositivo' />
                        <attribute name='cr4f9_taglia' />
                        <attribute name='cr4f9_dpifisicoid' />
                        <attribute name='cr4f9_duratavitamesi' />
                        <attribute name='createdon' />
                        <attribute name='cr4f9_cliente' />
                        <filter>
                          <condition attribute='cr4f9_cliente' operator='eq' value='{azienda}' />
                        </filter>
                        <link-entity name='cr4f9_tipologiadpiprv' from='cr4f9_tipologiadpiprvid' to='cr4f9_tipologiadpi' link-type='inner' alias='Tipoloiga'>
                          <attribute name='cr4f9_tipologiadpiprvid' alias='cr4f9_tipologiadpi' />
                          <attribute name='cr4f9_periodicitacontrollimesi' alias='cr4f9_periodicitadelcontrollo' />
                        </link-entity>
                      </entity>
                    </fetch>";

                var request = new HttpRequestMessage()
                    {
                        Method = HttpMethod.Get,
                        RequestUri = new Uri($"{client.BaseAddress}cr4f9_dpifisicos?fetchXml={Uri.EscapeDataString(fetchXml)}")
                    };

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
                request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                var response = await client.SendAsync(request);
                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<DpiCollection>();
                    dpiList = result?.value?.ToList() ?? new List<DpiFisico>();
                }
                else
                {
                    logger.LogError($"Errore nel recupero dei DPI: {response.ReasonPhrase}");
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Eccezione durante il recupero dei DPI");
            }
        }
        else
        {
            logger.LogError("Token non ottenuto.");
        }
    }

    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);

            await CaricaClienteAssociato(userEmail);
        }
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private async Task CreaConsegnaDpi (ConsegnaDpi consegnaDpi)
    {
        try
        {

            var dizionario = new Dictionary<string, object>
            {
                {"cr4f9_Clientelookup@odata.bind", $"/cr4f9_clienteprvs({consegnaDpi.Azienda})"},
                {"cr4f9_Lavoratorelookup@odata.bind", $"/cr4f9_contattoprvs({consegnaDpi.Lavoratore})"},
                {"cr4f9_datadiconsegna", consegnaDpi.DataConsegna},
               // {"cr4f9_nomedeldispositivofisico",consegnaDpi.NomeDispositivo},
                {"cr4f9_numerodimatricola", consegnaDpi.Matricola},
                {"cr4f9_DPIfisico@odata.bind", $"/cr4f9_dpifisicos({consegnaDpi.DpiFisico})"},
                {"cr4f9_duratavitamesi", consegnaDpi.Durata},
                {"cr4f9_datadiproduzione",consegnaDpi.DataCreazione},
                {"cr4f9_datafinevita", consegnaDpi.DataFineVita},
                {"cr4f9_periodicitacontrollimesi", consegnaDpi.Periodicità},
                {"cr4f9_dataprossimocontrollo", consegnaDpi.DataProssimoControllo},
                {"cr4f9_taglia", consegnaDpi.Taglia},
                {"cr4f9_RiferimentoTestata@odata.bind", $"/cr4f9_testataconsegnas({consegnaDpi.Testata})"}
            };

            string contenuto = JsonConvert.SerializeObject(dizionario, Formatting.Indented);

            logger.LogInformation($"Contenuto : {contenuto}");

            var tokenResult = await TokenProvider.RequestAccessToken();
            if(tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var request = new HttpRequestMessage(HttpMethod.Post, "cr4f9_associazionedpialavoratores")
                {
                    Content = JsonContent.Create(contenuto)
                };

                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);
                var responseBody = await response.Content.ReadAsStringAsync();

                if(response.IsSuccessStatusCode)
                {
                    if(response.Headers.TryGetValues("OData-EntityId", out var entityIdValues))
                    {
                        var entityId = entityIdValues.FirstOrDefault();

                        if(entityId != null)
                        {
                            idConsegnaCreata = entityId.Split('(').LastOrDefault()?.TrimEnd(')');
                            logger.LogInformation($"Record della consegna creato con successo. ID: {idConsegnaCreata} ");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun ID trovato nell'header della risposta");
                    }
                    consegnaDpi = new();
                }
                else
                {
                    await DialogService.ShowMessageBox("Errore", $"Errore nell'invio: {response.ReasonPhrase}");
                    logger.LogError($"Errore API: {response.StatusCode} - {response.ReasonPhrase}");
                    logger.LogError($"Dettagli risposta: {responseBody}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante la creazione del record.");
            }
        }
        catch(Exception ex)
        {
            logger.LogError($"Errore durante la creazione del record della consegna: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private async Task ConfirmSelection()
    {
        if (selectedItems.Any())
        {
            foreach (var dpi in selectedItems)
            {
                logger.LogInformation($"DPI Selezionato: Nome = {dpi.cr4f9_nomedeldispositivofisico}, Matricola = {dpi.cr4f9_matricoladispositivo}, Taglia = {dpi.cr4f9_taglia}, Dpi = {dpi.cr4f9_dpifisicoid}, Tipologia = {dpi.cr4f9_tipologiadpi}, Durata Vita = {dpi.cr4f9_duratavitamesi}, Data Produzione = {dpi.createdon}, Periodicità = {dpi.cr4f9_periodicitadelcontrollo}");
                var consegna = new ConsegnaDpi
                    {
                        Azienda = clienteId,
                        Lavoratore = Lavoratore,
                        DataConsegna = DataConsegna,
                        //NomeDispositivo = dpi.cr4f9_nomedeldispositivofisico,
                        Matricola = dpi.cr4f9_matricoladispositivo,
                        DpiFisico = dpi.cr4f9_dpifisicoid,
                        Durata = dpi.cr4f9_duratavitamesi,
                        DataCreazione = DataConsegna.AddDays(-1),
                        DataFineVita = DateTime.Today.AddMonths(dpi.cr4f9_duratavitamesi),
                        Periodicità = dpi.cr4f9_periodicitadelcontrollo,
                        DataProssimoControllo = DateTime.Today.AddMonths(dpi.cr4f9_periodicitadelcontrollo).AddDays(1),
                        Taglia = dpi.cr4f9_taglia,
                        Testata = IdTestata
                    };

                await CreaConsegnaDpi(consegna);

                if(!string.IsNullOrEmpty(idConsegnaCreata))
                {
                    await DialogService.ShowMessageBox(
                    "INFO",
                    "Consegne ionserite con successo",
                    yesText: "");
                }
            }
        }
        else
        {
            logger.LogInformation("Nessun DPI selezionato.");
        }

        MudDialog.Close(DialogResult.Ok(selectedItems.ToList()));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    public class DpiFisico
    {
        public string cr4f9_nomedeldispositivofisico { get; set; }
        public string cr4f9_matricoladispositivo { get; set; }
        public string cr4f9_taglia { get; set; }
        public string cr4f9_dpifisicoid { get; set; }
        public int cr4f9_duratavitamesi { get; set; }
        public DateTime? createdon { get; set; }
        public string cr4f9_cliente { get; set; }
        public int cr4f9_periodicitadelcontrollo { get; set; }
        public string cr4f9_tipologiadpi { get; set; }
    }

    public class DpiCollection
    {
        public DpiFisico[] value { get; set; }
    }

    public class ConsegnaDpi
    {
        public string Azienda { get; set; }
        public string Lavoratore { get; set; }
        public DateTime DataConsegna { get; set; }
        //public string NomeDispositivo { get; set; }
        public string Matricola { get; set; }
        public string DpiFisico { get; set; }
        public int Durata { get; set; }
        public DateTime DataCreazione { get; set; }
        public DateTime DataFineVita { get; set; }
        public int Periodicità { get; set; }
        public DateTime DataProssimoControllo { get; set; }
        public string Taglia { get; set; }
        public string Testata { get; set; }
    }
}