@page "/fetchsedi"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider

<AuthorizeView>
    <Authorized>

        <h3>Elenco Sedi</h3>

        @if (sedi != null)
        {
            <div class="folder-container">
                <div class="folder-tab">Elenco Sedi</div>
                <MudTable Items="sedi.value" Dense="true" HeaderClass="mud-table-header" Hover="true">
                    <HeaderContent>
                        <MudTh>Sede</MudTh>
                        <MudTh>Descrizione</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="sede">
                        <MudTd DataLabel="localita">@sede.new_localita</MudTd>
                        <MudTd DataLabel="descrizione">@sede.cr4f9_descrizionesede</MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                    </PagerContent>
                </MudTable>
            </div>

        }
        else
        {
            <p><em>@message</em></p>
        }
    </Authorized>
    <NotAuthorized>
        <h3>Authentication Failure!</h3>
        <p>You're not signed in.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private SedeCollection sedi;
    private string message = "Loading...";

    // Variabili per le informazioni dell'utente autenticato
    private string userName;
    private string userEmail;

    // Definire la query FetchXML, ma senza email statica
    private string fetchXmlQuery;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); // Chiama il metodo per caricare le informazioni dell'utente

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
        <fetch>
            <entity name='new_sedeprv'>
                <attribute name='new_sedeprvid' />
                <attribute name='new_localita' />
                <attribute name='cr4f9_descrizionesede' />
                <link-entity name='new_emailsediprv' from='new_sede' to='new_sedeprvid' alias='emailsedi'>
                    <link-entity name='new_emailautorizzazioniprv' from='new_emailautorizzazioniprvid' to='new_email' alias='emailAuth'>
                        <filter>
                            <condition attribute='new_email' operator='eq' value='{userEmail}' />
                        </filter>
                    </link-entity>
                </link-entity>
            </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}new_sedeprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                sedi = await response.Content.ReadFromJsonAsync<SedeCollection>();
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

    public class Sede
    {
        public Guid new_sedeprvid { get; set; }
        public string new_localita { get; set; }
        public string cr4f9_descrizionesede { get; set; }
    }

    public class SedeCollection
    {
        public Sede[] value { get; set; }
    }
}

<style>
    /* Contenitore a forma di cartella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px; /* Per spostare il contenuto sotto la linguetta */
    }

    /* Linguetta in alto a sinistra */
    .folder-tab {
        position: absolute;
        top: -25px; /* Altezza sopra il contenitore */
        left: 20px; /* Regola la posizione più verso sinistra */
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
    }

    /* Stile per la tabella */
    .mud-table-header {
        background-color: #E53935;
    }

        .mud-table-header .mud-table-cell {
            color: white !important;
        }

    /* Nascondi le informazioni di paginazione */
    .mud-table-pagination-information {
        display: none;
    }

</style>
