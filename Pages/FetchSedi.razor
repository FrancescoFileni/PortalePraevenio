@page "/fetchsedi"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider

<link href="css/fetch-sedi.css" rel="stylesheet" />

<AuthorizeView>
	<Authorized>

		<!-- TOOLBAR -->
		<MudPaper Class="toolbar" Elevation="1">
			<div class="toolbar-left">
				<MudText Typo="Typo.h5" Class="page-title">SEDI</MudText>
			</div>

			<div class="toolbar-right">
				<MudButton Variant="Variant.Outlined"
						   Color="Color.Success"
						   StartIcon="@Icons.Material.Filled.Download"
						   Class="action-btn"
						   OnClick="ExportToExcel">
					Esporta
				</MudButton>


				<MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
							   Color="Color.Error"
							   OnClick="ToggleFilters"
							   Class="filter-btn" />
			</div>
		</MudPaper>

		<!-- FILTRI -->
		<MudCollapse Expanded="@showFilters">
			<MudPaper Class="filters-panel" Elevation="0">
				<MudGrid GutterSize="8">
					<MudItem xs="12" md="6">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Località
						</MudText>
						<MudTextField @bind-Value="searchLocalita"
									  Placeholder="Cerca per località"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="6">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Provincia
						</MudText>
						<MudTextField @bind-Value="searchProvincia"
									  Placeholder="Cerca per provincia"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="6">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Indirizzo
						</MudText>
						<MudTextField @bind-Value="searchIndirizzo"
									  Placeholder="Cerca per indirizzo"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>

					<MudItem xs="12" md="6">
						<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
							Descrizione
						</MudText>
						<MudTextField @bind-Value="searchDescrizione"
									  Placeholder="Cerca per descrizione"
									  Variant="Variant.Outlined"
									  Immediate="true"
									  Class="white-input" />
					</MudItem>
				</MudGrid>

				<div class="mt-4 filters-actions">
					<MudButton Variant="Variant.Outlined"
							   Color="Color.Primary"
							   StartIcon="@Icons.Material.Filled.Refresh"
							   OnClick="ResetFilters">
						Ripristina
					</MudButton>
				</div>
			</MudPaper>
		</MudCollapse>

		@if (sedi != null)
		{
			<div class="folder-container">
				<div class="folder-tab">Elenco Sedi</div>

				<MudTable T="Sede"
						  Items="sedi.value"
						  Dense="true"
						  Hover="true"
						  Filter="FilterFunc"
						  Class="modern-table">

					<HeaderContent>
						<MudTh>Località</MudTh>
						<MudTh>Provincia</MudTh>
						<MudTh>Indirizzo</MudTh>
						<MudTh>Descrizione</MudTh>
					</HeaderContent>

					<RowTemplate Context="sede">
						<MudTd>
							<MudLink Href="@($"/dettagliosede/id={sede.new_sedeprvid}")" Class="name-link">
								@sede.new_localita
							</MudLink>
						</MudTd>

						<MudTd DataLabel="provincia">@sede.cr4f9_provincia</MudTd>
						<MudTd DataLabel="indirizzo">@sede.new_indirizzo</MudTd>
						<MudTd DataLabel="descrizione">@sede.cr4f9_descrizionesede</MudTd>
					</RowTemplate>

					<PagerContent>
						<MudTablePager PageSizeOptions="new int[]{10, 20}" />
					</PagerContent>
				</MudTable>
			</div>
		}
		else
		{
			<p><em>@message</em></p>
		}

	</Authorized>

	<NotAuthorized>
		<h3>Authentication Failure!</h3>
		<p>You're not signed in.</p>
	</NotAuthorized>
</AuthorizeView>

@code {

    private SedeCollection sedi;
    private string message = "Loading...";

    // Variabili per le informazioni dell'utente autenticato
    private string userName;
    private string userEmail;

    // Definire la query FetchXML, ma senza email statica
    private string fetchXmlQuery;

    private string searchLocalita;
    private string searchProvincia;
    private string searchIndirizzo;
    private string searchDescrizione;

    private bool showFilters = false;

    [Inject] IJSRuntime JS { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation(); // Chiama il metodo per caricare le informazioni dell'utente

        // Costruisci dinamicamente la query FetchXML
        fetchXmlQuery = $@"
        <fetch>
            <entity name='new_sedeprv'>
                <attribute name='new_sedeprvid' />
                <attribute name='new_localita' />
                <attribute name='cr4f9_descrizionesede' />
                <attribute name='cr4f9_provincia' />
                <attribute name='new_indirizzo' />
                <link-entity name='new_emailsediprv' from='new_sede' to='new_sedeprvid' alias='emailsedi'>
                    <link-entity name='new_emailautorizzazioniprv' from='new_emailautorizzazioniprvid' to='new_email' alias='emailAuth'>
                        <filter>
                            <condition attribute='new_email' operator='eq' value='{userEmail}' />
                        </filter>
                    </link-entity>
                </link-entity>
            </entity>
        </fetch>";

        var tokenResult = await TokenProvider.RequestAccessToken();
        if (tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var request = new HttpRequestMessage()
                {
                    Method = HttpMethod.Get,
                    RequestUri = new Uri($"{client.BaseAddress}new_sedeprvs?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
                };

            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                sedi = await response.Content.ReadFromJsonAsync<SedeCollection>();
				if (sedi == null || sedi.value.Length == 0)
				{
					message = "Nessuna sede trovata.";
					logger.LogError("No sedi found for the user.");
				}
				else
				{
					message = string.Empty;
					logger.LogInformation($"Fetched {sedi.value.Length} sedi.");
				}
            }
            else
            {
                message = "An error occurred.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    // Metodo per caricare le informazioni sull'utente
    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

    private bool FilterFunc(Sede sede)
    {
        if (!string.IsNullOrWhiteSpace(searchLocalita))
        {
            var searchLower = searchLocalita.ToLower();
            var loc = sede.new_localita ?? string.Empty;
            if (!loc.ToLower().Contains(searchLower))
                return false;
        }

        if (!string.IsNullOrWhiteSpace(searchProvincia))
        {
            var searchLower = searchProvincia.ToLower();
            var prov = sede.cr4f9_provincia ?? string.Empty;
            if (!prov.ToLower().Contains(searchLower))
                return false;
        }

        if (!string.IsNullOrWhiteSpace(searchIndirizzo))
        {
            var searchLower = searchIndirizzo.ToLower();
            var addr = sede.new_indirizzo ?? string.Empty;
            if (!addr.ToLower().Contains(searchLower))
                return false;
        }

        if (!string.IsNullOrWhiteSpace(searchDescrizione))
        {
            var searchLower = searchDescrizione.ToLower();
            var desc = sede.cr4f9_descrizionesede ?? string.Empty;
            if (!desc.ToLower().Contains(searchLower))
                return false;
        }

        return true;
    }


    private void ResetFilters()
    {
        searchLocalita = string.Empty;
        searchProvincia = string.Empty;
        searchIndirizzo = string.Empty;
        searchDescrizione = string.Empty;
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private async Task ExportToExcel()
    {
        if (sedi == null || sedi.value.Length == 0)
        {
            message = "Nessun dato da esportare.";
            return;
        }

        var filteredData = sedi.value.Where(FilterFunc).Select(s => new
        {
            Localita = s.new_localita,
            Provincia = s.cr4f9_provincia,
            Indirizzo = s.new_indirizzo,
            Descrizione = s.cr4f9_descrizionesede
        });

        await JS.InvokeVoidAsync("downloadExcelFromBlazor", "Sedi.xlsx", filteredData);
    }

    public class Sede
    {
        public Guid new_sedeprvid { get; set; }
        public string new_localita { get; set; }
        public string cr4f9_descrizionesede { get; set; }
        public string cr4f9_provincia { get; set; }
        public string new_indirizzo { get; set; }
    }

    public class SedeCollection
    {
        public Sede[] value { get; set; }
    }
}

