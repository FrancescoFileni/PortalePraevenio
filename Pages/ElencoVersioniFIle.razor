@page "/elencoversionifile/id={IdFile}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using ClosedXML.Excel
@using System.Text
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>

        <button @onclick="GoBack">
            <i class="fas fa-arrow-left" style="font-size: 24px; color: white;"></i>
        </button>

        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Style="color:#E53935; margin-left: 16px;" @onclick="OpenDialogAsync">Nuova Versione File</MudButton>

        @if(fileVersions != null)
        {
            <div class="folder-container">
                <div class="folder-tab">Versioni File</div>
                <MudTable Items="fileVersions.value" Dense="true" HeaderClass="mud-table-header" Hover="true">
                    <HeaderContent>
                        <MudTh>Versione File</MudTh>
                        <MudTh>Data Creazione</MudTh>
                        <MudTh>Data Scadenza</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="versione">
                        <MudTd>
                            <a href="javascript:void(0)" @onclick="() => DownloadFile(versione)" style="text-decoration: underline; color: blue">
                                @versione.cr4f9_versionname
                            </a> 
                        </MudTd>
                        <MudTd>@versione.createdon.ToString("dd/MM/yyyy")</MudTd>
                        <MudTd>@versione.cr4f9_datascadenza.ToString("dd/MM/yyyy")</MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 20}" />
                    </PagerContent>
                </MudTable>
            </div>
        }
        else
        {
            <p><em>@message</em></p>
        }
    </Authorized>
</AuthorizeView>

@code {
    [Parameter]
    public string IdFile { get; set; }

    private string userName;
    private string userEmail;
    private string message = "Loading...";
    private string clienteId;
    private Guid? azienda;
    private FileVersionCollection fileVersions;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInformation();
    }

    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;

            logger.LogInformation("USER EMAIL: " + userEmail);

            await CaricaClienteAssociato(userEmail);
            await CaricaVersioniFile(IdFile);
        }
    }

    private async Task CaricaClienteAssociato(string email)
    {
        try
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if (tokenResult.TryGetToken(out var token))
            {
                var client = ClientFactory.CreateClient("DataverseClient");

                var fetchXml = BuildAziendaFetchXml(email);

                var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
                request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    var responseBody = await response.Content.ReadAsStringAsync();

                    var jsonDocument = System.Text.Json.JsonDocument.Parse(responseBody);
                    var entities = jsonDocument.RootElement.GetProperty("value");

                    logger.LogInformation("FETCH: " + fetchXml);

                    if (entities.GetArrayLength() > 0)
                    {
                        var entity = entities[0];

                        string entitiesJson = System.Text.Json.JsonSerializer.Serialize(entity, new System.Text.Json.JsonSerializerOptions
                            {
                                WriteIndented = true // Per una visualizzazione leggibile
                            });
                        logger.LogInformation($"Entities JSON: {entitiesJson}");

                        if (entity.TryGetProperty("_new_cliente_value", out var newClienteProperty))
                        {
                            clienteId = newClienteProperty.GetString();
                            azienda = newClienteProperty.GetGuid();

                            logger.LogInformation($"Entities reference: {clienteId}");
                            logger.LogInformation($"Azienda reference: {azienda}");


                            if (Guid.TryParse(clienteId, out var newClienteGuid))
                            {
                                // lavoratore.cr4f9_aziendanome = newClienteGuid;
                                // logger.LogInformation($"Cliente trovato: {lavoratore.cr4f9_aziendanome}");
                            }
                            else
                            {
                                logger.LogError($"Il valore di 'new_cliente' non è un GUID valido: {clienteId}");
                            }
                        }
                        else
                        {
                            logger.LogWarning("Il campo 'new_cliente' non è presente nel record.");
                        }
                    }
                    else
                    {
                        logger.LogWarning("Nessun record trovato per l'email fornita.");
                    }
                }
                else
                {
                    logger.LogError($"Errore durante il recupero del cliente: {response.ReasonPhrase}");
                }
            }
            else
            {
                logger.LogError("Errore di autenticazione durante il caricamento del cliente.");
            }
        }
        catch (Exception ex)
        {
            logger.LogError($"Eccezione durante il caricamento del cliente: {ex.Message}");
        }
    }

    private string BuildAziendaFetchXml(string email)
    {
        return $@"
        <fetch>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_cliente' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";
    }

    private async Task CaricaVersioniFile(string FileId)
    {
        var tokenResult = await TokenProvider.RequestAccessToken();

        if(tokenResult.TryGetToken(out var token))
        {
            var client = ClientFactory.CreateClient("DataverseClient");

            var fetchXml = $@"
                            <fetch>
                              <entity name='cr4f9_versionefile'>
                                <attribute name='cr4f9_versionefileid' />
                                <attribute name='cr4f9_versionname' />
                                <attribute name='createdon' />
                                <attribute name='cr4f9_datascadenza' />
                                <attribute name='cr4f9_file' />
                                <filter>
                                  <condition attribute='cr4f9_riferimentofile' operator='eq' value='{FileId}' />
                                </filter>
                              </entity>
                            </fetch>";

            var request = new HttpRequestMessage(HttpMethod.Get, $"{client.BaseAddress}cr4f9_versionefiles?fetchXml={Uri.EscapeDataString(fetchXml)}");
            request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

            var response = await client.SendAsync(request);
            if(response.IsSuccessStatusCode)
            {
                fileVersions = await response.Content.ReadFromJsonAsync<FileVersionCollection>();
            }
            else
            {
                message = "An error occurred while fetching data.";
                logger.LogError($"Error fetching data: {response.ReasonPhrase}");
            }
        }
        else
        {
            message = "There was a problem authenticating.";
        }
    }

    private async Task DownloadFile(FIleVersion fileVersion)
    {
        logger.LogInformation($"Download della versione file con ID: {fileVersion.cr4f9_versionefileid}");

        byte[] fileBytes = null;

        if(fileVersion.cr4f9_file.StartsWith("http", StringComparison.OrdinalIgnoreCase))
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if(!tokenResult.TryGetToken(out var token))
            {
                logger.LogError("Token non ottenuto per il download del file.");
                return;
            }

            var client = ClientFactory.CreateClient("DataverseClient");
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
            var response = await client.GetAsync(fileVersion.cr4f9_file);
            if(response.IsSuccessStatusCode)
            {
                fileBytes = await response.Content.ReadAsByteArrayAsync();
            }
            else
            {
                logger.LogError($"Errore nel download del file: {response.ReasonPhrase}");
                return;
            }
        }
        else if (fileVersion.cr4f9_file.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
        {
            var parts = fileVersion.cr4f9_file.Split("base64,");
            if(parts.Length == 2)
            {
                try
                {
                    fileBytes = Convert.FromBase64String(parts[1]);
                }
                catch (Exception ex)
                {
                    logger.LogError($"Errore nella decodifica Base64: {ex.Message}");
                    return;
                }
            }
            else
            {
                logger.LogError("Formato data URI non valido.");
                return;
            }
        }
        else
        {
            var tokenResult = await TokenProvider.RequestAccessToken();
            if(!tokenResult.TryGetToken(out var token))
            {
                logger.LogError("Token non ottenuto per il download della versione file.");
                return;
            }
            var client = ClientFactory.CreateClient("DataverseClient");
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

            var downloadUrl = $"{client.BaseAddress}cr4f9_versionefiles({fileVersion.cr4f9_versionefileid})/cr4f9_file/$value";
            var response = await client.GetAsync(downloadUrl);
            if (response.IsSuccessStatusCode)
            {
                fileBytes = await response.Content.ReadAsByteArrayAsync();
            }
            else
            {
                logger.LogError($"Errore nel download del file: {response.ReasonPhrase}");
                return;
            }
        }

        if (fileBytes == null || fileBytes.Length == 0)
        {
            logger.LogError("File vuoto o non recuperato correttamente.");
            return;
        }

        string mimeType = GetMimeTypeFromBytes(fileBytes);
        string extension = GetExtensionFromMimeType(mimeType);
        string fileName;
        if (!string.IsNullOrWhiteSpace(fileVersion.cr4f9_versionname))
        {
            fileName = fileVersion.cr4f9_versionname + extension;
        }
        else
        {
            fileName = $"downloadedFile{extension}";
        }

        string base64 = Convert.ToBase64String(fileBytes);
        await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", base64, mimeType, fileName);
    }

    private string GetMimeTypeFromBytes(byte[] fileBytes)
    {
        if (fileBytes.Length >= 4)
        {
            var header = BitConverter.ToString(fileBytes.Take(4).ToArray());
            switch (header)
            {
                case "50-4B-03-04": // ZIP header (usato da .docx, .xlsx, .pptx)
                    return DetectOfficeFileType(fileBytes);
                case "D0-CF-11-E0": // Vecchi formati Microsoft Office
                    return "application/msword"; // Potrebbe essere Word, Excel o PowerPoint
                case "25-50-44-46": // PDF: %PDF
                    return "application/pdf";
                case "89-50-4E-47": // PNG file header
                    return "image/png";
            }
        }
        return "application/octet-stream";
    }

    private string DetectOfficeFileType(byte[] fileBytes)
    {
        string content = Encoding.ASCII.GetString(fileBytes);
        if (content.Contains("[Content_Types].xml"))
        {
            if (content.Contains("word/"))
                return "application/vnd.openxmlformats-officedocument.wordprocessingml.document"; // .docx
            if (content.Contains("xl/"))
                return "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"; // .xlsx
            if (content.Contains("ppt/"))
                return "application/vnd.openxmlformats-officedocument.presentationml.presentation"; // .pptx
        }
        return "application/zip";
    }

    private string GetExtensionFromMimeType(string mimeType)
    {
        return mimeType switch
        {
            "application/pdf" => ".pdf",
            "image/png" => ".png",
            "image/jpeg" => ".jpg",
            "image/gif" => ".gif",
            "text/plain" => ".txt",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document" => ".docx",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" => ".xlsx",
            "application/vnd.openxmlformats-officedocument.presentationml.presentation" => ".pptx",
            "application/msword" => ".doc",
            "application/vnd.ms-excel" => ".xls",
            "application/vnd.ms-powerpoint" => ".ppt",
            _ => ".bin"
        };
    }

    private async Task OpenDialogAsync()
    {
        var parameters = new DialogParameters
        {
            {"IdFile", IdFile}
        };

        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = DialogService.Show<AddNuovaVersioneFile>("Nuova versoine File", parameters, options);
        var result = await dialog.Result;
    }

    private void GoBack()
    {
        // Torna indietro nella cronologia
        Navigation.NavigateTo("javascript:history.back()");
    }

    public class FIleVersion
    {
        public Guid? cr4f9_versionefileid { get; set; }
        public string cr4f9_versionname { get; set; }
        public DateTime createdon { get; set; }
        public DateTime cr4f9_datascadenza { get; set; }
        public string cr4f9_file { get; set; }
    }

    public class FileVersionCollection
    {
        public FIleVersion[] value { get; set; }
    }
}

<style>

    /* Contenitore a forma di cartella */
    .folder-container {
        position: relative;
        background-color: #f0f0f0;
        border: 2px solid #E53935;
        border-radius: 8px;
        padding: 16px;
        margin-top: 50px; /* Per spostare il contenuto sotto la linguetta */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Ombra per un effetto elevato */
        margin-bottom: 100px;
    }

    /* Linguetta in alto a sinistra */
    .folder-tab {
        position: absolute;
        top: -25px; /* Altezza sopra il contenitore */
        left: 20px; /* Regola la posizione più verso sinistra */
        background-color: #E53935;
        color: white;
        padding: 6px 16px;
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
        font-weight: bold;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Ombra della linguetta */
    }

    /* Stile per la sezione aggiuntiva */
    .folder-section {
        margin-top: 16px;
        padding-top: 8px;
        border-top: 1px solid #ccc; /* Separatore tra le sezioni */
    }

    /* Stile per le informazioni del corso */
    .course-info {
        font-size: 1rem;
        color: #333;
        margin-bottom: 12px;
    }

    /* Pulsante di azione */
    button {
        font-size: 1rem;
        background-color: #E53935; /* Stesso colore della linguetta */
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover {
        background-color: #D32F2F; /* Colore più scuro al passaggio del mouse */
    }

    /* Contenitore delle informazioni del corso */
    .course-info {
        display: flex;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 12px 0;
        padding: 8px;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Stile generale per lo stato */
    .course-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Stile per stato positivo */
    .course-status.success {
        color: #2e7d32; /* Verde scuro */
        background-color: #e8f5e9; /* Verde chiaro */
        border-left: 4px solid #2e7d32;
        padding-left: 12px;
    }

    /* Stile per stato negativo */
    .course-status.failure {
        color: #d32f2f; /* Rosso scuro */
        background-color: #ffebee; /* Rosso chiaro */
        border-left: 4px solid #d32f2f;
        padding-left: 12px;
    }

    /* Icone */
    .course-status .mud-icon {
        font-size: 1.5rem;
    }

    .mud-tab-slider {
        position: absolute;
        background: #A9A9A9;
    }

    .mud-tab.mud-tab-active {
        color: currentColor;
    }

    /* Tabella intestazione */
    .mud-table-header {
        background-color: #E53935;
    }

    .mud-table-header .mud-table-cell {
        color: white !important;
        font-weight: bold; /* Grassetto per l'intestazione */
    }

    /* Righe della tabella */
    .mud-table-row {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le righe */
    }

    /* Celle della tabella (MudTd) */
    .mud-table .mud-td, .mud-table .mud-th {
        border-bottom: 1px solid #e0e0e0; /* Bordo tra le celle */
        padding: 8px; /* Padding per le celle */
        vertical-align: middle; /* Allinea verticalmente il contenuto */
        text-align: center; /* Centra il testo */
    }

    /* Colore dei link nella tabella */
    .mud-table .mud-link.mud-typography.mud-primary-text {
        font-size: 0.875rem;
        color: #757575 !important;
        font-weight: bold;
        display: block;
        text-align: center;
    }

    /* Hover sui link */
    .mud-table .mud-link.mud-typography.mud-primary-text:hover {
        color: red !important;
        cursor: pointer;
    }

    .color-legend .legend-item {
        width: 16px;
        height: 16px;
        border: 1px solid #888;
        margin-right: 4px;
    }

    .bg-red-light {
        background-color: #ffcccc;
    }

    .bg-orange-light {
        background-color: #ffe5b4;
    }

    .bg-yellow-light {
        background-color: #ffffcc;
    }

    .bg-green-light {
        background-color: #e0e0e0;
    }

    /* Colori leggermente più saturi ma tenui */
    .bg-green-light {
        background-color: #e0e0e0;
    }
    /* verde tenue leggermente più visibile */
    .bg-yellow-light {
        background-color: #ffffcc;
    }
    /* giallo pastello più saturo */
    .bg-orange-light {
        background-color: #ffe5b4;
    }
    /* arancione pastello più saturo */
    .bg-red-light {
        background-color: #ffcccc; /* rosso pastello */
    }

    .color-legend {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
        font-size: 0.9rem;
    }
</style>
