@page "/visitemediche"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using System.Text.Json.Serialization
@using System.Text.Json
@inject IAccessTokenProvider TokenProvider
@inject IHttpClientFactory ClientFactory
@inject ILogger<FetchSedi> logger
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IJSRuntime JS

<link href="css/visite-mediche.css?v=1" rel="stylesheet" />

<AuthorizeView>
	<Authorized>
		@if (accessoNegato)
		{
			<MudAlert Severity="Severity.Error" Variant="Variant.Filled" Color="Color.Error">
				@message
			</MudAlert>
		}
		else
		{
			<MudPaper Class="toolbar" Elevation="1">
				<div class="toolbar-left">
					<MudText Typo="Typo.h5" Class="page-title">VISITE MEDICHE</MudText>
				</div>

				<div class="toolbar-right">
					<MudButton Variant="Variant.Filled"
							   StartIcon="@Icons.Material.Filled.Add"
							   Color="Color.Error"
							   Class="action-btn"
							   OnClick="OpenDialogAsync">
						Nuova
					</MudButton>

					<MudButton Variant="Variant.Outlined"
							   StartIcon="@Icons.Material.Filled.FileDownload"
							   Color="Color.Success"
							   Class="action-btn"
							   OnClick="ExportToExcel">
						Esporta
					</MudButton>

					<MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
								   Color="Color.Error"
								   OnClick="ToggleFilters"
								   Class="filter-btn" />
				</div>
			</MudPaper>


			<MudCollapse Expanded="@showFilters">
				<MudPaper Class="filters-panel" Elevation="0">
					<MudGrid GutterSize="8">
						<MudItem xs="12" md="4">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Nome o Cognome
							</MudText>
							<MudTextField @bind-Value="searchRiepilogo"
										  Placeholder="Cerca per nome o cognome"
										  Variant="Variant.Outlined"
										  Immediate="true"
										  Class="white-input" />
						</MudItem>

						<MudItem xs="12" md="4">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Data Visita
							</MudText>
							<MudGrid GutterSize="4">
								<MudItem xs="6">
									<MudDatePicker @bind-Date="dataVisitaFrom"
												   Label="Da"
												   Variant="Variant.Outlined"
												   Class="white-input"
												   Clearable="true" />
								</MudItem>
								<MudItem xs="6">
									<MudDatePicker @bind-Date="dataVisitaTo"
												   Label="A"
												   Variant="Variant.Outlined"
												   Class="white-input"
												   Clearable="true" />
								</MudItem>
							</MudGrid>
						</MudItem>

						<MudItem xs="12" md="4">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Prossima Visita
							</MudText>
							<MudGrid GutterSize="4">
								<MudItem xs="6">
									<MudDatePicker @bind-Date="prossimaVisitaFrom"
												   Label="Da"
												   Variant="Variant.Outlined"
												   Class="white-input"
												   Clearable="true" />
								</MudItem>
								<MudItem xs="6">
									<MudDatePicker @bind-Date="prossimaVisitaTo"
												   Label="A"
												   Variant="Variant.Outlined"
												   Class="white-input"
												   Clearable="true" />
								</MudItem>
							</MudGrid>
						</MudItem>

						<MudItem xs="12">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Note del Medico
							</MudText>
							<MudTextField @bind-Value="searchNotaMedico"
										  Placeholder="Cerca per nota"
										  Variant="Variant.Outlined"
										  Immediate="true"
										  Class="white-input" />
						</MudItem>

						<MudItem xs="12" md="6">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Tipologia Visita
							</MudText>
							<MudSelect T="string" @bind-Value="selectedTipologia"
									   Variant="Variant.Outlined"
									   Class="white-input">
								<MudSelectItem Value="@("all")">Tutti</MudSelectItem>
								<MudSelectItem Value="@("Preassuntiva")">Preassuntiva</MudSelectItem>
								<MudSelectItem Value="@("Periodica")">Periodica</MudSelectItem>
								<MudSelectItem Value="@("Su richiesta")">Su richiesta</MudSelectItem>
								<MudSelectItem Value="@("Rientro da malattia/infortunio")">Rientro</MudSelectItem>
								<MudSelectItem Value="@("Fine rapporto")">Fine</MudSelectItem>
							</MudSelect>
						</MudItem>

						<MudItem xs="12" md="6">
							<MudText Typo="Typo.subtitle2" Class="mb-1" Style="color: var(--primary-red);">
								Esito Visita
							</MudText>
							<MudSelect T="string" @bind-Value="selectedEsito"
									   Variant="Variant.Outlined"
									   Class="white-input">
								<MudSelectItem Value="@("all")">Tutti</MudSelectItem>
								<MudSelectItem Value="@("Idoneo")">Idoneo</MudSelectItem>
								<MudSelectItem Value="@("Idoneo con prescrizioni")">Idoneo con prescrizioni</MudSelectItem>
								<MudSelectItem Value="@("Idoneo con limitazioni")">Idoneo con limitazioni</MudSelectItem>
								<MudSelectItem Value="@("Non idoneo temporaneamente")">Non idoneo temporaneamente</MudSelectItem>
								<MudSelectItem Value="@("Non idoneo permanentemente")">Non idoneo permanentemente</MudSelectItem>
							</MudSelect>
						</MudItem>
					</MudGrid>

					<div class="mt-4 filters-actions">
						<MudButton Variant="Variant.Outlined"
								   Color="Color.Primary"
								   StartIcon="@Icons.Material.Filled.Refresh"
								   OnClick="ResetFilters">
							Ripristina
						</MudButton>
					</div>
				</MudPaper>
			</MudCollapse>


			@if (visite != null)
			{
				<div class="folder-container">
					<div class="folder-tab">Elenco Visite Mediche</div>
					<MudTable T="Visita"
							  Items="visite.value"
							  Dense="true"
							  Hover="true"
							  Filter="FilterFunc"
							  Class="modern-table">

						<HeaderContent>
							<MudTh>Riepilogo visita</MudTh>
							<MudTh>Data visita</MudTh>
							<MudTh>Data prossima visita</MudTh>
							<MudTh>Tipologia visita</MudTh>
							<MudTh>Esito visita</MudTh>
							<MudTh>Nota del Medico</MudTh>
							<MudTh>Allegato</MudTh>
						</HeaderContent>

						<RowTemplate Context="visitaMedica">

							<!-- ✅ ORA È DENTRO MudTd -->
							<MudTd DataLabel="riepilogo">
								<MudLink Href="@($"/dettagliovisita/id={visitaMedica.cr4f9_visitamedicadellavoratoreid}")"
										 Class="name-link row-truncate">
									@visitaMedica.cr4f9_riepilogovisita
								</MudLink>
							</MudTd>

							<MudTd DataLabel="datavisita">@visitaMedica.checkDate</MudTd>
							<MudTd DataLabel="dataprossimavisita">@visitaMedica.nextCheckDate</MudTd>
							<MudTd DataLabel="tipologiavisita">@visitaMedica.TipologiaDescrizione</MudTd>
							<MudTd DataLabel="esitovisita">@visitaMedica.EsitoDescrizione</MudTd>
							<MudTd DataLabel="notedelmedico">@visitaMedica.cr4f9_notedelmedico</MudTd>

							<MudTd DataLabel="allegato" Align="Align.Center">
								<div class="allegato-cell">
									@if (visitaMedica.HasAllegato)
									{
										<MudIconButton Icon="@Icons.Material.Filled.Attachment"
													   Size="Size.Small"
													   Class="allegato-icon" />
									}
									else
									{
										<span>-</span>
									}
								</div>
							</MudTd>

						</RowTemplate>

						<PagerContent>
							<MudTablePager PageSizeOptions="new int[]{10, 20}" />
						</PagerContent>
					</MudTable>

				</div>
			}
			else
			{
				<MudProgressCircular Color="Color.Default" Indeterminate="true" />
			}
		}
	</Authorized>
	<NotAuthorized>
		<h3>Authentication Failure!</h3>
		<p>You're not signed in.</p>
	</NotAuthorized>
</AuthorizeView>

@code {
    private VisitaCollection visite;
    private string message = "Loading...";

    // Informazioni utente
    private string userName;
    private string userEmail;

    // Query FetchXML
    private string fetchXmlQuery;

    // Variabili per i filtri
    private string searchRiepilogo = "";
    private string searchNotaMedico = "";
    private DateTime? dataVisitaFrom;
    private DateTime? dataVisitaTo;
    private DateTime? prossimaVisitaFrom;
    private DateTime? prossimaVisitaTo;
    private string selectedTipologia = "all";
    private string selectedEsito = "all";
    private bool showFilters = false;

	private bool? autorizzatoLavoratori;
	private bool accessoNegato;


	protected override async Task OnInitializedAsync()
	{
		await LoadUserInformation();

		// 1) Verifica autorizzazione alla visualizzazione dei lavoratori / visite
		autorizzatoLavoratori = await VerificaAutorizzazioneLavoratori(userEmail);

		if (autorizzatoLavoratori != true)
		{
			accessoNegato = true;
			message = "Non sei autorizzato a visualizzare le visite mediche dei lavoratori.";
			logger.LogWarning($"Utente {userEmail} non autorizzato alla visualizzazione delle visite mediche.");
			return;
		}

		// 2) Solo se autorizzato, procedi con il caricamento delle visite
		// Costruisci dinamicamente la query FetchXML
		fetchXmlQuery = $@"
        <fetch distinct='true'>
            <entity name='cr4f9_visitamedicadellavoratore'>
                <link-entity name='cr4f9_contattoprv' from='cr4f9_contattoprvid' to='cr4f9_lavoratore' alias='contatto'>
                    <link-entity name='new_lavorapressoprv' from='new_lavoratore' to='cr4f9_contattoprvid' alias='lavoraPresso'>
                        <link-entity name='cr4f9_clienteprv' from='cr4f9_clienteprvid' to='new_azienda' alias='cliente'>
                            <link-entity name='new_emailautorizzazioniprv' from='new_cliente' to='cr4f9_clienteprvid' alias='emailAuth'>
                                <filter>
                                    <condition attribute='new_email' operator='eq' value='{userEmail}' />
                                </filter>
                            </link-entity>
                        </link-entity>
                    </link-entity>
                </link-entity>
            </entity>
        </fetch>";

		var tokenResult = await TokenProvider.RequestAccessToken();
		if (tokenResult.TryGetToken(out var token))
		{
			var client = ClientFactory.CreateClient("DataverseClient");
			var request = new HttpRequestMessage()
				{
					Method = HttpMethod.Get,
					RequestUri = new Uri($"{client.BaseAddress}cr4f9_visitamedicadellavoratores?fetchXml={Uri.EscapeDataString(fetchXmlQuery)}")
				};
			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);
			request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

			var response = await client.SendAsync(request);
			if (response.IsSuccessStatusCode)
			{
				visite = await response.Content.ReadFromJsonAsync<VisitaCollection>();
				logger.LogInformation($"Visita: {visite.value}");
				logger.LogInformation(JsonSerializer.Serialize(visite.value));
			}
			else
			{
				message = "An error occurred.";
				logger.LogError($"Error fetching data: {response.ReasonPhrase}");
			}
		}
		else
		{
			message = "There was a problem authenticating.";
		}
	}


    private async Task LoadUserInformation()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            userEmail = user.FindFirst(c => c.Type == "preferred_username")?.Value;
            logger.LogInformation("USER EMAIL: " + userEmail);
        }
    }

	private async Task<bool> VerificaAutorizzazioneLavoratori(string email)
	{
		try
		{
			var tokenResult = await TokenProvider.RequestAccessToken();
			if (!tokenResult.TryGetToken(out var token))
			{
				logger.LogError("Errore di autenticazione durante la verifica autorizzazione lavoratori.");
				return false;
			}

			var client = ClientFactory.CreateClient("DataverseClient");

			var fetchXml = $@"
        <fetch top='1'>
          <entity name='new_emailautorizzazioniprv'>
            <attribute name='new_lavoratori' />
            <filter>
              <condition attribute='new_email' operator='eq' value='{email}' />
            </filter>
          </entity>
        </fetch>";

			var request = new HttpRequestMessage(HttpMethod.Get,
				$"{client.BaseAddress}new_emailautorizzazioniprvs?fetchXml={Uri.EscapeDataString(fetchXml)}");
			request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Value);

			var response = await client.SendAsync(request);
			if (!response.IsSuccessStatusCode)
			{
				logger.LogError($"Errore durante la verifica autorizzazione lavoratori: {response.ReasonPhrase}");
				return false;
			}

			var responseBody = await response.Content.ReadAsStringAsync();
			var jsonDocument = JsonDocument.Parse(responseBody);
			var entities = jsonDocument.RootElement.GetProperty("value");

			if (entities.GetArrayLength() == 0)
			{
				logger.LogWarning("Nessun record emailautorizzazioni trovato per l'email fornita.");
				return false;
			}

			var entity = entities[0];

			if (entity.TryGetProperty("new_lavoratori", out var newLavoratoriProperty))
			{
				bool flag = false;

				// Caso classico: booleano JSON
				if (newLavoratoriProperty.ValueKind == JsonValueKind.True ||
					newLavoratoriProperty.ValueKind == JsonValueKind.False)
				{
					flag = newLavoratoriProperty.GetBoolean();
				}
				// In caso arrivasse come stringa "1"/"0" o "true"/"false"
				else if (newLavoratoriProperty.ValueKind == JsonValueKind.String)
				{
					var val = newLavoratoriProperty.GetString();
					flag = val == "1" ||
									string.Equals(val, "true", StringComparison.OrdinalIgnoreCase);
				}

				logger.LogInformation($"Autorizzazione new_lavoratori per {email}: {flag}");
				return flag;
			}

			logger.LogWarning("Il campo 'new_lavoratori' non è presente nel record.");
			return false;
		}
		catch (Exception ex)
		{
			logger.LogError($"Eccezione durante la verifica autorizzazione lavoratori: {ex.Message}");
			return false;
		}
	}


    private Task OpenDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        return DialogService.ShowAsync<AddVisitaMedica>("Simple Dialog", options);
    }

    private async Task ExportToExcel()
    {
        if (visite?.value == null || visite.value.Length == 0)
        {
            message = "Nessun dato da esportare.";
            return;
        }

        var jsonData = visite.value.Where(FilterFunc).Select(v => new
        {
            RiepilogoVisita = v.cr4f9_riepilogovisita,
            DataVisita = v.checkDate,
            ProssimaVisita = v.nextCheckDate,
            Tipologia = v.TipologiaDescrizione,
            Esito = v.EsitoDescrizione
        });

        await JS.InvokeVoidAsync("downloadExcelFromBlazor", "VisiteMediche.xlsx", jsonData);
    }

    private void ToggleFilters() => showFilters = !showFilters;

    private void ResetFilters()
    {
        searchRiepilogo = string.Empty;
        searchNotaMedico = string.Empty;
        dataVisitaFrom = null;
        dataVisitaTo = null;
        prossimaVisitaFrom = null;
        prossimaVisitaTo = null;
        selectedTipologia = "all";
        selectedEsito = "all";
    }

    // Funzione di filtro applicata ad ogni riga della tabella
    private bool FilterFunc(Visita visitaMedica)
    {
        bool matches = true;

        // Filtro per riepilogo visita (nome e cognome)
        if (!string.IsNullOrWhiteSpace(searchRiepilogo))
        {
            matches &= visitaMedica.cr4f9_riepilogovisita != null &&
                       visitaMedica.cr4f9_riepilogovisita.ToLower().Contains(searchRiepilogo.ToLower());
        }

        // Filtro per Data Visita
        if (dataVisitaFrom.HasValue)
        {
            matches &= visitaMedica.cr4f9_datavisita >= dataVisitaFrom.Value;
        }
        if (dataVisitaTo.HasValue)
        {
            matches &= visitaMedica.cr4f9_datavisita <= dataVisitaTo.Value.AddDays(1);
        }

        // Filtro per Data Prossima Visita
        if (prossimaVisitaFrom.HasValue)
        {
            matches &= visitaMedica.cr4f9_dataprossimavisita >= prossimaVisitaFrom.Value;
        }
        if (prossimaVisitaTo.HasValue)
        {
            matches &= visitaMedica.cr4f9_dataprossimavisita <= prossimaVisitaTo.Value.AddDays(1);
        }

        // Filtro per Tipologia Visita
        if (!string.IsNullOrWhiteSpace(selectedTipologia) && selectedTipologia != "all")
        {
            matches &= visitaMedica.TipologiaDescrizione.Equals(selectedTipologia, StringComparison.OrdinalIgnoreCase);
        }

        // Filtro per Esito Visita
        if (!string.IsNullOrWhiteSpace(selectedEsito) && selectedEsito != "all")
        {
            matches &= visitaMedica.EsitoDescrizione.Equals(selectedEsito, StringComparison.OrdinalIgnoreCase);
        }

        if (!string.IsNullOrWhiteSpace(searchNotaMedico))
        {
            matches &= visitaMedica.cr4f9_notedelmedico != null &&
                       visitaMedica.cr4f9_notedelmedico.ToLower().Contains(searchNotaMedico.ToLower());
        }

        return matches;
    }

    public class Visita
    {
        public Guid cr4f9_visitamedicadellavoratoreid { get; set; }
        public string cr4f9_riepilogovisita { get; set; }
        public DateTime cr4f9_datavisita { get; set; }
        public DateTime cr4f9_dataprossimavisita { get; set; }
        public int cr4f9_tipologiadivisita { get; set; }
        public int cr4f9_esitodellavisita { get; set; }
        public string cr4f9_notedelmedico { get; set; }
		public string cr4f9_certificato { get; set; }

        public TipologiaVisita Tipologia
        {
            get => (TipologiaVisita)cr4f9_tipologiadivisita;
            set => cr4f9_tipologiadivisita = (int)value;
        }
        public string TipologiaDescrizione => Tipologia switch
        {
            TipologiaVisita.Preassuntiva => "Preassuntiva",
            TipologiaVisita.Periodica => "Periodica",
            TipologiaVisita.SuRichiesta => "Su richiesta",
            TipologiaVisita.Rientro => "Rientro da malattia/infortunio",
            TipologiaVisita.Fine => "Fine rapporto",
            _ => "Sconosciuto"
        };

        public EsitoVisita Esito
        {
            get => (EsitoVisita)cr4f9_esitodellavisita;
            set => cr4f9_esitodellavisita = (int)value;
        }
        public string EsitoDescrizione => Esito switch
        {
            EsitoVisita.Idoneo => "Idoneo",
            EsitoVisita.IdoneoConPrescrizioni => "Idoneo con prescrizioni",
            EsitoVisita.IdoneoConLimitazioni => "Idoneo con limitazioni",
            EsitoVisita.NonIdoneoTemporanemante => "Non idoneo temporaneamente",
            EsitoVisita.NonIdoneoPermanentemente => "Non idoneo permanentemente",
            _ => "Sconosciuto"
        };

        public string checkDate => cr4f9_datavisita.ToString("dd/MM/yyyy");
        public string nextCheckDate => cr4f9_dataprossimavisita.ToString("dd/MM/yyyy");
        public bool HasAllegato => !string.IsNullOrEmpty(cr4f9_certificato);
    }

    public class VisitaCollection
    {
        public Visita[] value { get; set; }
    }

    public enum TipologiaVisita
    {
        Preassuntiva = 644840000,
        Fine = 644840004,
        Periodica = 644840001,
        SuRichiesta = 644840002,
        Rientro = 644840003
    }

    public enum EsitoVisita
    {
        Idoneo = 644840000,
        IdoneoConPrescrizioni = 644840004,
        IdoneoConLimitazioni = 644840001,
        NonIdoneoTemporanemante = 644840002,
        NonIdoneoPermanentemente = 644840003
    }
}
